*&---------------------------------------------------------------------*
*& Include ZRE_A2R_VALID_TASKLIST_F01
*&---------------------------------------------------------------------*

* We use PLKO, PLPO, PLMK, TAPL, EAPL, CRHD, PLAS according to FDS joins
* (PLKO-PLAS-PLPO-PLMK, PLKO-TAPL, PLKO-EAPL, PLPO-CRHD). [oai_citation:0‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)

*---------------------------------------------------------------------*
* Local event handler for SALV custom buttons
*---------------------------------------------------------------------*
CLASS lcl_event_handler DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS on_user_command
      FOR EVENT added_function OF cl_salv_events_table
        IMPORTING e_salv_function.
ENDCLASS.

CLASS lcl_event_handler IMPLEMENTATION.
  METHOD on_user_command.

    CASE e_salv_function.
      WHEN gc_func_char.          "Toggle characteristics rows
        IF gv_show_char = gc_true.
          gv_show_char = gc_false.
        ELSE.
          gv_show_char = gc_true.
        ENDIF.

      WHEN gc_func_ltxt.          "Toggle long-text rows
        IF gv_show_ltxt = gc_true.
          gv_show_ltxt = gc_false.
        ELSE.
          gv_show_ltxt = gc_true.
        ENDIF.
    ENDCASE.

    "Rebuild display table and refresh ALV
    PERFORM build_display.
    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.
ENDCLASS.

*---------------------------------------------------------------------*
* FORM: VALIDATE_SELECTION
*   - At least one task list type
*   - Key date present (already OBLIGATORY, but double-check)
*---------------------------------------------------------------------*
FORM validate_selection.

  IF p_ftl IS INITIAL
 AND p_etl IS INITIAL
 AND p_gtl IS INITIAL.
    MESSAGE e001(00) WITH 'Select at least one Task List Type (FTL/ETL/GTL)'.
  ENDIF.

  IF so_keydt-low IS INITIAL.
    MESSAGE e001(00) WITH 'Enter a Key Date'.
  ENDIF.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: GET_DATA
*   - Reads PLKO/PLAS/PLPO/PLMK/TAPL/EAPL/CRHD
*   - Applies only background filters in SQL
*   - All user filters are applied later in APPLY_FILTERS
*---------------------------------------------------------------------*
FORM get_data.

  DATA: lt_plnty TYPE RANGE OF plko-plnty,
        ls_plnty LIKE LINE OF lt_plnty.

  CLEAR lt_plnty.

  " Map checkboxes to Task List Types (standard: A=FLOC, B=EQUIP, E=GENERAL)
  IF p_ftl = 'X'.
    ls_plnty-sign   = 'I'.
    ls_plnty-option = 'EQ'.
    ls_plnty-low    = 'A'.
    APPEND ls_plnty TO lt_plnty.
  ENDIF.

  IF p_etl = 'X'.
    ls_plnty-sign   = 'I'.
    ls_plnty-option = 'EQ'.
    ls_plnty-low    = 'B'.
    APPEND ls_plnty TO lt_plnty.
  ENDIF.

  IF p_gtl = 'X'.
    ls_plnty-sign   = 'I'.
    ls_plnty-option = 'EQ'.
    ls_plnty-low    = 'E'.
    APPEND ls_plnty TO lt_plnty.
  ENDIF.

  CLEAR gt_base.

  " Key date – from selection screen (single value)
  DATA(lv_keydat) = so_keydt-low.

  " Core join per FDS 5.3.4.1 [oai_citation:1‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
  SELECT
    a~plnty,
    a~plnnr,
    a~plnal,
    a~datuv,
    a~werks,
    a~ktext,
    a~verwe,
    a~vagrp,
    a~statu      AS stat_h,
    a~anlzu      AS anlzu_h,
    a~strat,
    a~istru      AS istru_h,
    a~adpsp,
    a~slwbez,
    a~loekz      AS loekz_h,
    a~andat,
    a~annam,
    a~aedat,
    a~aenam,

    b~tplnr,
    c~equnr,

    d~vornr,
    d~ltxa1,
    d~steus,
    h~arbpl      AS arbpl_o,
    d~ktsch,
    d~arbei,
    d~arbeh,
    d~dauno,
    d~daune,
    d~kalid,
    d~execution_stage,
    d~anlzu      AS anlzu_o,
    d~istru      AS istru_o,
    d~larnt,
    d~ebeln,
    d~ebelp,
    d~lifnr,
    d~preis,
    d~waers,
    d~sakto,
    d~ekorg,
    d~ekgrp,
    d~txtsp      AS txtsp_op,
    d~loekz      AS loekz_o,

    e~merknr,
    e~verwmerkm,
    e~kurztext   AS kurzt_char,
    e~ltextkz,
    e~toleranzun,
    e~toleranzob,
    e~pruefeinh,
    e~stichprver,
    e~pmethode,
    e~katalgart1,
    e~auswmenge1,
    e~steuerkz,
    e~loekz      AS loekz_c

    INTO TABLE gt_base
    FROM  plko AS a
      INNER JOIN plas AS f
        ON  f~plnty = a~plnty
        AND f~plnnr = a~plnnr
        AND f~plnal = a~plnal
        AND f~loekz = ''               "Assignment not deleted [oai_citation:2‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      INNER JOIN plpo AS d
        ON  d~plnty = f~plnty
        AND d~plnnr = f~plnnr
        AND d~plnkn = f~plnkn
        AND d~zaehl = f~zaehl
        AND d~loekz = ''               "Operation not deleted [oai_citation:3‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      LEFT OUTER JOIN plmk AS e
        ON  e~plnty = d~plnty
        AND e~plnnr = d~plnnr
        AND e~plnkn = d~plnkn
        AND e~zaehl = d~zaehl
        AND e~loekz = ''               "Char. not deleted [oai_citation:4‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      LEFT OUTER JOIN tapl AS b
        ON  b~plnty = a~plnty
        AND b~plnnr = a~plnnr
        AND b~plnal = a~plnal
        AND b~loekz = ''               "TAPL not deleted
      LEFT OUTER JOIN eapl AS c
        ON  c~plnty = a~plnty
        AND c~plnnr = a~plnnr
        AND c~plnal = a~plnal
        AND c~loekz = ''               "EAPL not deleted
      LEFT OUTER JOIN crhd AS h
        ON  h~objid = d~arbid          "Operation WC per FDS join [oai_citation:5‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
        AND h~objty = d~objty
    WHERE a~plnty IN lt_plnty
      AND a~loekz = ''                 "Header not deleted [oai_citation:6‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      AND a~datuv <= lv_keydat.        "From-date <= key date (no VALID_TO used)

  " Apply all selection-screen filters on the in-memory data
  PERFORM apply_filters.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: APPLY_FILTERS
*   - Applies all user selection options to GT_BASE
*---------------------------------------------------------------------*
FORM apply_filters.

  DATA: lt_filtered TYPE STANDARD TABLE OF ty_task_base.

  CLEAR lt_filtered.

  LOOP AT gt_base INTO gs_base.

    "--------------------------------------------------------------*
    " Task List Selection (TPLNR/EQUNR/PLNNR/PLNAL/Key Date)
    "--------------------------------------------------------------*
    IF so_tplnr[] IS NOT INITIAL AND gs_base-tplnr NOT IN so_tplnr.
      CONTINUE.
    ENDIF.

    IF so_equnr[] IS NOT INITIAL AND gs_base-equnr NOT IN so_equnr.
      CONTINUE.
    ENDIF.

    IF so_plnnr[] IS NOT INITIAL AND gs_base-plnnr NOT IN so_plnnr.
      CONTINUE.
    ENDIF.

    IF so_plnal[] IS NOT INITIAL AND gs_base-plnal NOT IN so_plnal.
      CONTINUE.
    ENDIF.

    "Key date: we already checked PLKO-DATUV in SQL.
    "Nothing else here – VALID_TO fields are system-specific.

    "--------------------------------------------------------------*
    " Header Data
    "--------------------------------------------------------------*
    IF so_ktext[] IS NOT INITIAL AND gs_base-ktext NOT IN so_ktext.
      CONTINUE.
    ENDIF.

    IF so_werks[] IS NOT INITIAL AND gs_base-werks NOT IN so_werks.
      CONTINUE.
    ENDIF.

    IF so_vagrp[] IS NOT INITIAL AND gs_base-vagrp NOT IN so_vagrp.
      CONTINUE.
    ENDIF.

    IF so_verwe[] IS NOT INITIAL AND gs_base-verwe NOT IN so_verwe.
      CONTINUE.
    ENDIF.

    IF so_stath[] IS NOT INITIAL AND gs_base-stat_h NOT IN so_stath.
      CONTINUE.
    ENDIF.

    IF so_anlzh[] IS NOT INITIAL AND gs_base-anlzu_h NOT IN so_anlzh.
      CONTINUE.
    ENDIF.

    IF so_strat[] IS NOT INITIAL AND gs_base-strat NOT IN so_strat.
      CONTINUE.
    ENDIF.

    IF so_istrh[] IS NOT INITIAL AND gs_base-istru_h NOT IN so_istrh.
      CONTINUE.
    ENDIF.

    IF so_adpsp[] IS NOT INITIAL AND gs_base-adpsp NOT IN so_adpsp.
      CONTINUE.
    ENDIF.

    IF so_slwbe[] IS NOT INITIAL AND gs_base-slwbez NOT IN so_slwbe.
      CONTINUE.
    ENDIF.

    IF so_andat[] IS NOT INITIAL AND gs_base-andat NOT IN so_andat.
      CONTINUE.
    ENDIF.

    IF so_annam[] IS NOT INITIAL AND gs_base-annam NOT IN so_annam.
      CONTINUE.
    ENDIF.

    IF so_aedat[] IS NOT INITIAL AND gs_base-aedat NOT IN so_aedat.
      CONTINUE.
    ENDIF.

    IF so_aenam[] IS NOT INITIAL AND gs_base-aenam NOT IN so_aenam.
      CONTINUE.
    ENDIF.

    "--------------------------------------------------------------*
    " Operation Data
    "--------------------------------------------------------------*
    IF so_vornr[] IS NOT INITIAL AND gs_base-vornr NOT IN so_vornr.
      CONTINUE.
    ENDIF.

    "Suboperation range is modelled as second range on VORNR
    IF so_uvorn[] IS NOT INITIAL AND gs_base-vornr NOT IN so_uvorn.
      CONTINUE.
    ENDIF.

    IF so_otext[] IS NOT INITIAL AND gs_base-ltxa1 NOT IN so_otext.
      CONTINUE.
    ENDIF.

    IF so_steus[] IS NOT INITIAL AND gs_base-steus NOT IN so_steus.
      CONTINUE.
    ENDIF.

    IF so_arbpo[] IS NOT INITIAL AND gs_base-arbpl_o NOT IN so_arbpo.
      CONTINUE.
    ENDIF.

    "Plant (operation work center) – we only have planning plant at header,
    "FDS filter CRHD-WERKS is system-specific; left out intentionally.

    IF so_optpl[] IS NOT INITIAL AND gs_base-tplnr NOT IN so_optpl.
      CONTINUE.
    ENDIF.

    IF so_opequ[] IS NOT INITIAL AND gs_base-equnr NOT IN so_opequ.
      CONTINUE.
    ENDIF.

    IF so_ktsch[] IS NOT INITIAL AND gs_base-ktsch NOT IN so_ktsch.
      CONTINUE.
    ENDIF.

    IF so_exsta[] IS NOT INITIAL AND gs_base-execution_stage NOT IN so_exsta.
      CONTINUE.
    ENDIF.

    IF so_anlzo[] IS NOT INITIAL AND gs_base-anlzu_o NOT IN so_anlzo.
      CONTINUE.
    ENDIF.

    IF so_istru[] IS NOT INITIAL AND gs_base-istru_o NOT IN so_istru.
      CONTINUE.
    ENDIF.

    IF so_larnt[] IS NOT INITIAL AND gs_base-larnt NOT IN so_larnt.
      CONTINUE.
    ENDIF.

    IF so_ebeln[] IS NOT INITIAL AND gs_base-ebeln NOT IN so_ebeln.
      CONTINUE.
    ENDIF.

    IF so_ebelp[] IS NOT INITIAL AND gs_base-ebelp NOT IN so_ebelp.
      CONTINUE.
    ENDIF.

    IF so_lifnr[] IS NOT INITIAL AND gs_base-lifnr NOT IN so_lifnr.
      CONTINUE.
    ENDIF.

    "Operation long text indicator (PLPO-TXTSP) per FDS 2. Detailed View [oai_citation:7‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
    IF p_oltin = 'X'.
      "Only operations WITH long text indicator
      IF gs_base-txtsp_op IS INITIAL.
        CONTINUE.
      ENDIF.
    ELSE.
      "Only operations WITHOUT long text indicator
      IF gs_base-txtsp_op IS NOT INITIAL.
        CONTINUE.
      ENDIF.
    ENDIF.

    "--------------------------------------------------------------*
    " Characteristic Data
    "--------------------------------------------------------------*
    IF so_merkn[] IS NOT INITIAL AND gs_base-merknr NOT IN so_merkn.
      CONTINUE.
    ENDIF.

    IF so_mic[] IS NOT INITIAL AND gs_base-verwmerkm NOT IN so_mic.
      CONTINUE.
    ENDIF.

    IF so_cktxt[] IS NOT INITIAL AND gs_base-kurzt_char NOT IN so_cktxt.
      CONTINUE.
    ENDIF.

    IF so_ltxtk[] IS NOT INITIAL AND gs_base-ltextkz NOT IN so_ltxtk.
      CONTINUE.
    ENDIF.

    IF so_tolun IS NOT INITIAL AND gs_base-toleranzun <> so_tolun.
      CONTINUE.
    ENDIF.

    IF so_tolob IS NOT INITIAL AND gs_base-toleranzob <> so_tolob.
      CONTINUE.
    ENDIF.

    IF so_meth[] IS NOT INITIAL AND gs_base-pmethode NOT IN so_meth.
      CONTINUE.
    ENDIF.

    IF so_sproc[] IS NOT INITIAL AND gs_base-stichprver NOT IN so_sproc.
      CONTINUE.
    ENDIF.

    "Characteristic long text search (SO_CHLTX) would require READ_TEXT;
    "left for later enhancement – selection parameter is kept for future use.

    APPEND gs_base TO lt_filtered.

  ENDLOOP.

  gt_base = lt_filtered.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: ADD_OPERATION_IF_NEW
*   - Helper when we are NOT showing characteristics
*---------------------------------------------------------------------*
FORM add_operation_if_new
  USING    is_base TYPE ty_task_base.

  DATA: ls_disp TYPE ty_task_disp.

  "Avoid duplicates for same header+operation
  READ TABLE gt_display TRANSPORTING NO FIELDS
       WITH KEY plnty = is_base-plnty
                plnnr = is_base-plnnr
                plnal = is_base-plnal
                vornr = is_base-vornr.

  IF sy-subrc = 0.
    RETURN.
  ENDIF.

  CLEAR ls_disp.
  MOVE-CORRESPONDING is_base TO ls_disp.

  ls_disp-row_kind = 'O'.

  "Blank characteristic fields for pure operation row
  CLEAR: ls_disp-merknr,
         ls_disp-verwmerkm,
         ls_disp-kurzt_char,
         ls_disp-ltextkz,
         ls_disp-toleranzun,
         ls_disp-toleranzob,
         ls_disp-pruefeinh,
         ls_disp-stichprver,
         ls_disp-pmethode,
         ls_disp-katalgart1,
         ls_disp-auswmenge1,
         ls_disp-steuerkz,
         ls_disp-loekz_c,
         ls_disp-tdline,
         ls_disp-tdformat.

  APPEND ls_disp TO gt_display.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: BUILD_DISPLAY
*   - Creates GT_DISPLAY from GT_BASE based on flags
*     GV_SHOW_CHAR / GV_SHOW_LTXT (and P_SHOWC / P_SHOWL initial state)
*---------------------------------------------------------------------*
FORM build_display.

  DATA: lv_show_char TYPE abap_bool,
        lv_show_ltxt TYPE abap_bool,
        lt_lines     TYPE STANDARD TABLE OF tline,
        ls_line      TYPE tline.

  CLEAR gt_display.

  "Effective flags = runtime toggle OR initial checkbox
  lv_show_char = COND #( WHEN gv_show_char = gc_true OR p_showc = 'X'
                         THEN gc_true ELSE gc_false ).
  lv_show_ltxt = COND #( WHEN gv_show_ltxt = gc_true OR p_showl = 'X'
                         THEN gc_true ELSE gc_false ).

  LOOP AT gt_base INTO gs_base.

    IF lv_show_char = gc_true.
      "One row per operation/characteristic (if MERKNR initial, it’s only op)
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = COND #( WHEN gs_base-merknr IS INITIAL
                                    THEN 'O'
                                    ELSE 'C' ).
      APPEND gs_display TO gt_display.

      "Characteristic long text lines when LV_SHOW_LTXT = X and LTEXTKZ = 'X' [oai_citation:8‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      IF lv_show_ltxt = gc_true
         AND gs_base-merknr IS NOT INITIAL
         AND gs_base-ltextkz = 'X'.

        CLEAR lt_lines.
        PERFORM read_char_longtext USING    gs_base
                                   CHANGING lt_lines.

        LOOP AT lt_lines INTO ls_line.
          CLEAR gs_display.
          MOVE-CORRESPONDING gs_base TO gs_display.
          gs_display-row_kind = 'L'.
          gs_display-tdline   = ls_line-tdline.
          gs_display-tdformat = ls_line-tdformat.
          APPEND gs_display TO gt_display.
        ENDLOOP.

      ENDIF.

    ELSE.
      "Show only operations (no characteristic rows)
      PERFORM add_operation_if_new USING gs_base.

      "Operation long text only when LV_SHOW_LTXT = X and TXTSP_OP <> space [oai_citation:9‡TaskList.pdf](file-service://file-C2Smrdjjvn4UvEoSzf3r5t)
      IF lv_show_ltxt = gc_true
         AND gs_base-txtsp_op IS NOT INITIAL.

        CLEAR lt_lines.
        PERFORM read_op_longtext USING    gs_base
                                 CHANGING lt_lines.

        LOOP AT lt_lines INTO ls_line.
          CLEAR gs_display.
          MOVE-CORRESPONDING gs_base TO gs_display.
          gs_display-row_kind = 'L'.
          gs_display-tdline   = ls_line-tdline.
          gs_display-tdformat = ls_line-tdformat.
          APPEND gs_display TO gt_display.
        ENDLOOP.

      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: READ_OP_LONGTEXT
*   - Wraps READ_TEXT for operation level
*   - Key structure follows standard TL operation long-text (adjust if
*     your text object / IDs differ – this is the only place to change)
*---------------------------------------------------------------------*
FORM read_op_longtext
  USING    is_base  TYPE ty_task_base
  CHANGING ct_lines TYPE STANDARD TABLE OF tline.

  DATA: ls_header TYPE thead.

  CLEAR ct_lines.

  "This key is system-specific; adjust OBJECT/ID/NAME if required
  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'LT'
      language = sy-langu
      name     = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-vornr }|
      object   = 'PLPO'
    IMPORTING
      header   = ls_header
    TABLES
      lines    = ct_lines
    EXCEPTIONS
      OTHERS   = 1.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: READ_CHAR_LONGTEXT
*   - Wraps READ_TEXT for characteristic level
*---------------------------------------------------------------------*
FORM read_char_longtext
  USING    is_base  TYPE ty_task_base
  CHANGING ct_lines TYPE STANDARD TABLE OF tline.

  DATA: ls_header TYPE thead.

  CLEAR ct_lines.

  "Again, adjust OBJECT/ID/NAME if required by your system
  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'LT'
      language = sy-langu
      name     = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-merknr }|
      object   = 'PLMK'
    IMPORTING
      header   = ls_header
    TABLES
      lines    = ct_lines
    EXCEPTIONS
      OTHERS   = 1.

ENDFORM.

*---------------------------------------------------------------------*
* FORM: DISPLAY_ALV
*   - Creates SALV on GT_DISPLAY with 2 custom buttons: CHAR / LTXT
*---------------------------------------------------------------------*
FORM display_alv.

  DATA: lx_salv TYPE REF TO cx_salv_msg.

  TRY.
      cl_salv_table=>factory(
        IMPORTING
          r_salv_table = lo_alv
        CHANGING
          t_table      = gt_display ).
    CATCH cx_salv_msg INTO lx_salv.
      MESSAGE lx_salv->get_text( ) TYPE 'E'.
  ENDTRY.

  "Columns
  lo_columns = lo_alv->get_columns( ).
  lo_columns->set_optimize( abap_true ).

  "Striped pattern etc.
  lo_disp = lo_alv->get_display_settings( ).
  lo_disp->set_striped_pattern( abap_true ).

  "Layout
  lo_layout     = lo_alv->get_layout( ).
  ls_layout_key = VALUE #( report = sy-repid ).
  lo_layout->set_key( ls_layout_key ).
  lo_layout->set_save_restriction( if_salv_c_layout=>restrict_none ).

  "Functions + custom buttons
  lo_funcs = lo_alv->get_functions( ).
  lo_funcs->set_all( abap_true ).

  lo_funcs->add_function(
    name     = gc_func_char,
    text     = 'Show Characteristics',
    tooltip  = 'Toggle characteristic rows',
    position = if_salv_c_function_position=>right_of_salv_functions ).

  lo_funcs->add_function(
    name     = gc_func_ltxt,
    text     = 'Show Long Text',
    tooltip  = 'Toggle long-text rows',
    position = if_salv_c_function_position=>right_of_salv_functions ).

  "Event handler for the custom buttons
  lo_events = lo_alv->get_event( ).
  SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

  lo_alv->display( ).

ENDFORM.