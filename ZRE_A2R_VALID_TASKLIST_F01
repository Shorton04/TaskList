FORM build_display.

  DATA lv_last_vornr TYPE vornr.
  DATA lv_row_id     TYPE i VALUE 0.

  gv_row_id = 0.

  CLEAR gt_display.

  SORT gt_base BY plnnr plnal vornr merknr.

  LOOP AT gt_base INTO gs_base.

    "--- OPERATION ROW ---
    IF gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.
      CLEAR gs_display-line_color.

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.
      APPEND gs_display TO gt_display.

      IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

      lv_last_vornr = gs_base-vornr.
    ENDIF.

    "--- CHARACTERISTIC ROW ---
    IF gv_show_char = abap_true AND gs_base-merknr IS NOT INITIAL.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      IF gs_display-row_kind = 'O'.
        gs_display-line_color = '0000'.    " No color

      ELSEIF gs_display-row_kind = 'C'.
        gs_display-line_color = '6100'.    " Green (Characteristic)

      ELSEIF gs_display-row_kind = 'L'.

        " Distinguish Operation LT vs Characteristic LT
        IF gs_display-op_ltxt IS NOT INITIAL.
          gs_display-line_color = '5100'.  " Yellow = Operation LT
        ELSE.
          gs_display-line_color = '3100'.  " Blue = Characteristic LT
        ENDIF.

      ENDIF.

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.
      APPEND gs_display TO gt_display.

      IF gv_show_ltxt = abap_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.

FORM build_display.

  DATA lv_last_vornr TYPE vornr.
  DATA lv_row_id     TYPE i VALUE 0.

  gv_row_id = 0.

  CLEAR gt_display.

  SORT gt_base BY plnnr plnal vornr merknr.

  LOOP AT gt_base INTO gs_base.

    "--- OPERATION ROW ---
    IF gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.
      CLEAR gs_display-line_color.

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.
      APPEND gs_display TO gt_display.

      IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

      lv_last_vornr = gs_base-vornr.
    ENDIF.

    "--- CHARACTERISTIC ROW ---
    IF gv_show_char = abap_true AND gs_base-merknr IS NOT INITIAL.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      IF gs_display-row_kind = 'O'.
        gs_display-line_color = '0000'.    " No color

      ELSEIF gs_display-row_kind = 'C'.
        gs_display-line_color = '6100'.    " Green (Characteristic)

      ELSEIF gs_display-row_kind = 'L'.

        " Distinguish Operation LT vs Characteristic LT
        IF gs_display-op_ltxt IS NOT INITIAL.
          gs_display-line_color = '5100'.  " Yellow = Operation LT
        ELSE.
          gs_display-line_color = '3100'.  " Blue = Characteristic LT
        ENDIF.

      ENDIF.

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.
      APPEND gs_display TO gt_display.

      IF gv_show_ltxt = abap_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.

FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines  TYPE STANDARD TABLE OF tline,
        ls_line   TYPE tline,
        lv_name   TYPE thead-tdname,
        lv_indent TYPE string,
        ls_color  TYPE lvc_s_scol.


  CLEAR: lt_lines, lv_name.

  CONCATENATE sy-mandt
              is_base-plnty
              is_base-plnnr
              is_base-plnkn
              is_base-zaehl
         INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      client   = sy-mandt
      id       = 'PLPO'
      language = sy-langu
      name     = lv_name
      object   = 'ROUTING'
    TABLES
      lines    = lt_lines
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR lt_lines IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT lt_lines INTO ls_line.

    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind = 'L'.
    gs_display-op_ltxt  = ls_line-tdline.
    gs_display-tdformat = ls_line-tdformat.

    CONCATENATE lv_indent gs_display-op_ltxt INTO gs_display-op_ltxt.

    "GREEN color
    gs_display-line_color = '3100'.

    ADD 1 TO gv_row_id.
    gs_display-row_id = gv_row_id.
    APPEND gs_display TO gt_display.

  ENDLOOP.

ENDFORM.


FORM append_char_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines  TYPE STANDARD TABLE OF tline,
        ls_line   TYPE tline,
        lv_name   TYPE thead-tdname,
        lv_tmp    TYPE thead-tdname,
        lv_indent TYPE string,
        lv_merknr TYPE char08,
        ls_color  TYPE lvc_s_scol.

  CLEAR: lt_lines, lv_name, lv_tmp.

  IF is_base-ltextkz IS INITIAL.
    RETURN.
  ENDIF.

  lv_merknr = is_base-merknr.

  CONCATENATE sy-mandt
              is_base-plnty
              is_base-plnnr
              is_base-plnkn
         INTO lv_tmp.

  CONCATENATE lv_tmp is_base-merknr INTO lv_tmp SEPARATED BY space.
  CONCATENATE lv_tmp is_base-zaehl INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      client   = sy-mandt
      id       = 'QM'
      language = sy-langu
      name     = lv_name
      object   = 'QSS'
    TABLES
      lines    = lt_lines
    EXCEPTIONS
      OTHERS   = 8.

  IF sy-subrc <> 0 OR lt_lines IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT lt_lines INTO ls_line.

    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind  = 'L'.
    gs_display-char_ltxt = ls_line-tdline.
    gs_display-tdformat  = ls_line-tdformat.

    CONCATENATE lv_indent gs_display-char_ltxt INTO gs_display-char_ltxt.

    CLEAR gs_display-op_ltxt.

    gs_display-line_color = '5100'.

    ADD 1 TO gv_row_id.
    gs_display-row_id = gv_row_id.
    APPEND gs_display TO gt_display.

  ENDLOOP.

ENDFORM.
