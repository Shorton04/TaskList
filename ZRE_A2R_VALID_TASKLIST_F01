*&---------------------------------------------------------------------*
*& Include ZRE_A2R_VALID_TASKLIST_F01
*&---------------------------------------------------------------------*

*======================================================================*
*  1. SELECTION VALIDATION / DYNPRO ADJUSTMENT
*======================================================================*
FORM validate_selection.

  " At least one task list type
  IF p_ftl IS INITIAL AND p_etl IS INITIAL AND p_gtl IS INITIAL.
    MESSAGE e398(00) WITH 'Select at least one Task List Type'.
  ENDIF.

  " Key date: enforce single value
  IF so_keydt[] IS INITIAL OR lines( so_keydt[] ) <> 1.
    MESSAGE e398(00) WITH 'Key Date must be entered as single value'.
  ENDIF.

ENDFORM.

FORM adjust_dynpro.

  " Simple example: nothing dynamic for now
  " (FDS doesn’t require complex enable/disable on SELECTION-SCREEN)
  " Place logic here if you want to gray out p_showl when p_showc not chosen, etc.

ENDFORM.

*======================================================================*
*  2. DATA SELECTION – BUILD GT_BASE
*======================================================================*
FORM get_data.

  CLEAR gt_base.
  REFRESH gt_base.

  DATA: lv_keydt TYPE plko-datuv.

  READ TABLE so_keydt INDEX 1 TRANSPORTING NO FIELDS.
  IF sy-subrc = 0.
    lv_keydt = so_keydt-low.
  ENDIF.

  "------------- Main SELECT: PLKO + PLPO + PLMK ----------------------
  SELECT
    plko~plnty,
    plko~plnnr,
    plko~plnal,
    plko~datuv,
    plko~werks,
    plko~ktext,
    plko~verwe,
    plko~vagrp,
    plko~statu,
    plko~anlzu,
    plko~strat,
    plko~istru,
    plko~adpsp,
    plko~slwbez,
    plko~loekz,
    plko~andat,
    plko~annam,
    plko~aedat,
    plko~aenam,

    plpo~vornr,
    plpo~uvorn,
    plpo~ltxa1,
    plpo~steus,
    plpo~arbpl,
    plpo~ktsch,
    plpo~execution_stage,
    plpo~anlzu,
    plpo~istru,
    plpo~loekz,
    plpo~txtsp,
    plpo~ebeln,
    plpo~ebelp,
    plpo~lifnr,
    plpo~dauno,
    plpo~daune,
    plpo~arbei,
    plpo~arbeh,

    plmk~merknr,
    plmk~verwmerkm,
    plmk~kurztext,
    plmk~ltextkz,
    plmk~sollwert,
    plmk~toleranzun,
    plmk~toleranzob,
    plmk~msehi,
    plmk~dezanzahl,
    plmk~katalogart1,
    plmk~codegruppe1,
    plmk~auswmnge1,
    plmk~pruefeinh,
    plmk~stichprver,
    plmk~methode,
    plmk~pruefkl,
    plmk~loekz
  FROM plko
    INNER JOIN plpo
       ON plko~plnty = plpo~plnty
      AND plko~plnnr = plpo~plnnr
      AND plko~plnal = plpo~plnal
    LEFT OUTER JOIN plmk
       ON plpo~plnty = plmk~plnty
      AND plpo~plnnr = plmk~plnnr
      AND plpo~plnkn = plmk~plnkn
  INTO TABLE @DATA(lt_raw)
  WHERE plko~datuv <= @lv_keydt
    AND plko~loekz IN @so_loekh
    AND plko~plnnr IN @so_plnnr
    AND plko~plnal IN @so_plnal
    AND plko~ktext IN @so_ktext
    AND plko~werks IN @so_werks
    AND plko~verwe IN @so_verwe
    AND plko~vagrp IN @so_vagrp
    AND plko~statu IN @so_stath
    AND plko~anlzu IN @so_anlzh
    AND plko~strat IN @so_strat
    AND plko~istru IN @so_istrh
    AND plko~adpsp IN @so_adpsp
    AND plko~slwbez IN @so_slwbe
    AND plko~andat IN @so_andat
    AND plko~annam IN @so_annam
    AND plko~aedat IN @so_aedat
    AND plko~aenam IN @so_aenam
    AND plpo~vornr IN @so_vornr
    AND plpo~uvorn IN @so_uvorn
    AND plpo~ltxa1 IN @so_otext
    AND plpo~steus IN @so_steus
    AND plpo~execution_stage IN @so_exsta
    AND plpo~anlzu IN @so_anlzo
    AND plpo~loekz IN @so_loeko
    AND plpo~ebeln IN @so_ebeln
    AND plpo~ebelp IN @so_ebelp
    AND plpo~lifnr IN @so_lifnr
    AND ( @p_opltx IS INITIAL OR plpo~txtsp <> space )
    AND ( plmk~merknr     IN @so_merkn  OR plmk~merknr     IS NULL )
    AND ( plmk~verwmerkm  IN @so_mic    OR plmk~verwmerkm  IS NULL )
    AND ( plmk~kurztext   IN @so_cktxt  OR plmk~kurztext   IS NULL )
    AND ( plmk~ltextkz    IN @so_ltxtk  OR plmk~ltextkz    IS NULL )
    AND ( plmk~sollwert   IN @so_sollw  OR plmk~sollwert   IS NULL )
    AND ( plmk~toleranzun IN @so_tolun  OR plmk~toleranzun IS NULL )
    AND ( plmk~toleranzob IN @so_tolob  OR plmk~toleranzob IS NULL )
    AND ( plmk~msehi      IN @so_msehi  OR plmk~msehi      IS NULL )
    AND ( plmk~dezanzahl  IN @so_dezan  OR plmk~dezanzahl  IS NULL )
    AND ( plmk~katalogart1 IN @so_kat1  OR plmk~katalogart1 IS NULL )
    AND ( plmk~codegruppe1 IN @so_cgrp1 OR plmk~codegruppe1 IS NULL )
    AND ( plmk~pruefeinh   IN @so_pruef OR plmk~pruefeinh   IS NULL )
    AND ( plmk~stichprver  IN @so_sproc OR plmk~stichprver  IS NULL )
    AND ( plmk~methode     IN @so_meth  OR plmk~methode     IS NULL )
    AND ( plmk~pruefkl     IN @so_pkl   OR plmk~pruefkl     IS NULL )
    AND ( plmk~loekz       IN @so_loekc OR plmk~loekz       IS NULL ).

  IF lt_raw IS INITIAL.
    MESSAGE s398(00) WITH 'No data found for entered selection'.
    EXIT.
  ENDIF.

  " Add functional location / equipment / plant from TL assignment
  DATA: lt_tapl TYPE STANDARD TABLE OF tapl,
        lt_eapl TYPE STANDARD TABLE OF eapl.

  " header assignments
  SELECT tplnr, plnty, plnnr, plnal
    FROM tapl
    INTO TABLE @lt_tapl
    FOR ALL ENTRIES IN @lt_raw
    WHERE plnty = @lt_raw-plnty
      AND plnnr = @lt_raw-plnnr
      AND plnal = @lt_raw-plnal
      AND tplnr IN @so_tplnr.

  SELECT equnr, plnty, plnnr, plnal
    FROM eapl
    INTO TABLE @lt_eapl
    FOR ALL ENTRIES IN @lt_raw
    WHERE plnty = @lt_raw-plnty
      AND plnnr = @lt_raw-plnnr
      AND plnal = @lt_raw-plnal
      AND equnr IN @so_equnr.

  SORT lt_tapl BY plnty plnnr plnal.
  SORT lt_eapl BY plnty plnnr plnal.

  CLEAR gt_base.
  LOOP AT lt_raw ASSIGNING FIELD-SYMBOL(<ls_raw>).

    CLEAR gs_base.

    MOVE-CORRESPONDING <ls_raw> TO gs_base.

    " Task list type selection
    IF     ( p_ftl = 'X' AND <ls_raw>-plnty <> 'A' )  " FLoc TL
       AND ( p_etl = 'X' AND <ls_raw>-plnty <> 'E' )
       AND ( p_gtl = 'X' AND <ls_raw>-plnty <> 'G' ).
      " (Adjust mapping of PLNTY to your system)
    ENDIF.

    " Add TAPL / EAPL keys
    READ TABLE lt_tapl INTO DATA(ls_tapl)
         WITH KEY plnty = <ls_raw>-plnty
                  plnnr = <ls_raw>-plnnr
                  plnal = <ls_raw>-plnal
         BINARY SEARCH.
    IF sy-subrc = 0.
      gs_base-tplnr = ls_tapl-tplnr.
    ENDIF.

    READ TABLE lt_eapl INTO DATA(ls_eapl)
         WITH KEY plnty = <ls_raw>-plnty
                  plnnr = <ls_raw>-plnnr
                  plnal = <ls_raw>-plnal
         BINARY SEARCH.
    IF sy-subrc = 0.
      gs_base-equnr = ls_eapl-equnr.
    ENDIF.

    APPEND gs_base TO gt_base.

  ENDLOOP.

ENDFORM.

*======================================================================*
*  3. BUILD DISPLAY TABLE – INITIAL (“operations only”) VIEW
*======================================================================*
FORM build_display_initial.

  CLEAR gt_display.
  REFRESH gt_display.

  " Compact view per FDS step 2:
  " one row per operation, showing first characteristic (if any)
  DATA: lt_sorted TYPE STANDARD TABLE OF ty_task_base.

  lt_sorted = gt_base.
  SORT lt_sorted BY plnty plnnr plnal vornr uvorn merknr.

  DATA: lv_last_key TYPE string.

  LOOP AT lt_sorted INTO gs_base.

    DATA(lv_key) = |{ gs_base-plnty }-{ gs_base-plnnr }-{ gs_base-plnal }-{ gs_base-vornr }-{ gs_base-uvorn }|.

    IF lv_key = lv_last_key.
      CONTINUE. " already took first characteristic
    ENDIF.
    lv_last_key = lv_key.

    CLEAR gs_display.
    MOVE-CORRESPONDING gs_base TO gs_display.

    gs_display-row_kind = 'O'. " main op line
    APPEND gs_display TO gt_display.

  ENDLOOP.

  gv_show_char = gc_false.
  gv_show_ltxt = xsdbool( p_showl = 'X' ).

  IF gv_show_ltxt = gc_true.
    PERFORM add_longtext_for_ops.
  ENDIF.

ENDFORM.

*======================================================================*
*  4. BUILD DISPLAY TABLE – CHARACTERISTIC EXPANSION
*======================================================================*
FORM build_display_with_char.

  CLEAR gt_display.
  REFRESH gt_display.

  DATA: lt_sorted TYPE STANDARD TABLE OF ty_task_base.
  lt_sorted = gt_base.
  SORT lt_sorted BY plnty plnnr plnal vornr uvorn merknr.

  DATA: lv_key TYPE string.

  LOOP AT lt_sorted INTO gs_base.

    DATA(lv_opkey) = |{ gs_base-plnty }-{ gs_base-plnnr }-{ gs_base-plnal }-{ gs_base-vornr }-{ gs_base-uvorn }|.

    IF lv_opkey <> lv_key.
      " First row for this operation – main operation line
      lv_key = lv_opkey.
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.
      APPEND gs_display TO gt_display.
    ENDIF.

    " Now the characteristic line (if any characteristic exists)
    IF gs_base-merknr IS NOT INITIAL.
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.
      APPEND gs_display TO gt_display.
    ENDIF.

  ENDLOOP.

  gv_show_char = gc_true.

  IF gv_show_ltxt = gc_true.
    PERFORM add_longtext_for_chars.
  ENDIF.

ENDFORM.

*======================================================================*
*  5. LONG TEXT HANDLING
*======================================================================*
FORM add_longtext_for_ops.

  " Insert op long text lines after operation rows that have TXT-sp
  DATA: lt_result TYPE STANDARD TABLE OF ty_task_disp.

  CLEAR lt_result.
  LOOP AT gt_display INTO gs_display.

    APPEND gs_display TO lt_result.

    IF gs_display-row_kind = 'O' AND gs_display-txtsp_op <> space.

      PERFORM read_op_longtext
        USING gs_display
        CHANGING lt_result.

    ENDIF.

  ENDLOOP.

  gt_display = lt_result.

ENDFORM.

FORM add_longtext_for_chars.

  " Insert char long text lines after characteristic rows with LTEXTKZ
  DATA: lt_result TYPE STANDARD TABLE OF ty_task_disp.

  CLEAR lt_result.
  LOOP AT gt_display INTO gs_display.

    APPEND gs_display TO lt_result.

    IF gs_display-row_kind = 'C' AND gs_display-ltextkz = 'X'.

      PERFORM read_char_longtext
        USING gs_display
        CHANGING lt_result.

    ENDIF.

  ENDLOOP.

  gt_display = lt_result.

ENDFORM.

FORM read_op_longtext
  USING    is_disp TYPE ty_task_disp
  CHANGING ct_disp TYPE STANDARD TABLE.

  CLEAR gt_tline.
  REFRESH gt_tline.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'ILOP'
      language = sy-langu
      name     = |{ is_disp-plnty }{ is_disp-plnnr }{ is_disp-plnal }{ is_disp-vornr }|
      object   = 'PLPO'
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_disp TO gs_display.
    gs_display-row_kind = 'L'.
    gs_display-tdline   = gs_tline-tdline.
    gs_display-tdformat = gs_tline-tdformat.
    APPEND gs_display TO ct_disp.
  ENDLOOP.

ENDFORM.

FORM read_char_longtext
  USING    is_disp TYPE ty_task_disp
  CHANGING ct_disp TYPE STANDARD TABLE.

  CLEAR gt_tline.
  REFRESH gt_tline.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QL'
      language = sy-langu
      name     = |{ is_disp-plnty }{ is_disp-plnnr }{ is_disp-plnal }{ is_disp-vornr }{ is_disp-merknr }|
      object   = 'PLMK'
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_disp TO gs_display.
    gs_display-row_kind = 'L'.
    gs_display-tdline   = gs_tline-tdline.
    gs_display-tdformat = gs_tline-tdformat.
    APPEND gs_display TO ct_disp.
  ENDLOOP.

ENDFORM.

*======================================================================*
*  6. TOGGLE HANDLERS (toolbar buttons)
*======================================================================*
FORM toggle_characteristics.

  " If long text is on, FDS says char button disabled – but still guard here
  IF gv_show_ltxt = gc_true.
    RETURN.
  ENDIF.

  IF gv_show_char = gc_true.
    " Currently showing characteristics → go back to compact
    PERFORM build_display_initial.
  ELSE.
    PERFORM build_display_with_char.
  ENDIF.

  PERFORM refresh_display.

ENDFORM.

FORM toggle_longtext.

  " Flip state and rebuild from base depending on gv_show_char
  IF gv_show_ltxt = gc_true.
    gv_show_ltxt = gc_false.
  ELSE.
    gv_show_ltxt = gc_true.
  ENDIF.

  IF gv_show_char = gc_true.
    PERFORM build_display_with_char.
  ELSE.
    PERFORM build_display_initial.
  ENDIF.

  PERFORM refresh_display.

ENDFORM.

*======================================================================*
*  7. SALV DISPLAY
*======================================================================*
FORM display_alv.

  IF gt_display IS INITIAL.
    MESSAGE s398(00) WITH 'No data to display'.
    EXIT.
  ENDIF.

  TRY.
      cl_salv_table=>factory(
        IMPORTING
          r_salv_table = lo_alv
        CHANGING
          t_table      = gt_display ).
    CATCH cx_salv_msg.
      MESSAGE e398(00) WITH 'Error creating ALV'.
  ENDTRY.

  PERFORM configure_salv.

  lo_alv->display( ).

ENDFORM.

FORM configure_salv.

  lo_columns = lo_alv->get_columns( ).

  " Example: hide internal helper columns
  TRY.
      lo_column ?= lo_columns->get_column( 'ROW_KIND' ).
      lo_column->set_technical( abap_true ).
    CATCH cx_salv_not_found.
  ENDTRY.

  " Enable std functions + custom buttons handled via PF-STATUS
  lo_funcs = lo_alv->get_functions( ).
  lo_funcs->set_all( abap_true ).

  lo_layout = lo_alv->get_layout( ).
  ls_layout_key-report = sy-repid.
  lo_layout->set_key( ls_layout_key ).
  lo_layout->set_save_restriction( if_salv_c_layout=>restrict_none ).

  lo_disp = lo_alv->get_display_settings( ).
  lo_disp->set_striped_pattern( abap_true ).
  lo_disp->set_list_header( 'Task List Validation Report' ).

  lo_sel = lo_alv->get_selections( ).
  lo_sel->set_selection_mode( if_salv_c_selection_mode=>row_column ).

  " Events
  lo_events = lo_alv->get_event( ).
  SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

  PERFORM set_pfstatus.

ENDFORM.

FORM set_pfstatus.

  DATA: lv_status TYPE sypfkey.

  IF gv_show_ltxt = gc_true AND gv_show_char = gc_true.
    lv_status = gc_pfs_ltxt_char.
  ELSEIF gv_show_ltxt = gc_true AND gv_show_char = gc_false.
    lv_status = gc_pfs_ltxt_op.
  ELSEIF gv_show_ltxt = gc_false AND gv_show_char = gc_true.
    lv_status = gc_pfs_char.
  ELSE.
    lv_status = gc_pfs_base.
  ENDIF.

  lo_alv->set_screen_status(
     pfstatus      = lv_status
     report        = sy-repid
     set_functions = lo_alv->c_functions_all ).

ENDFORM.

FORM refresh_display.

  lo_alv->refresh( ).
  PERFORM set_pfstatus.

ENDFORM.