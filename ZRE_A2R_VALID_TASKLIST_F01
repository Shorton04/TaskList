*======================================================================*
* ZRE_A2R_VALID_TASKLIST_F01 – FULLY FDS-ALIGNED VERSION (CORRECTED)
*======================================================================*

CLASS lcl_event_handler IMPLEMENTATION.
  METHOD on_user_command.

    CASE e_salv_function.

      WHEN gc_func_clist_s.     "Show Characteristics
        gv_show_char = gc_true.
        gv_show_ltxt = gc_false.

      WHEN gc_func_clist_h.     "Hide Characteristics
        gv_show_char = gc_false.
        gv_show_ltxt = gc_false.

      WHEN gc_func_ltxt_s.      "Show Long Text
        gv_show_ltxt = gc_true.

      WHEN gc_func_ltxt_h.      "Hide Long Text
        gv_show_ltxt = gc_false.

      WHEN OTHERS.
        RETURN.

    ENDCASE.

    PERFORM build_display.
    PERFORM set_pfstatus_from_state.
    PERFORM set_title_from_state.
    PERFORM set_column_visibility_by_state.

    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.
ENDCLASS.


*---------------------------------------------------------------------*
* VALIDATE_SELECTION
*---------------------------------------------------------------------*
FORM validate_selection.

  IF p_ftl IS INITIAL AND
     p_etl IS INITIAL AND
     p_gtl IS INITIAL.
    MESSAGE e398(00) WITH 'Select at least one Task List Type'.
  ENDIF.

  IF so_keydt-low IS INITIAL.
    MESSAGE e398(00) WITH 'Enter a key date'.
  ENDIF.

ENDFORM.


*---------------------------------------------------------------------*
* PF-STATUS
*---------------------------------------------------------------------*
FORM set_pfstatus_from_state.

  DATA lv_pf TYPE sypfkey.

  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.
    lv_pf = 'ZSALV_BOTH_HIDE'.
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
    lv_pf = 'ZSALV_LTXT_SHOW'.
  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
    lv_pf = 'ZSALV_CLIST_ONLY'.
  ELSE.
    lv_pf = 'ZSALV_CLIST_LTXT'.
  ENDIF.

  lo_alv->set_screen_status(
    pfstatus = lv_pf
    report   = sy-repid ).

ENDFORM.


*---------------------------------------------------------------------*
* TITLE LOGIC
*---------------------------------------------------------------------*
FORM set_title_from_state.

  DATA lv_title TYPE string.
  lv_title = 'Maintenance Task List Report'.

  IF gv_show_char = gc_true.
    lv_title = lv_title && ' - Characteristics Active'.
  ENDIF.

  IF gv_show_ltxt = gc_true.
    lv_title = lv_title && ' - Long Text Active'.
  ENDIF.

  SET TITLEBAR 'TITLE_100' WITH lv_title.

ENDFORM.


*---------------------------------------------------------------------*
* CI FLAGS 1–28 (FULL)
*---------------------------------------------------------------------*
FORM derive_ci_fields
  USING iv_steuerkz TYPE plmk-steuerkz
  CHANGING cs_disp  TYPE ty_task_disp.

  DATA lv TYPE string VALUE iv_steuerkz.

  CONCATENATE lv '' INTO lv. "Ensure string

  IF strlen( lv ) < 28.
    lv = lv && repeat( val = ' ' occ = ( 28 - strlen( lv ) ) ).
  ENDIF.

  cs_disp-ci_quant         = lv+0(1).
  cs_disp-ci_meas_required = lv+1(1).
  cs_disp-ci_attr_ref      = lv+2(1).
  cs_disp-ci_ulim_ind      = lv+3(1).
  cs_disp-ci_llim_ind      = lv+4(1).
  cs_disp-ci_chk_tgt       = lv+5(1).
  cs_disp-ci_scope         = lv+6(1).
  cs_disp-ci_single_res    = lv+7(1).
  cs_disp-ci_samp_req      = lv+8(1).
  cs_disp-ci_recording     = lv+9(1).
  cs_disp-ci_doc_req       = lv+10(1).
  cs_disp-ci_category      = lv+11(1).
  " CONTINUATION 12–27
  cs_disp-ci_category      = lv+11(1).
  cs_disp-ci_syncro        = lv+12(1).
  cs_disp-ci_addsamp       = lv+13(1).
  cs_disp-ci_destroy       = lv+14(1).
  cs_disp-ci_calc          = lv+15(1).
  cs_disp-ci_sproc_req     = lv+16(1).
  cs_disp-ci_qscore        = lv+17(1).
  cs_disp-ci_nochange      = lv+18(1).
  cs_disp-ci_defects       = lv+19(1).
  cs_disp-ci_qmsub         = lv+20(1).
  cs_disp-ci_specs_change  = lv+21(1).
  cs_disp-ci_test_eq       = lv+22(1).
  cs_disp-ci_def_auto      = lv+23(1).
  cs_disp-ci_chgdoc        = lv+24(1).
  cs_disp-ci_spc           = lv+25(1).
  cs_disp-ci_print         = lv+26(1).
  cs_disp-ci_param         = lv+27(1).
  cs_disp-ci_procchar      = lv+28(1).

ENDFORM.


*---------------------------------------------------------------------*
* GET_DATA – FULL FDS JOIN + DATE LOGIC
*---------------------------------------------------------------------*
FORM get_data.

  DATA lv_keydat TYPE sy-datum.
  lv_keydat = so_keydt-low.

  CLEAR gt_base.

  SELECT
    plko~plnty plko~plnnr plko~plnal plko~datuv plko~werks plko~ktext
    plko~verwe plko~vagrp plko~statu AS stat_h plko~anlzu AS anlzu_h
    plko~strat plko~istru AS istru_h plko~adpsp plko~slwbez plko~loekz
    plko~andat plko~annam plko~aedat plko~aenam

    tapl~tplnr
    eapl~equnr

    plpo~plnkn plpo~zaehl plpo~vornr plpo~ltxa1 plpo~steus
    crhd~arbpl AS arbpl_o crhd~werks AS werks_o plpo~ktsch plpo~arbei
    plpo~arbeh plpo~dauno plpo~daune plpo~kalid plpo~execution_stage
    plpo~anlzu AS anlzu_o plpo~istru AS istru_o plpo~larnt
    plpo~ebeln plpo~ebelp plpo~lifnr plpo~preis plpo~waers plpo~sakto
    plpo~ekorg plpo~ekgrp plpo~txtsp AS txtsp_op plpo~loekz AS loekz_o

    plmk~merknr plmk~verwmerkm plmk~kurztext AS kurzt_char
    plmk~ltextkz plmk~toleranzun plmk~toleranzob
    plmk~pruefeinh plmk~stichprver plmk~pmethode plmk~katalgart1
    plmk~auswmenge1 plmk~steuerkz plmk~loekz AS loekz_c
    plmk~gultigab plmk~valid_to_on_db

    INTO CORRESPONDING FIELDS OF TABLE gt_base

    FROM plko
      INNER JOIN plas
        ON plas~plnty = plko~plnty
       AND plas~plnnr = plko~plnnr
       AND plas~plnal = plko~plnal
       AND plas~loekz = ' '
      INNER JOIN plpo
        ON plpo~plnty = plas~plnty
       AND plpo~plnnr = plas~plnnr
       AND plpo~plnkn = plas~plnkn
       AND plpo~zaehl = plas~zaehl
       AND plpo~loekz = ' '
      LEFT JOIN plmk
        ON plmk~plnty = plpo~plnty
       AND plmk~plnnr = plpo~plnnr
       AND plmk~plnkn = plpo~plnkn
       AND plmk~zaehl = plpo~zaehl
       AND plmk~loekz = ' '
      LEFT JOIN tapl
        ON tapl~plnty = plko~plnty
       AND tapl~plnnr = plko~plnnr
       AND tapl~plnal = plko~plnal
       AND tapl~loekz = ' '
      LEFT JOIN eapl
        ON eapl~plnty = plko~plnty
       AND eapl~plnnr = plko~plnnr
       AND eapl~plnal = plko~plnal
       AND eapl~loekz = ' '
      LEFT JOIN crhd
        ON crhd~objid = plpo~arbid

    WHERE plko~loekz = ' '
      AND plko~datuv <= lv_keydat
      AND plko~valid_to >= lv_keydat
      AND plpo~datuv <= lv_keydat
      AND plpo~valid_to >= lv_keydat
      AND plmk~gultigab <= lv_keydat
      AND plmk~valid_to_on_db >= lv_keydat.

ENDFORM.


*---------------------------------------------------------------------*
* APPEND_OP_LONGTEXT – FULL FDS TDNAME FORMAT
*---------------------------------------------------------------------*
FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA lt_lines TYPE STANDARD TABLE OF tline.
  DATA ls_line  TYPE tline.
  DATA lv_name  TYPE thead-tdname.
  DATA lv_plnnr lv_plnkn lv_zaehl TYPE char08.

  "Pad numeric PLNNR
  IF is_base-plnnr CO '0123456789'.
    lv_plnnr = |{ is_base-plnnr ALPHA = IN }|.
  ELSE.
    lv_plnnr = is_base-plnnr.
  ENDIF.

  lv_plnkn = |{ is_base-plnkn ALPHA = IN }|.
  lv_zaehl = |{ is_base-zaehl ALPHA = IN }|.

  CONCATENATE sy-mandt
              is_base-plnty
              lv_plnnr
              lv_plnkn
              lv_zaehl
         INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'PLPO'
      language = sy-langu
      name     = lv_name
      object   = 'ROUTING'
    TABLES
      lines    = lt_lines.

  LOOP AT lt_lines INTO ls_line.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.
    gs_display-row_kind = 'L'.
    gs_display-op_ltxt  = ls_line-tdline.
    gs_display-tdformat = ls_line-tdformat.
    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.


*---------------------------------------------------------------------*
* APPEND_CHAR_LONGTEXT – FULL FDS TDNAME FORMAT
*---------------------------------------------------------------------*
FORM append_char_longtext USING is_base TYPE ty_task_base.

  IF is_base-ltextkz IS INITIAL.
    RETURN.
  ENDIF.

  DATA lt_lines TYPE STANDARD TABLE OF tline.
  DATA ls_line  TYPE tline.
  DATA lv_name  TYPE thead-tdname.
  DATA lv_plnnr lv_plnkn lv_zaehl TYPE char08.
  DATA lv_merkn TYPE char04.
  DATA lv_kzinst TYPE c LENGTH 1.

  IF is_base-plnnr CO '0123456789'.
    lv_plnnr = |{ is_base-plnnr ALPHA = IN }|.
  ELSE.
    lv_plnnr = is_base-plnnr.
  ENDIF.

  lv_plnkn  = |{ is_base-plnkn ALPHA = IN }|.
  lv_merkn  = |{ is_base-merknr ALPHA = IN }|.
  lv_zaehl  = |{ is_base-zaehl ALPHA = IN }|.

  IF is_base-steuerkz(1) IS INITIAL.
    lv_kzinst = ' '.
  ELSE.
    lv_kzinst = is_base-steuerkz(1).
  ENDIF.

  CONCATENATE sy-mandt
              is_base-plnty
              lv_plnnr
              lv_plnkn
              lv_kzinst
              lv_merkn
              lv_zaehl
      INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QM'
      language = sy-langu
      name     = lv_name
      object   = 'QSS'
    TABLES
      lines    = lt_lines.

  LOOP AT lt_lines INTO ls_line.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.
    gs_display-row_kind  = 'L'.
    gs_display-tdformat  = ls_line-tdformat.
    gs_display-char_ltxt = ls_line-tdline.
    CLEAR gs_display-op_ltxt.
    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.


*---------------------------------------------------------------------*
* BUILD_DISPLAY (structure unchanged, internal logic improved)
*---------------------------------------------------------------------*
FORM build_display.

  DATA ls_base TYPE ty_task_base.
  DATA ls_disp TYPE ty_task_disp.

  CLEAR gt_display.

  SORT gt_base BY plnty plnnr plnal vornr merknr.

  LOOP AT gt_base INTO ls_base.

    "Operation header row
    IF gv_show_char = gc_false OR ls_base-merknr IS INITIAL.
      CLEAR ls_disp.
      MOVE-CORRESPONDING ls_base TO ls_disp.
      ls_disp-row_kind = 'O'.
      APPEND ls_disp TO gt_display.

      IF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
        PERFORM append_op_longtext USING ls_base.
      ENDIF.
    ENDIF.

    "Characteristic rows
    IF gv_show_char = gc_true AND ls_base-merknr IS NOT INITIAL.
      CLEAR ls_disp.
      MOVE-CORRESPONDING ls_base TO ls_disp.
      ls_disp-row_kind = 'C'.
      APPEND ls_disp TO gt_display.

      IF gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING ls_base.
      ENDIF.
    ENDIF.

  ENDLOOP.

  PERFORM adjust_display_fields_by_state.
  PERFORM cleanup_duplicates.

ENDFORM.


*---------------------------------------------------------------------*
* CLEANUP_DUPLICATES (FDS-aligned)
*---------------------------------------------------------------------*
FORM cleanup_duplicates.

  IF gv_show_ltxt = gc_false.
    RETURN.
  ENDIF.

  DATA lt_op TYPE STANDARD TABLE OF ty_task_disp.
  DATA lt_char TYPE STANDARD TABLE OF ty_task_disp.
  DATA lt_l TYPE STANDARD TABLE OF ty_task_disp.
  FIELD-SYMBOLS <l> TYPE ty_task_disp.

  LOOP AT gt_display ASSIGNING <l>.
    CASE <l>-row_kind.
      WHEN 'O'.
        APPEND <l> TO lt_op.
      WHEN 'C'.
        APPEND <l> TO lt_char.
      WHEN 'L'.
        APPEND <l> TO lt_l.
      WHEN OTHERS.
        APPEND <l> TO lt_op.
    ENDCASE.
  ENDLOOP.

  CLEAR gt_display.

  IF gv_show_char = gc_false.
    SORT lt_op BY plnty plnnr plnal vornr.
    DELETE ADJACENT DUPLICATES FROM lt_op
      COMPARING plnty plnnr plnal vornr.
    APPEND LINES OF lt_op TO gt_display.
    APPEND LINES OF lt_l TO gt_display.
  ELSE.
    SORT lt_char BY plnty plnnr plnal vornr merknr.
    DELETE ADJACENT DUPLICATES FROM lt_char
      COMPARING plnty plnnr plnal vornr merknr.
    APPEND LINES OF lt_char TO gt_display.
    APPEND LINES OF lt_l TO gt_display.
  ENDIF.

ENDFORM.