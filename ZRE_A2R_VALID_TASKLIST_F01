FORM set_column_visibility_by_state.

  DATA lo_columns TYPE REF TO cl_salv_columns_table.
  DATA lo_col     TYPE REF TO cl_salv_column_table.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  lo_columns = lo_alv->get_columns( ).


  "--------------------------------------------------------------
  " Helper macros
  "--------------------------------------------------------------
  DEFINE show_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_technical( abap_false ).
        lo_col->set_visible(   abap_true  ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE hide_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_technical( abap_true ).
        lo_col->set_visible(   abap_false ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.



  "==============================================================
  " ALWAYS HIDE NON-FDS COLUMNS
  "==============================================================

  "--- Header fields not required in FDS ---
  hide_col 'PLNTY'.
  hide_col 'KTEXT'.
  hide_col 'TPLNR'.
  hide_col 'EQUNR'.
  hide_col 'VERWE'.
  hide_col 'VAGRP'.
  hide_col 'STATU_H'.
  hide_col 'ANLZU_H'.
  hide_col 'STRAT'.
  hide_col 'ISTRU_H'.
  hide_col 'ADPSP'.
  hide_col 'SLWBEZ'.
  hide_col 'LOEKZ_H'.
  hide_col 'ANDAT'.
  hide_col 'ANNAM'.
  hide_col 'AEDAT'.
  hide_col 'AENAM'.

  "--- Operation fields not required in FDS ---
  hide_col 'LTXA1'.
  hide_col 'STEUS'.
  hide_col 'WERKS_O'.
  hide_col 'KTSCH'.
  hide_col 'ARBEH'.
  hide_col 'DAUNO'.
  hide_col 'DAUNE'.
  hide_col 'KALID'.
  hide_col 'EXECUTION_STAGE'.
  hide_col 'ANLZU_O'.
  hide_col 'ISTRU_O'.
  hide_col 'LARNT'.
  hide_col 'EBELN'.
  hide_col 'EBELP'.
  hide_col 'LIFNR'.
  hide_col 'PREIS'.
  hide_col 'WAERS'.
  hide_col 'SAKTO'.
  hide_col 'EKORG'.
  hide_col 'EKGRP'.
  hide_col 'TXTSP_OP'.
  hide_col 'LOEKZ_O'.

  "--- Characteristic fields not in FDS ---
  hide_col 'VERWMERKM'.
  hide_col 'LTEXTKZ'.
  hide_col 'TOLERANZUN'.
  hide_col 'TOLERANZOB'.
  hide_col 'PRUEFEINH'.
  hide_col 'STICHPRVER'.
  hide_col 'KATALGART1'.
  hide_col 'AUSWMENGE1'.
  hide_col 'STEUERKZ'.
  hide_col 'LOEKZ_C'.

  "--- CI1..CI28 ghost columns ---
  hide_col 'CI1'.
  hide_col 'CI2'.
  hide_col 'CI3'.
  hide_col 'CI4'.
  hide_col 'CI5'.
  hide_col 'CI6'.
  hide_col 'CI7'.
  hide_col 'CI8'.
  hide_col 'CI9'.
  hide_col 'CI10'.
  hide_col 'CI11'.
  hide_col 'CI12'.
  hide_col 'CI13'.
  hide_col 'CI14'.
  hide_col 'CI15'.
  hide_col 'CI16'.
  hide_col 'CI17'.
  hide_col 'CI18'.
  hide_col 'CI19'.
  hide_col 'CI20'.
  hide_col 'CI21'.
  hide_col 'CI22'.
  hide_col 'CI23'.
  hide_col 'CI24'.
  hide_col 'CI25'.
  hide_col 'CI26'.
  hide_col 'CI27'.
  hide_col 'CI28'.

  "--- Internal / Technical fields ---
  hide_col 'ROW_KIND'.


  "==============================================================
  " ALWAYS SHOW CORE FDS COLUMNS
  "==============================================================
  show_col 'PLNNR'.        "Group
  show_col 'PLNAL'.        "Counter
  show_col 'WERKS'.        "Plant
  show_col 'VORNR'.        "Operation
  show_col 'ARBPL_O'.      "Work Center
  show_col 'ARBEI'.        "Work
  show_col 'KURZT_CHAR'.   "Description
  show_col 'PMETHODE'.     "Insp Method
  show_col 'MERKNR'.       "Insp Number
  show_col 'TDFORMAT'.     "FK
  show_col 'OP_LTXT'.      "Operation Long Text
  show_col 'CHAR_LTXT'.    "Characteristic Long Text



  "==============================================================
  " CASE A/B/C/D – Your Original Logic
  "==============================================================

  "CASE A – No Char, No LT
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

    hide_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.


  "CASE B – Show Char, No LT
  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.

    hide_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.


  "CASE C – Hide Char, Show LT
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

    show_col 'TDFORMAT'.
    show_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.


  "CASE D – Char + LT
  ELSE.

    show_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    show_col 'CHAR_LTXT'.

  ENDIF.

ENDFORM.


FORM display_alv.

  DATA: lx_salv_ex  TYPE REF TO cx_root,
        lx_salv_msg TYPE REF TO cx_salv_msg.

  IF gt_display IS INITIAL.
    MESSAGE s398(00) WITH 'No data to display'.
    RETURN.
  ENDIF.

  TRY.

      " Create SALV only once
      IF lo_alv IS INITIAL.

        cl_salv_table=>factory(
          IMPORTING
            r_salv_table = lo_alv
          CHANGING
            t_table      = gt_display ).

        " Columns handling
        lo_columns = lo_alv->get_columns( ).
        lo_columns->set_optimize( abap_true ).

        "-----------------------------------------------------------*
        " Hide columns that are NOT in the FDS visible list
        "-----------------------------------------------------------*

        " Technical
        PERFORM hide_column USING 'ROW_KIND'.

        " Header to hide
        PERFORM hide_column USING 'PLNTY'.
        PERFORM hide_column USING 'DATUV'.
        PERFORM hide_column USING 'KTEXT'.
        PERFORM hide_column USING 'TPLNR'.
        PERFORM hide_column USING 'EQUNR'.
        PERFORM hide_column USING 'VERWE'.
        PERFORM hide_column USING 'VAGRP'.
        PERFORM hide_column USING 'STAT_H'.
        PERFORM hide_column USING 'ANLZU_H'.
        PERFORM hide_column USING 'STRAT'.
        PERFORM hide_column USING 'ISTRU_H'.
        PERFORM hide_column USING 'ADPSP'.
        PERFORM hide_column USING 'SLWBEZ'.
        PERFORM hide_column USING 'LOEKZ_H'.
        PERFORM hide_column USING 'ANDAT'.
        PERFORM hide_column USING 'ANNAM'.
        PERFORM hide_column USING 'AEDAT'.
        PERFORM hide_column USING 'AENAM'.

        " Operation to hide (keep VORNR, ARBPL_O, ARBEI)
        PERFORM hide_column USING 'LTXA1'.
        PERFORM hide_column USING 'STEUS'.
        PERFORM hide_column USING 'WERKS_O'.
        PERFORM hide_column USING 'KTSCH'.
        PERFORM hide_column USING 'ARBEH'.
        PERFORM hide_column USING 'DAUNO'.
        PERFORM hide_column USING 'DAUNE'.
        PERFORM hide_column USING 'KALID'.
        PERFORM hide_column USING 'EXECUTION_STAGE'.
        PERFORM hide_column USING 'ANLZU_O'.
        PERFORM hide_column USING 'ISTRU_O'.
        PERFORM hide_column USING 'LARNT'.
        PERFORM hide_column USING 'EBELN'.
        PERFORM hide_column USING 'EBELP'.
        PERFORM hide_column USING 'LIFNR'.
        PERFORM hide_column USING 'PREIS'.
        PERFORM hide_column USING 'WAERS'.
        PERFORM hide_column USING 'SAKTO'.
        PERFORM hide_column USING 'EKORG'.
        PERFORM hide_column USING 'EKGRP'.
        PERFORM hide_column USING 'TXTSP_OP'.
        PERFORM hide_column USING 'TDLINE'.
        PERFORM hide_column USING 'LOEKZ_O'.

        " Characteristic to hide (keep MERKNR, KURZT_CHAR, PMETHODE)
        PERFORM hide_column USING 'VERWMERKM'.
        PERFORM hide_column USING 'LTEXTKZ'.
        PERFORM hide_column USING 'TOLERANZUN'.
        PERFORM hide_column USING 'TOLERANZOB'.
        PERFORM hide_column USING 'PRUEFEINH'.
        PERFORM hide_column USING 'STICHPRVER'.
        PERFORM hide_column USING 'KATALGART1'.
        PERFORM hide_column USING 'AUSWMENGE1'.
        PERFORM hide_column USING 'STEUERKZ'.
        PERFORM hide_column USING 'LOEKZ_C'.

        " CI flags – all hidden
        PERFORM hide_column USING 'CI_QUANT'.
        PERFORM hide_column USING 'CI_MEAS_REQUIRED'.
        PERFORM hide_column USING 'CI_ATTR_REF'.
        PERFORM hide_column USING 'CI_ULIM_IND'.
        PERFORM hide_column USING 'CI_LLIM_IND'.
        PERFORM hide_column USING 'CI_CHK_TGT'.
        PERFORM hide_column USING 'CI_SCOPE'.
        PERFORM hide_column USING 'CI_SINGLE_RES'.
        PERFORM hide_column USING 'CI_SAMP_REQ'.
        PERFORM hide_column USING 'CI_RECORDING'.
        PERFORM hide_column USING 'CI_DOC_REQ'.
        PERFORM hide_column USING 'CI_CATEGORY'.

        "-----------------------------------------------------------*
        " FDS column order
        "-----------------------------------------------------------*
        PERFORM set_position USING 'PLNNR'      1.   "Group
        PERFORM set_position USING 'PLNAL'      2.   "Counter
        PERFORM set_position USING 'WERKS'      3.   "Plant
        PERFORM set_position USING 'VORNR'      4.   "Operation
        PERFORM set_position USING 'ARBPL_O'    5.   "WC
        PERFORM set_position USING 'ARBEI'      6.   "Work
        PERFORM set_position USING 'KURZT_CHAR' 7.   "Description
        PERFORM set_position USING 'PMETHODE'   8.   "Insp. Method
        PERFORM set_position USING 'MERKNR'     9.   "Insp#
        PERFORM set_position USING 'TDFORMAT'  10.   "FK
        PERFORM set_position USING 'OP_LTXT'   11.   "Op Long Text
        PERFORM set_position USING 'CHAR_LTXT' 12.   "Char Long Text

        "-----------------------------------------------------------*
        " Column texts – FDS-friendly captions
        "-----------------------------------------------------------*
        TRY.
            lo_column ?= lo_columns->get_column( 'PLNNR' ).
            lo_column->set_short_text(  |Grp| ).
            lo_column->set_medium_text( |Group| ).
            lo_column->set_long_text(   |Group| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'PLNAL' ).
            lo_column->set_short_text(  |Cntr| ).
            lo_column->set_medium_text( |Counter| ).
            lo_column->set_long_text(   |Counter| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'WERKS' ).
            lo_column->set_short_text(  |Plant| ).
            lo_column->set_medium_text( |Plant| ).
            lo_column->set_long_text(   |Plant| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'VORNR' ).
            lo_column->set_short_text(  |Op.| ).
            lo_column->set_medium_text( |Operation| ).
            lo_column->set_long_text(   |Operation| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'TDFORMAT' ).
            lo_column->set_short_text(  |FK| ).
            lo_column->set_medium_text( |Frmt Key| ).
            lo_column->set_long_text(   |Format Key| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'OP_LTXT' ).
            lo_column->set_short_text(  |Op Long Text| ).
            lo_column->set_medium_text( |Operation Long Text| ).
            lo_column->set_long_text(   |Operation Long Text| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'ARBPL_O' ).
            lo_column->set_short_text(  |WC| ).
            lo_column->set_medium_text( |Work Center| ).
            lo_column->set_long_text(   |Work Center| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'ARBEI' ).
            lo_column->set_short_text(  |Work| ).
            lo_column->set_medium_text( |Work| ).
            lo_column->set_long_text(   |Work| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'KURZT_CHAR' ).
            lo_column->set_short_text(  |Descrip| ).
            lo_column->set_medium_text( |Insp. Description| ).
            lo_column->set_long_text(   |Inspection Description| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'PMETHODE' ).
            lo_column->set_short_text(  |Insp Meth| ).
            lo_column->set_medium_text( |Inspection Method| ).
            lo_column->set_long_text(   |Inspection Method| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'MERKNR' ).
            lo_column->set_short_text(  |Insp#| ).
            lo_column->set_medium_text( |Inspection No.| ).
            lo_column->set_long_text(   |Inspection Number| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'CHAR_LTXT' ).
            lo_column->set_short_text(  |Char Long Text| ).
            lo_column->set_medium_text( |Characteristic Long Text| ).
            lo_column->set_long_text(   |Characteristic Long Text| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        " Display settings
        lo_disp = lo_alv->get_display_settings( ).
        lo_disp->set_striped_pattern( abap_true ).
        lo_disp->set_list_header( 'Maintenance Task List Report' ).

        " Layout
        lo_layout = lo_alv->get_layout( ).
        ls_layout_key-report = sy-repid.
        lo_layout->set_key( ls_layout_key ).
        lo_layout->set_default( abap_true ).

        " Functions
        lo_funcs = lo_alv->get_functions( ).
        lo_funcs->set_all( abap_true ).

        " Events
        lo_events = lo_alv->get_event( ).
        SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

      ELSE.
        " ALV already exists – just refresh data
        lo_alv->refresh( ).
      ENDIF.

      PERFORM set_column_visibility_by_state.
      PERFORM set_pfstatus_from_state.
      lo_alv->display( ).

    CATCH cx_salv_msg INTO lx_salv_msg.
      MESSAGE lx_salv_msg->get_text( ) TYPE 'E'.
    CATCH cx_root INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.
  ENDTRY.

ENDFORM.
