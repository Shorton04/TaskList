*---------------------------------------------------------------------*
* Display ALV – flat list, FDS column order
*---------------------------------------------------------------------*
FORM display_alv.

  DATA: lx_salv_msg TYPE REF TO cx_salv_msg,
        lx_salv_ex  TYPE REF TO cx_root,
        lv_title    TYPE lvc_title,
        lv_fname    TYPE lvc_fname.

  "No data – nothing to show
  IF gt_display IS INITIAL.
    MESSAGE s398(00) WITH 'No data to display'.
    RETURN.
  ENDIF.

  TRY.

      "-----------------------------------------------------------*
      " Create SALV (simple full-screen)
      "-----------------------------------------------------------*
      cl_salv_table=>factory(
        IMPORTING
          r_salv_table = lo_alv
        CHANGING
          t_table      = gt_display ).

      "-----------------------------------------------------------*
      " Columns – order & headings per mock-up
      "-----------------------------------------------------------*
      lo_columns = lo_alv->get_columns( ).
      lo_columns->set_optimize( abap_true ).

      "Helper macro for setting caption + position
      DEFINE m_set_col.
        TRY.
            lo_column ?= lo_columns->get_column( &1 ).
            lo_column->set_short_text(  &2 ).
            lo_column->set_medium_text( &2 ).
            lo_column->set_long_text(   &2 ).
            lo_column->set_position(    &3 ).
          CATCH cx_salv_not_found.
        ENDTRY.
      END-OF-DEFINITION.

      " 1  Group (PLNNR)
      m_set_col 'PLNNR'     'Group'        1.
      " 2  Counter (PLNAL)
      m_set_col 'PLNAL'     'Counter'      2.
      " 3  Plant (WERKS)
      m_set_col 'WERKS'     'Plant'        3.
      " 4  Operation (VORNR)
      m_set_col 'VORNR'     'Operation'    4.
      " 5  Op LTxt (OP_LTXT)
      m_set_col 'OP_LTXT'   'Op LTxt'      5.
      " 6  Work Ctr (ARBPL_O)
      m_set_col 'ARBPL_O'   'Work Ctr'     6.
      " 7  Work (ARBEI)
      m_set_col 'ARBEI'     'Work'         7.
      " 8  Insp# (MERKNR)
      m_set_col 'MERKNR'    'Insp#'        8.
      " 9  Descrip (KURZT_CHAR)
      m_set_col 'KURZT_CHAR' 'Insp. Description' 9.
      " 10 Insp. Method (PMETHODE)
      m_set_col 'PMETHODE'  'Insp. Meth'  10.
      " 11 Char Long Text (CHAR_LTXT)
      m_set_col 'CHAR_LTXT' 'Char LTxt'   11.

      "Hide columns we don’t want to see (technical / helper)
      DATA lt_hide TYPE STANDARD TABLE OF lvc_fname.
      lt_hide = VALUE #( 
        ( 'PLNTY' ) ( 'STAT_H' ) ( 'ANLZU_H' ) ( 'STRAT' )
        ( 'ISTRU_H' ) ( 'ADPSP' ) ( 'SLWBEZ' )
        ( 'LOEKZ_H' ) ( 'ANDAT' ) ( 'ANNAM' ) ( 'AEDAT' ) ( 'AENAM' )
        ( 'WERKS_O' )
        ( 'DAUNO' ) ( 'DAUNE' ) ( 'KALID' ) ( 'EXECUTION_STAGE' )
        ( 'ANLZU_O' ) ( 'ISTRU_O' ) ( 'LARNT' ) ( 'EBELN' ) ( 'EBELP' )
        ( 'LIFNR' ) ( 'PREIS' ) ( 'WAERS' ) ( 'SAKTO' ) ( 'EKORG' )
        ( 'EKGRP' ) ( 'TXTSP_OP' ) ( 'LOEKZ_O' )
        ( 'TOLERANZUN' ) ( 'TOLERANZOB' ) ( 'PRUEFEINH' )
        ( 'STICHPRVER' ) ( 'KATALGART1' ) ( 'AUSWMENGE1' )
        ( 'STEUERKZ' ) ( 'LOEKZ_C' )
        ( 'CI_QUANT' ) ( 'CI_MEAS_REQUIRED' ) ( 'CI_ATTR_REF' )
        ( 'CI_ULIM_IND' ) ( 'CI_LLIM_IND' ) ( 'CI_CHK_TGT' )
        ( 'CI_SCOPE' ) ( 'CI_SINGLE_RES' ) ( 'CI_SAMP_REQ' )
        ( 'CI_RECORDING' ) ( 'CI_DOC_REQ' ) ( 'CI_CATEGORY' )
        ( 'TDLINE' ) ( 'TDFORMAT' ) ( 'ROW_KIND' )
        ( 'ARBEH' )          "Unit – we only show quantity as 'Work'
      ).

      LOOP AT lt_hide INTO lv_fname.
        TRY.
            lo_column ?= lo_columns->get_column( lv_fname ).
            lo_column->set_technical( abap_true ).
          CATCH cx_salv_not_found.
        ENDTRY.
      ENDLOOP.

      "-----------------------------------------------------------*
      " Display settings
      "-----------------------------------------------------------*
      lo_disp = lo_alv->get_display_settings( ).
      lo_disp->set_striped_pattern( abap_true ).

      lv_title = |Valid Task Lists – Task Ops & Chars|.
      lo_disp->set_list_header( lv_title ).

      "Allow all SALV standard functions (sort, filter, export…)
      lo_funcs = lo_alv->get_functions( ).
      lo_funcs->set_all( abap_true ).

      "Allow row selection
      lo_sel = lo_alv->get_selections( ).
      lo_sel->set_selection_mode( if_salv_c_selection_mode=>row_column ).

      "-----------------------------------------------------------*
      " Display ALV
      "-----------------------------------------------------------*
      lo_alv->display( ).

    CATCH cx_salv_existing INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.

    CATCH cx_salv_wrong_call INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.

    CATCH cx_salv_msg INTO lx_salv_msg.
      MESSAGE lx_salv_msg->get_text( ) TYPE 'E'.

  ENDTRY.

ENDFORM.






*&---------------------------------------------------------------------*
*& Form APPEND_OP_LONGTEXT
*&---------------------------------------------------------------------*
*  - Appends operation long text lines as separate rows in GT_DISPLAY
*    with:
*       ROW_KIND = 'L'
*       OP_LTXT  = text line
*    (other key fields copied from IS_BASE)
*&---------------------------------------------------------------------*
FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA: ls_thead TYPE thead,
        lv_name  TYPE thead-tdname.

  CLEAR gt_tline.

  "Build text name – this must match your system's customizing.
  "Pattern here follows MaintPlan report:
  "   PLNTY + PLNNR (ALPHA) + PLNAL + VORNR
  lv_name = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-vornr }|.

  CLEAR ls_thead.
  ls_thead-tdid     = 'PLPO'.     "Operation long text ID
  ls_thead-tdspras  = sy-langu.
  ls_thead-tdname   = lv_name.
  ls_thead-tdobject = 'PLPO'.    "Operation text object

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = ls_thead-tdid
      language = ls_thead-tdspras
      name     = ls_thead-tdname
      object   = ls_thead-tdobject
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR gt_tline IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind = 'L'.
    gs_display-op_ltxt  = gs_tline-tdline.
    gs_display-tdformat = gs_tline-tdformat.

    "Other columns (group, counter, plant, op, wc, work…) stay filled
    "from IS_BASE via MOVE-CORRESPONDING

    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.




*&---------------------------------------------------------------------*
*& Form APPEND_CHAR_LONGTEXT
*&---------------------------------------------------------------------*
*  - Appends characteristic long text lines as separate rows in GT_DISPLAY
*    with:
*       ROW_KIND  = 'L'
*       CHAR_LTXT = text line
*&---------------------------------------------------------------------*
FORM append_char_longtext USING is_base TYPE ty_task_base.

  DATA: ls_thead TYPE thead,
        lv_name  TYPE thead-tdname.

  CLEAR gt_tline.

  "Text name pattern for characteristic – align with MaintPlan.
  "Example: PLNTY + PLNNR (ALPHA) + PLNAL + MERKNR (ALPHA)
  lv_name = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-merknr ALPHA = OUT }|.

  CLEAR ls_thead.
  ls_thead-tdid     = 'PLMK'.     "Characteristic long text ID
  ls_thead-tdspras  = sy-langu.
  ls_thead-tdname   = lv_name.
  ls_thead-tdobject = 'PLMK'.    "Characteristic text object

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = ls_thead-tdid
      language = ls_thead-tdspras
      name     = ls_thead-tdname
      object   = ls_thead-tdobject
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR gt_tline IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind  = 'L'.
    gs_display-char_ltxt = gs_tline-tdline.
    gs_display-tdformat  = gs_tline-tdformat.

    "Other key fields (group, counter, plant, op, insp#, etc.) stay filled

    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.





