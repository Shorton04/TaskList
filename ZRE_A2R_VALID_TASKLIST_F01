*---------------------------------------------------------------------*
*  FORM get_data – FULLY FDS-ALIGNED
*---------------------------------------------------------------------*
FORM get_data.

  DATA: lv_keydat TYPE plko-datuv,
        lv_tolun  TYPE plmk-toleranzun,
        lv_tolob  TYPE plmk-toleranzob.

  CLEAR: gt_base, gs_base.

  lv_keydat = so_keydt-low.

  " Convert tolerance CHAR16 → FLTP
  IF so_tolun IS NOT INITIAL.
    lv_tolun = so_tolun.
  ENDIF.

  IF so_tolob IS NOT INITIAL.
    lv_tolob = so_tolob.
  ENDIF.

  "-------------------------------------------------------------------*
  " MAIN SELECT – COMPLETE FDS HEADER + OP + CHAR + ASSIGNMENT FIELDS
  "-------------------------------------------------------------------*
  SELECT
    "================ HEADER (PLKO) ================================
    plko~plnty
    plko~plnnr
    plko~plnal
    plko~datuv
    plko~valid_to         AS valid_to
    plko~werks
    plko~ktext
    plko~verwe
    plko~vagrp
    plko~statu            AS stat_h
    plko~anlzu            AS anlzu_h
    plko~strat
    plko~istru            AS istru_h
    plko~adpsp
    plko~slwbez
    plko~loekz            AS loekz_h
    plko~andat
    plko~annam
    plko~aedat
    plko~aenam

    "================ FLOC & EQUIPMENT ==============================
    tapl~tplnr
    eapl~equnr

    "================ OPERATIONS (PLPO) =============================
    plpo~plnkn
    plpo~zaehl
    plpo~datuv            AS datuv_o
    plpo~valid_to         AS valid_to_o
    plpo~vornr
    plpo~ltxa1
    plpo~steus
    crhd~arbpl            AS arbpl_o
    crhd~werks            AS werks_o
    plpo~ktsch
    plpo~arbei
    plpo~arbeh
    plpo~dauno
    plpo~daune
    plpo~kalid
    plpo~execution_stage
    plpo~anlzu            AS anlzu_o
    plpo~istru            AS istru_o
    plpo~larnt
    plpo~ebeln
    plpo~ebelp
    plpo~lifnr
    plpo~preis
    plpo~waers
    plpo~sakto
    plpo~ekorg
    plpo~ekgrp
    plpo~txtsp            AS txtsp_op
    plpo~loekz            AS loekz_o

    "================ CHARACTERISTICS (PLMK) ========================
    plmk~merknr
    plmk~verwmerkm
    plmk~kurztext         AS kurzt_char
    plmk~ltextkz
    plmk~toleranzun
    plmk~toleranzob
    plmk~pruefeinh
    plmk~stichprver
    plmk~pmethode
    plmk~katalgart1
    plmk~auswmenge1
    plmk~steuerkz
    plmk~loekz            AS loekz_c
    plmk~gueltigab
    plmk~valid_to_on_db   AS valid_to_c

    INTO CORRESPONDING FIELDS OF TABLE gt_base

    FROM plko
      INNER JOIN plas
        ON plas~plnty = plko~plnty
       AND plas~plnnr = plko~plnnr
       AND plas~plnal = plko~plnal
       AND plas~loekz = ' '

      INNER JOIN plpo
        ON plpo~plnty = plas~plnty
       AND plpo~plnnr = plas~plnnr
       AND plpo~plnkn = plas~plnkn
       AND plpo~zaehl = plas~zaehl
       AND plpo~loekz = ' '

      LEFT JOIN plmk
        ON plmk~plnty = plpo~plnty
       AND plmk~plnnr = plpo~plnnr
       AND plmk~plnkn = plpo~plnkn
       AND plmk~zaehl = plpo~zaehl
       AND plmk~loekz = ' '

      LEFT JOIN tapl
        ON tapl~plnty = plko~plnty
       AND tapl~plnnr = plko~plnnr
       AND tapl~plnal = plko~plnal
       AND tapl~loekz = ' '

      LEFT JOIN eapl
        ON eapl~plnty = plko~plnty
       AND eapl~plnnr = plko~plnnr
       AND eapl~plnal = plko~plnal
       AND eapl~loekz = ' '

      LEFT JOIN crhd
        ON crhd~objid = plpo~arbid

    WHERE plko~loekz = ' '
      AND plko~datuv     <= lv_keydat
      AND plko~valid_to  >= lv_keydat
      AND plpo~datuv     <= lv_keydat
      AND plpo~valid_to  >= lv_keydat
      AND ( plmk~gueltigab IS INITIAL OR plmk~gueltigab <= lv_keydat )
      AND ( plmk~valid_to_on_db IS INITIAL OR plmk~valid_to_on_db >= lv_keydat ).

  SORT gt_base BY plnty plnnr plnal vornr merknr.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM derive_ci_fields – FULL 28 CI FLAGS
*---------------------------------------------------------------------*
FORM derive_ci_fields
  USING iv_steuerkz TYPE plmk-steuerkz
  CHANGING cs_disp TYPE ty_task_disp.

  DATA lv TYPE string VALUE iv_steuerkz.

  IF strlen( lv ) < 28.
    lv = lv && repeat( val = ' ' occ = 28 - strlen( lv ) ).
  ELSEIF strlen( lv ) > 28.
    lv = lv(28).
  ENDIF.

  cs_disp-ci1  = lv+0(1).
  cs_disp-ci2  = lv+1(1).
  cs_disp-ci3  = lv+2(1).
  cs_disp-ci4  = lv+3(1).
  cs_disp-ci5  = lv+4(1).
  cs_disp-ci6  = lv+5(1).
  cs_disp-ci7  = lv+6(1).
  cs_disp-ci8  = lv+7(1).
  cs_disp-ci9  = lv+8(1).
  cs_disp-ci10 = lv+9(1).
  cs_disp-ci11 = lv+10(1).
  cs_disp-ci12 = lv+11(1).
  cs_disp-ci13 = lv+12(1).
  cs_disp-ci14 = lv+13(1).
  cs_disp-ci15 = lv+14(1).
  cs_disp-ci16 = lv+15(1).
  cs_disp-ci17 = lv+16(1).
  cs_disp-ci18 = lv+17(1).
  cs_disp-ci19 = lv+18(1).
  cs_disp-ci20 = lv+19(1).
  cs_disp-ci21 = lv+20(1).
  cs_disp-ci22 = lv+21(1).
  cs_disp-ci23 = lv+22(1).
  cs_disp-ci24 = lv+23(1).
  cs_disp-ci25 = lv+24(1).
  cs_disp-ci26 = lv+25(1).
  cs_disp-ci27 = lv+26(1).
  cs_disp-ci28 = lv+27(1).

ENDFORM.


*---------------------------------------------------------------------*
*  FORM append_op_longtext – OPERATION LONG TEXT (FDS TDNAME RULE)
*---------------------------------------------------------------------*
FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines TYPE STANDARD TABLE OF tline,
        ls_line  TYPE tline,
        lv_name  TYPE thead-tdname,
        lv_plnnr TYPE char08,
        lv_plnkn TYPE char08,
        lv_zaehl TYPE char08.

  " PLNNR padding rule (FDS)
  IF is_base-plnnr CO '0123456789'.
    lv_plnnr = |{ is_base-plnnr ALPHA = IN }|.
  ELSE.
    lv_plnnr = is_base-plnnr.
  ENDIF.

  lv_plnkn = |{ is_base-plnkn ALPHA = IN }|.
  lv_zaehl = |{ is_base-zaehl ALPHA = IN }|.

  CONCATENATE sy-mandt is_base-plnty lv_plnnr lv_plnkn lv_zaehl
    INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'PLPO'
      language = sy-langu
      name     = lv_name
      object   = 'ROUTING'
    TABLES
      lines    = lt_lines.

  LOOP AT lt_lines INTO ls_line.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.
    gs_display-row_kind = 'L'.
    gs_display-op_ltxt  = ls_line-tdline.
    gs_display-tdformat = ls_line-tdformat.
    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM append_char_longtext – CHARACTERISTIC LONG TEXT
*---------------------------------------------------------------------*
FORM append_char_longtext USING is_base TYPE ty_task_base.

  IF is_base-ltextkz IS INITIAL.
    RETURN.
  ENDIF.

  DATA: lt_lines TYPE STANDARD TABLE OF tline,
        ls_line  TYPE tline,
        lv_name  TYPE thead-tdname,
        lv_plnnr TYPE char08,
        lv_plnkn TYPE char08,
        lv_zaehl TYPE char08,
        lv_merkn TYPE char04,
        lv_kzinst TYPE c LENGTH 1.

  IF is_base-plnnr CO '0123456789'.
    lv_plnnr = |{ is_base-plnnr ALPHA = IN }|.
  ELSE.
    lv_plnnr = is_base-plnnr.
  ENDIF.

  lv_plnkn  = |{ is_base-plnkn ALPHA = IN }|.
  lv_merkn  = |{ is_base-merknr ALPHA = IN }|.
  lv_zaehl  = |{ is_base-zaehl ALPHA = IN }|.

  IF is_base-steuerkz(1) IS INITIAL.
    lv_kzinst = ' '.
  ELSE.
    lv_kzinst = is_base-steuerkz(1).
  ENDIF.

  CONCATENATE sy-mandt
              is_base-plnty
              lv_plnnr
              lv_plnkn
              lv_kzinst
              lv_merkn
              lv_zaehl
    INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QM'
      language = sy-langu
      name     = lv_name
      object   = 'QSS'
    TABLES
      lines    = lt_lines.

  LOOP AT lt_lines INTO ls_line.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.
    gs_display-row_kind  = 'L'.
    gs_display-char_ltxt = ls_line-tdline.
    gs_display-tdformat  = ls_line-tdformat.
    CLEAR gs_display-op_ltxt.
    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.




*---------------------------------------------------------------------*
*  FORM build_display – MAIN CONSTRUCTION OF OUTPUT TABLE
*---------------------------------------------------------------------*
FORM build_display.

  CLEAR gt_display.

  LOOP AT gt_base INTO gs_base.

    "-------------------------------------------------------------*
    " OPERATION LEVEL ROW (always created)
    "-------------------------------------------------------------*
    CLEAR gs_display.
    MOVE-CORRESPONDING gs_base TO gs_display.
    gs_display-row_kind = 'O'.

    PERFORM derive_ci_fields
      USING gs_base-steuerkz
      CHANGING gs_display.

    APPEND gs_display TO gt_display.

    "-------------------------------------------------------------*
    " OPERATION LONG TEXT (mode = Show Long Text only)
    "-------------------------------------------------------------*
    IF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
      PERFORM append_op_longtext USING gs_base.
    ENDIF.

    "-------------------------------------------------------------*
    " CHARACTERISTICS (mode = Show Characteristics)
    "-------------------------------------------------------------*
    IF gv_show_char = gc_true AND gs_base-merknr IS NOT INITIAL.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      PERFORM derive_ci_fields
        USING gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      " Characteristic Long Text (mode = Show Char + Show LT)
      IF gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

  "-------------------------------------------------------------*
  " Final cleanup & field adjustment
  "-------------------------------------------------------------*
  PERFORM adjust_display_fields_by_state.
  PERFORM cleanup_duplicates.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM adjust_display_fields_by_state – Column visibility logic
*---------------------------------------------------------------------*
FORM adjust_display_fields_by_state.

  LOOP AT gt_display INTO gs_display.

    CASE gs_display-row_kind.

      WHEN 'O'.  "Operation row
        CLEAR: gs_display-op_ltxt, gs_display-char_ltxt.

      WHEN 'C'.  "Characteristic row
        CLEAR gs_display-op_ltxt.

      WHEN 'L'.  "Long text row
        CLEAR: gs_display-arbei gs_display-arbeh gs_display-steus
               gs_display-ktsch gs_display-pruefeinh gs_display-stichprver
               gs_display-pmethode gs_display-katalgart1
               gs_display-auswmenge1 gs_display-steuerkz
               gs_display-merknr gs_display-kurzt_char.

    ENDCASE.

    MODIFY gt_display FROM gs_display.

  ENDLOOP.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM cleanup_duplicates – final remove duplicates per FDS
*---------------------------------------------------------------------*
FORM cleanup_duplicates.

  DATA: lt_op   TYPE STANDARD TABLE OF ty_task_disp,
        lt_char TYPE STANDARD TABLE OF ty_task_disp,
        lt_l    TYPE STANDARD TABLE OF ty_task_disp.

  FIELD-SYMBOLS <ls> TYPE ty_task_disp.

  CLEAR: lt_op, lt_char, lt_l.

  LOOP AT gt_display ASSIGNING <ls>.
    CASE <ls>-row_kind.
      WHEN 'O'.
        APPEND <ls> TO lt_op.
      WHEN 'C'.
        APPEND <ls> TO lt_char.
      WHEN 'L'.
        APPEND <ls> TO lt_l.
    ENDCASE.
  ENDLOOP.

  CLEAR gt_display.

  " Show only Operations + OP.LTXT (Case C)
  IF gv_show_char = gc_false.
    SORT lt_op BY plnty plnnr plnal vornr.
    DELETE ADJACENT DUPLICATES FROM lt_op
     COMPARING plnty plnnr plnal vornr.
    APPEND LINES OF lt_op TO gt_display.
    APPEND LINES OF lt_l  TO gt_display.

  " Show Characteristics + CHAR.LTXT (Case D)
  ELSE.
    SORT lt_char BY plnty plnnr plnal vornr merknr.
    DELETE ADJACENT DUPLICATES FROM lt_char
     COMPARING plnty plnnr plnal vornr merknr.
    APPEND LINES OF lt_char TO gt_display.
    APPEND LINES OF lt_l    TO gt_display.
  ENDIF.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM display_alv – SALV setup and rendering
*---------------------------------------------------------------------*
FORM display_alv.

  TRY.

      cl_salv_table=>factory(
        IMPORTING r_salv_table = lo_alv
        CHANGING  t_table      = gt_display ).

    CATCH cx_salv_msg.
      MESSAGE e398(00) WITH 'Unable to initialize ALV'.
  ENDTRY.

  lo_columns = lo_alv->get_columns( ).
  lo_columns->set_optimize( abap_true ).

  lo_events = lo_alv->get_event( ).
  SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

  " Activate standard ALV functions
  lo_funcs = lo_alv->get_functions( ).
  lo_funcs->set_all( abap_true ).

  PERFORM set_pfstatus_from_state.
  PERFORM set_title_from_state.
  PERFORM set_column_visibility_by_state.

  lo_alv->display( ).

ENDFORM.




*---------------------------------------------------------------------*
*  FORM set_column_visibility_by_state
*---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  DATA lo_cols TYPE REF TO cl_salv_columns_table.
  DATA lo_col  TYPE REF TO cl_salv_column_table.

  TRY.
      lo_cols = lo_alv->get_columns( ).
    CATCH cx_salv_not_found.
      RETURN.
  ENDTRY.

  "------------------------------
  " Default: show all columns
  "------------------------------
  lo_cols->set_optimize( abap_true ).

  " Hide Long Text Columns depending on state
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.
    lo_cols->get_column( 'OP_LTXT' )->set_visible( abap_false ).
    lo_cols->get_column( 'CHAR_LTXT' )->set_visible( abap_false ).
  ENDIF.

  IF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
    lo_cols->get_column( 'CHAR_LTXT' )->set_visible( abap_false ).
  ENDIF.

  IF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
    lo_cols->get_column( 'OP_LTXT' )->set_visible( abap_false ).
    lo_cols->get_column( 'CHAR_LTXT' )->set_visible( abap_false ).
  ENDIF.

  IF gv_show_char = gc_true AND gv_show_ltxt = gc_true.
    " Both visible
  ENDIF.

ENDFORM.


*---------------------------------------------------------------------*
*  FORM set_pfstatus_from_state – Activate PF-STATUS from FDS rules
*---------------------------------------------------------------------*
FORM set_pfstatus_from_state.

  DATA lv_pf TYPE sypfkey.

  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.
    lv_pf = 'ZSALV_BOTH_HIDE'.    "Mode A
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
    lv_pf = 'ZSALV_LTXT_SHOW'.    "Mode C
  ELSEIF gv_show_char = gc_true  AND gv_show_ltxt = gc_false.
    lv_pf = 'ZSALV_CLIST_ONLY'.   "Mode B
  ELSE.
    lv_pf = 'ZSALV_CLIST_LTXT'.   "Mode D
  ENDIF.

  lo_alv->set_screen_status(
    pfstatus = lv_pf
    report   = sy-repid ).

ENDFORM.


*---------------------------------------------------------------------*
*  FORM set_title_from_state
*---------------------------------------------------------------------*
FORM set_title_from_state.

  DATA lv_title TYPE string.

  lv_title = 'A2R – Task List Validation Report'.

  IF gv_show_char = gc_true.
    lv_title = lv_title && ' | Characteristics Visible'.
  ENDIF.

  IF gv_show_ltxt = gc_true.
    lv_title = lv_title && ' | Long Text Visible'.
  ENDIF.

  SET TITLEBAR 'TITLE_100' WITH lv_title.

ENDFORM.


*---------------------------------------------------------------------*
*  EVENT HANDLER IMPLEMENTATION
*---------------------------------------------------------------------*
CLASS lcl_event_handler IMPLEMENTATION.

  METHOD on_user_command.

    CASE e_salv_function.

      WHEN gc_func_clist_s.        "Show Characteristics
        gv_show_char = gc_true.
        gv_show_ltxt = gc_false.

      WHEN gc_func_clist_h.        "Hide Characteristics
        gv_show_char = gc_false.
        gv_show_ltxt = gc_false.

      WHEN gc_func_ltxt_s.         "Show Long Text
        gv_show_ltxt = gc_true.

      WHEN gc_func_ltxt_h.         "Hide Long Text
        gv_show_ltxt = gc_false.

      WHEN OTHERS.
        RETURN.

    ENDCASE.

    " Refresh ALV content
    PERFORM build_display.
    PERFORM set_pfstatus_from_state.
    PERFORM set_title_from_state.
    PERFORM set_column_visibility_by_state.

    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.

ENDCLASS.