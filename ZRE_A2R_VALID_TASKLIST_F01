*---------------------------------------------------------------------*
* Include ZRE_A2R_VALID_TASKLIST_F01
*---------------------------------------------------------------------*

*---------------------------------------------------------------------*
* EVENT HANDLER IMPLEMENTATION
*---------------------------------------------------------------------*
CLASS lcl_event_handler IMPLEMENTATION.
  METHOD on_user_command.

    CASE e_salv_function.

      WHEN gc_func_clist_s.     "Show Characteristics
        gv_show_char = gc_true.
        gv_show_ltxt = gc_false.

      WHEN gc_func_clist_h.     "Hide Characteristics
        gv_show_char = gc_false.

      WHEN gc_func_ltxt_s.      "Show Long Text
        gv_show_char = gc_false.
        gv_show_ltxt = gc_true.

      WHEN gc_func_ltxt_h.      "Hide Long Text
        gv_show_ltxt = gc_false.

      WHEN OTHERS.
        RETURN.

    ENDCASE.

    PERFORM build_display.
    PERFORM set_pfstatus_from_state.

    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.
ENDCLASS.

*---------------------------------------------------------------------*
* Validate Selection
*---------------------------------------------------------------------*
FORM validate_selection.

  IF p_ftl IS INITIAL AND
     p_etl IS INITIAL AND
     p_gtl IS INITIAL.
    MESSAGE e398(00) WITH 'Select at least one Task List Type'.
  ENDIF.

  IF so_keydt-low IS INITIAL.
    MESSAGE e398(00) WITH 'Enter a key date'.
  ENDIF.

ENDFORM.

*---------------------------------------------------------------------*
* PF-STATUS DETERMINATION
*---------------------------------------------------------------------*
FORM set_pfstatus_from_state.

  DATA lv_pf TYPE sypfkey.

  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.
    lv_pf = 'ZSALV_BOTH_HIDE'.

  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
    lv_pf = 'ZSALV_LTXT_SHOW'.

  ELSE.
    lv_pf = 'ZSALV_CLIST_SHOW'.

  ENDIF.

  IF lo_alv IS BOUND.
    lo_funcs = lo_alv->get_functions( ).
    lo_alv->set_screen_status(
        pfstatus      = lv_pf
        report        = sy-repid
        set_functions = lo_funcs ).
  ENDIF.

ENDFORM.

*---------------------------------------------------------------------*
* Title update
*---------------------------------------------------------------------*
FORM set_title_from_state.

  DATA lv_title TYPE string.
  lv_title = 'Maintenance Task List Report'.

  IF gv_show_char = gc_true.
    lv_title = lv_title && ' - Characteristics Active'.
  ENDIF.

  IF gv_show_ltxt = gc_true.
    lv_title = lv_title && ' - Long Text Active'.
  ENDIF.

  SET TITLEBAR 'TITLE_100' WITH lv_title.

ENDFORM.

*---------------------------------------------------------------------*
* DISPLAY ALV FULL SCREEN (MAINTPLAN APPROACH)
*---------------------------------------------------------------------*
FORM display_alv.

  DATA lx TYPE REF TO cx_root.

  TRY.

      IF lo_alv IS INITIAL.

        cl_salv_table=>factory(
          IMPORTING
            r_salv_table = lo_alv
          CHANGING
            t_table      = gt_display ).

        lo_columns = lo_alv->get_columns( ).
        lo_columns->set_optimize( abap_true ).

        TRY.
            lo_column ?= lo_columns->get_column( 'ROW_KIND' ).
            lo_column->set_technical( abap_true ).
          CATCH cx_salv_not_found.
        ENDTRY.

        lo_disp = lo_alv->get_display_settings( ).
        lo_disp->set_striped_pattern( abap_true ).
        lo_disp->set_list_header( 'Valid Task Lists' ).

        lo_layout = lo_alv->get_layout( ).
        ls_layout_key-report = sy-repid.
        lo_layout->set_key( ls_layout_key ).
        lo_layout->set_default( abap_true ).

        lo_funcs = lo_alv->get_functions( ).
        lo_funcs->set_all( abap_true ).

        lo_events = lo_alv->get_event( ).
        SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

      ELSE.
        lo_alv->refresh( ).
      ENDIF.

      PERFORM set_pfstatus_from_state.
      lo_alv->display( ).

    CATCH cx_root INTO lx.
      MESSAGE lx->get_text( ) TYPE 'E'.
  ENDTRY.

ENDFORM.

*---------------------------------------------------------------------*
* BUILD_DISPLAY – SAME AS YOUR ORIGINAL (NOT REPEATED)
*---------------------------------------------------------------------*
" KEEP YOUR COMPLETE BUILD_DISPLAY CODE AS IS.
" KEEP YOUR append_op_longtext / append_char_longtext AS IS.

*---------------------------------------------------------------------*
* USER COMMAND (ONLY FOR BACK / EXIT / REFRESH)
*---------------------------------------------------------------------*
MODULE user_command_0100 INPUT.

  CASE sy-ucomm.

    WHEN 'REFRESH'.
      PERFORM build_display.
      IF lo_alv IS BOUND.
        lo_alv->refresh( ).
      ENDIF.

    WHEN '&F03' OR '&F12' OR '&F15'.
      LEAVE TO SCREEN 0.

  ENDCASE.

ENDMODULE.







aaaaaaaaa



CLASS lcl_event_handler IMPLEMENTATION.
  METHOD on_user_command.

    CASE e_salv_function.

      "---------------------------------------------------------------
      " Show Characteristics
      " - Switch to operation + characteristics
      " - Long text goes back to default (off)
      "---------------------------------------------------------------
      WHEN gc_func_clist_s.     " &CLISTS
        gv_show_char = gc_true.
        gv_show_ltxt = gc_false.

      "---------------------------------------------------------------
      " Hide Characteristics
      " - Back to operations only
      " - Long text also reset (off)
      "---------------------------------------------------------------
      WHEN gc_func_clist_h.     " &CLISTH
        gv_show_char = gc_false.
        gv_show_ltxt = gc_false.

      "---------------------------------------------------------------
      " Show Long Text
      " - If gv_show_char = abap_false  → show operation long texts
      " - If gv_show_char = abap_true   → show characteristic long texts
      " (the distinction is handled inside BUILD_DISPLAY)
      "---------------------------------------------------------------
      WHEN gc_func_ltxt_s.      " &LTXTS
        gv_show_ltxt = gc_true.

      "---------------------------------------------------------------
      " Hide Long Text
      "---------------------------------------------------------------
      WHEN gc_func_ltxt_h.      " &LTXTH
        gv_show_ltxt = gc_false.

      WHEN OTHERS.
        RETURN.

    ENDCASE.

    " Rebuild data and refresh ALV / PF-STATUS / title
    PERFORM build_display.
    PERFORM set_pfstatus_from_state.
    PERFORM set_title_from_state.

    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.
ENDCLASS.






*&---------------------------------------------------------------------*
*& Form build_display
*&---------------------------------------------------------------------*
*  - Builds GT_DISPLAY based on GT_BASE and flags:
*      gv_show_char, gv_show_ltxt
*  - Always 1 operation row per operation (ROW_KIND = 'O')
*  - If gv_show_char = space:
*      - No characteristic rows
*      - If gv_show_ltxt = 'X' → show OPERATION long texts only
*  - If gv_show_char = 'X':
*      - Show characteristic rows
*      - If gv_show_ltxt = 'X' → show CHARACTERISTIC long texts
*        (NOT operation long texts) – as per FDS
*&---------------------------------------------------------------------*
FORM build_display.

  DATA: lv_last_plnty TYPE plko-plnty,
        lv_last_plnnr TYPE plko-plnnr,
        lv_last_plnal TYPE plko-plnal,
        lv_last_vornr TYPE plpo-vornr.

  CLEAR gt_display.
  CLEAR gs_display.
  CLEAR: lv_last_plnty, lv_last_plnnr, lv_last_plnal, lv_last_vornr.

  LOOP AT gt_base INTO gs_base.

    "---------------------------------------------------------------*
    " 1) Operation row – only when operation key changes
    "---------------------------------------------------------------*
    IF gs_base-plnty <> lv_last_plnty OR
       gs_base-plnnr <> lv_last_plnnr OR
       gs_base-plnal <> lv_last_plnal OR
       gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.

      " Derive CI indicators (from STEUERKZ) if relevant
      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      "Remember last operation key
      lv_last_plnty = gs_base-plnty.
      lv_last_plnnr = gs_base-plnnr.
      lv_last_plnal = gs_base-plnal.
      lv_last_vornr = gs_base-vornr.

      "-----------------------------------------------------------*
      " Operation long text (FDS: only in operations-only mode)
      " - gv_show_char = space  → ops-only view
      " - gv_show_ltxt = 'X'    → long text ON
      "-----------------------------------------------------------*
      IF gv_show_char = gc_false
         AND gv_show_ltxt = gc_true
         AND gs_base-txtsp_op IS NOT INITIAL.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

    ENDIF.

    "---------------------------------------------------------------*
    " 2) Characteristics (FDS: only when Show Characteristics = YES)
    "---------------------------------------------------------------*
    IF gv_show_char = gc_true
       AND gs_base-merknr IS NOT INITIAL.

      "Characteristic row
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      "-----------------------------------------------------------*
      " Characteristic long text (FDS: only in char-mode + long text)
      " - gv_show_char = 'X'    → characteristics view
      " - gv_show_ltxt = 'X'    → long text ON
      "-----------------------------------------------------------*
      IF gs_base-ltextkz IS NOT INITIAL
         AND gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.





*---------------------------------------------------------------------*
* Display ALV – Column alignment to FDS mock-up
*---------------------------------------------------------------------*
FORM display_alv.

  DATA lx TYPE REF TO cx_root.

  TRY.

      "Create SALV if first run
      IF lo_alv IS INITIAL.

        cl_salv_table=>factory(
          IMPORTING
            r_salv_table = lo_alv
          CHANGING
            t_table      = gt_display ).

        lo_columns = lo_alv->get_columns( ).
        lo_columns->set_optimize( abap_true ).

        "-------------------------------------------------------------------*
        " 1. Hide technical columns
        "-------------------------------------------------------------------*
        PERFORM hide_column USING 'ROW_KIND'.
        PERFORM hide_column USING 'TDFORMAT'.
        PERFORM hide_column USING 'TDLINE'.

        "-------------------------------------------------------------------*
        " 2. Set final column order from FDS
        "-------------------------------------------------------------------*
        PERFORM set_position USING 'PLNNR'      1.   "Group
        PERFORM set_position USING 'PLNAL'      2.   "Counter
        PERFORM set_position USING 'WERKS'      3.   "Plant
        PERFORM set_position USING 'VORNR'      4.   "Operation
        PERFORM set_position USING 'OP_LTXT'    5.   "Operation Long Text
        PERFORM set_position USING 'ARBPL_O'    6.   "Work Center
        PERFORM set_position USING 'ARBEI'      7.   "Work
        PERFORM set_position USING 'KURZT_CHAR' 8.   "Insp. # Description
        PERFORM set_position USING 'PMETHODE'   9.   "Insp Method
        PERFORM set_position USING 'CHAR_LTXT' 10.   "Char Long Text

        "-------------------------------------------------------------------*
        " 3. Rename columns – FDS-compliant names
        "-------------------------------------------------------------------*
        PERFORM rename_column USING 'PLNNR'      'Group'.
        PERFORM rename_column USING 'PLNAL'      'Counter'.
        PERFORM rename_column USING 'WERKS'      'Plant'.
        PERFORM rename_column USING 'VORNR'      'Operation'.
        PERFORM rename_column USING 'OP_LTXT'    'Op Long Text'.
        PERFORM rename_column USING 'ARBPL_O'    'Work Center'.
        PERFORM rename_column USING 'ARBEI'      'Work'.
        PERFORM rename_column USING 'KURZT_CHAR' 'Insp. Description'.
        PERFORM rename_column USING 'PMETHODE'   'Insp. Method'.
        PERFORM rename_column USING 'CHAR_LTXT'  'Char Long Text'.

        "Display settings
        lo_disp = lo_alv->get_display_settings( ).
        lo_disp->set_striped_pattern( abap_true ).
        lo_disp->set_list_header( 'Valid Task Lists' ).

        lo_layout = lo_alv->get_layout( ).
        ls_layout_key-report = sy-repid.
        lo_layout->set_key( ls_layout_key ).
        lo_layout->set_default( abap_true ).

        lo_funcs = lo_alv->get_functions( ).
        lo_funcs->set_all( abap_true ).

        lo_events = lo_alv->get_event( ).
        SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

      ELSE.
        lo_alv->refresh( ).
      ENDIF.

      PERFORM set_pfstatus_from_state.
      lo_alv->display( ).

    CATCH cx_root INTO lx.
      MESSAGE lx->get_text( ) TYPE 'E'.
  ENDTRY.

ENDFORM.





*---------------------------------------------------------------------*
* Hide column helper
*---------------------------------------------------------------------*
FORM hide_column USING pv_col TYPE lvc_fname.
  TRY.
      lo_column ?= lo_columns->get_column( pv_col ).
      lo_column->set_technical( abap_true ).
    CATCH cx_salv_not_found.
  ENDTRY.
ENDFORM.

*---------------------------------------------------------------------*
* Set position helper
*---------------------------------------------------------------------*
FORM set_position USING pv_col TYPE lvc_fname
                        pv_pos TYPE i.
  TRY.
      lo_column ?= lo_columns->get_column( pv_col ).
      lo_column->set_position( pv_pos ).
    CATCH cx_salv_not_found.
  ENDTRY.
ENDFORM.

*---------------------------------------------------------------------*
* Rename column helper
*---------------------------------------------------------------------*
FORM rename_column USING pv_col TYPE lvc_fname
                          pv_text TYPE string.
  TRY.
      lo_column ?= lo_columns->get_column( pv_col ).
      lo_column->set_long_text( pv_text ).
      lo_column->set_short_text( pv_text ).
      lo_column->set_medium_text( pv_text ).
    CATCH cx_salv_not_found.
  ENDTRY.
ENDFORM.






