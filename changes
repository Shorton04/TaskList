*---------------------------------------------------------------------*
*  FORM set_column_visibility_by_state - Enhanced Version (Safe)
*---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  DATA lo_columns TYPE REF TO cl_salv_columns_table.
  DATA lo_col     TYPE REF TO cl_salv_column_table.
  DATA lv_idx     TYPE i.
  DATA lv_name    TYPE char10.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  lo_columns = lo_alv->get_columns( ).

  " Helper macro: show column
  DEFINE show_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_technical( abap_false ).
        lo_col->set_visible(   abap_true  ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  " Helper macro: hide column
  DEFINE hide_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_technical( abap_true ).
        lo_col->set_visible(   abap_false ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.


  "==============================================================
  " 1. ALWAYS HIDE GHOST / NON-FDS COLUMNS
  "==============================================================

  "--- Hide STATUS fields completely ---
  hide_col 'STAT_H'.
  hide_col 'STATUS'.
  hide_col 'STATS'.

  "--- Hide CI1..CI28 (your system needs CONCATENATE) ---
  DO 28 TIMES.
    lv_idx = sy-index.
    CONCATENATE 'CI' lv_idx INTO lv_name.
    hide_col lv_name.
  ENDDO.

  "--- Hide internal / tech fields ---
  hide_col 'ROW_KIND'.
  hide_col 'DATUV'.
  hide_col 'VALID_TO'.
  hide_col 'DATUV_O'.
  hide_col 'VALID_TO_O'.
  hide_col 'GUELTIGAB'.
  hide_col 'VALID_TO_C'.
  hide_col 'LOEKZ_H'.
  hide_col 'LOEKZ_O'.
  hide_col 'LOEKZ_C'.

  "--- Hide header fields not in FDS ---
  hide_col 'PLNTY'.
  hide_col 'KTEXT'.
  hide_col 'TPLNR'.
  hide_col 'EQUNR'.
  hide_col 'VERWE'.
  hide_col 'VAGRP'.
  hide_col 'ANLZU_H'.
  hide_col 'STRAT'.
  hide_col 'ISTRU_H'.
  hide_col 'ADPSP'.
  hide_col 'SLWBEZ'.
  hide_col 'ANDAT'.
  hide_col 'ANNAM'.
  hide_col 'AEDAT'.
  hide_col 'AENAM'.

  "--- Hide operation-level columns not in FDS ---
  hide_col 'PLNKN'.
  hide_col 'ZAEHL'.
  hide_col 'STEUS'.
  hide_col 'WERKS_O'.       "We only show main plant and work center
  hide_col 'KTSCH'.
  hide_col 'ARBEH'.
  hide_col 'DAUNO'.
  hide_col 'DAUNE'.
  hide_col 'KALID'.
  hide_col 'EXECUTION_STAGE'.
  hide_col 'ANLZU_O'.
  hide_col 'ISTRU_O'.
  hide_col 'LARNT'.
  hide_col 'EBELN'.
  hide_col 'EBELP'.
  hide_col 'LIFNR'.
  hide_col 'PREIS'.
  hide_col 'WAERS'.
  hide_col 'SAKTO'.
  hide_col 'EKORG'.
  hide_col 'EKGRP'.
  hide_col 'TXTSP_OP'.

  "--- Hide characteristic fields not in FDS ---
  hide_col 'VERWMERKM'.
  hide_col 'LTEXTKZ'.
  hide_col 'TOLERANZUN'.
  hide_col 'TOLERANZOB'.
  hide_col 'PRUEFEINH'.
  hide_col 'STICHPRVER'.
  hide_col 'KATALGART1'.
  hide_col 'AUSWMENGE1'.
  hide_col 'STEUERKZ'.


  "==============================================================
  " 2. MODE-BASED COLUMNS (your original CASE A/B/C/D)
  "==============================================================

  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.
      "CASE A – No Characteristics, No Long Text
      hide_col 'TDFORMAT'.
      hide_col 'OP_LTXT'.
      hide_col 'CHAR_LTXT'.

  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
      "CASE B – Characteristics only
      hide_col 'TDFORMAT'.
      hide_col 'OP_LTXT'.
      hide_col 'CHAR_LTXT'.

  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
      "CASE C – Long Text only
      show_col 'TDFORMAT'.
      show_col 'OP_LTXT'.
      hide_col 'CHAR_LTXT'.

  ELSE.
      "CASE D – Char + Long Text
      show_col 'TDFORMAT'.
      hide_col 'OP_LTXT'.
      show_col 'CHAR_LTXT'.

  ENDIF.

  "==============================================================
  " 3. COLUMN ORDER (using SET_SEQUENCE for compatibility)
  "==============================================================

  "-------------- CASE C: Hide Characteristics + Show Long Text --------------
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

    seq 'PLNNR'        1.   "Group
    seq 'PLNAL'        2.   "Counter
    seq 'WERKS'        3.   "Plant
    seq 'VORNR'        4.   "Operation
    seq 'TDFORMAT'     5.   "FK
    seq 'OP_LTXT'      6.   "Op Long Text
    seq 'ARBPL_O'      7.   "Work Center
    seq 'ARBEI'        8.   "Work
    seq 'KURZT_CHAR'   9.   "Description
    seq 'PMETHODE'    10.   "Inspection Method
    seq 'MERKNR'      11.   "Inspection Number
    seq 'CHAR_LTXT'   12.   "Characteristic Long Text

    RETURN.
  ENDIF.


  "-------------- CASE D: Show Characteristics + Show Long Text --------------
  IF gv_show_char = gc_true AND gv_show_ltxt = gc_true.

    seq 'PLNNR'        1.   "Group
    seq 'PLNAL'        2.   "Counter
    seq 'WERKS'        3.   "Plant
    seq 'VORNR'        4.   "Operation
    seq 'ARBPL_O'      5.   "Work Center
    seq 'ARBEI'        6.   "Work
    seq 'KURZT_CHAR'   7.   "Description
    seq 'PMETHODE'     8.   "Inspection Method
    seq 'MERKNR'       9.   "Inspection Number
    seq 'TDFORMAT'    10.   "FK
    seq 'OP_LTXT'     11.   "Op Long Text
    seq 'CHAR_LTXT'   12.   "Characteristic Long Text

    RETURN.
  ENDIF.
ENDFORM.

