*&---------------------------------------------------------------------*
*& Form build_display (UPDATED)
*&---------------------------------------------------------------------*
FORM build_display.

  DATA: ls_base        TYPE ty_task_base,
        ls_disp        TYPE ty_task_disp,
        lv_last_op_key TYPE string,
        lv_curr_op_key TYPE string,
        lv_last_char   TYPE plmk-merknr.

  CLEAR: gt_display, lv_last_op_key, lv_last_char.

  SORT gt_base BY plnty plnnr plnal vornr merknr.

  LOOP AT gt_base INTO ls_base.

    CONCATENATE ls_base-plnty ls_base-plnnr ls_base-plnal ls_base-vornr INTO lv_curr_op_key.

    "======================================================*
    " 1. OPERATION HEADER ROW (ALWAYS EXACTLY ONCE)
    "======================================================*
    IF lv_curr_op_key <> lv_last_op_key.

      CLEAR ls_disp.
      MOVE-CORRESPONDING ls_base TO ls_disp.
      ls_disp-row_kind = 'O'.
      APPEND ls_disp TO gt_display.

      lv_last_char = ''.

      "If LT-only → append operation long text
      IF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
        PERFORM append_op_longtext USING ls_base.
      ENDIF.

      lv_last_op_key = lv_curr_op_key.

    ENDIF.

    "======================================================*
    " 2. CHARACTERISTICS HEADER ROWS (Show Char Only)
    "======================================================*
    IF gv_show_char = gc_true AND ls_base-merknr IS NOT INITIAL.

      "Header only once per characteristic
      IF ls_base-merknr <> lv_last_char.

        CLEAR ls_disp.
        MOVE-CORRESPONDING ls_base TO ls_disp.
        ls_disp-row_kind = 'C'.
        APPEND ls_disp TO gt_display.

        lv_last_char = ls_base-merknr.

      ENDIF.

      "Char long text only in Char + LT mode
      IF gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING ls_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

  PERFORM adjust_display_fields_by_state.

ENDFORM.




*&---------------------------------------------------------------------*
*& Form ADJUST_DISPLAY_FIELDS_BY_STATE (UPDATED)
*&---------------------------------------------------------------------*
FORM adjust_display_fields_by_state.

  FIELD-SYMBOLS <ls> TYPE ty_task_disp.

  LOOP AT gt_display ASSIGNING <ls>.

    "======================================================*
    " MODE A – NO CHAR / NO LT
    "======================================================*
    IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

      CLEAR: <ls>-tdformat,
             <ls>-op_ltxt,
             <ls>-char_ltxt.

      IF <ls>-row_kind = 'O'.
        CLEAR: <ls>-merknr,
               <ls>-kurzt_char.
      ENDIF.

    "======================================================*
    " MODE B – CHAR ONLY
    "======================================================*
    ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.

      CLEAR: <ls>-tdformat,
             <ls>-op_ltxt,
             <ls>-char_ltxt.

    "======================================================*
    " MODE C – LT ONLY (NO CHARACTERISTICS)
    "======================================================*
    ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

      CLEAR: <ls>-merknr,
             <ls>-kurzt_char,
             <ls>-pmethode,
             <ls>-char_ltxt.

      "OP long text rows keep:
      "  TDFormat + OP_LTXT
      "Characteristic rows do not exist in this mode.

    "======================================================*
    " MODE D – CHAR + LT
    "======================================================*
    ELSE.

      "Characteristic LT stays
      "Operation LT must be cleared
      IF <ls>-row_kind <> 'L' OR <ls>-char_ltxt IS NOT INITIAL.
        CLEAR <ls>-op_ltxt.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.







*&---------------------------------------------------------------------*
*& Form set_column_visibility_by_state (UPDATED)
*&---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  DATA lo_columns TYPE REF TO cl_salv_columns_table.
  DATA lo_col     TYPE REF TO cl_salv_column_table.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  lo_columns = lo_alv->get_columns( ).

  " Helper
  DEFINE show_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_visible( abap_true ).
        lo_col->set_technical( abap_false ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE hide_col.
    TRY.
        lo_col ?= lo_columns->get_column( &1 ).
        lo_col->set_visible( abap_false ).
        lo_col->set_technical( abap_true ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  "======================================================*
  " MODE A – NO CHAR / NO LT
  "======================================================*
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

    hide_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.

  "======================================================*
  " MODE B – CHAR ONLY
  "======================================================*
  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.

    hide_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.

  "======================================================*
  " MODE C – LT ONLY (Hide Char + Show LT)
  "   FK + OP_LTXT must be positioned RIGHT AFTER OPERATION
  "======================================================*
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

    show_col 'TDFORMAT'.
    show_col 'OP_LTXT'.
    hide_col 'CHAR_LTXT'.

    "Position:
    PERFORM set_position USING 'TDFORMAT' 5.   "After Op
    PERFORM set_position USING 'OP_LTXT'  6.

  "======================================================*
  " MODE D – CHAR + LT
  "   FK + CHAR_LTXT at the last (after Insp Meth)
  "======================================================*
  ELSE.

    show_col 'TDFORMAT'.
    hide_col 'OP_LTXT'.
    show_col 'CHAR_LTXT'.

    "Position:
    PERFORM set_position USING 'TDFORMAT'   10.
    PERFORM set_position USING 'CHAR_LTXT'  11.

  ENDIF.

ENDFORM.




*&---------------------------------------------------------------------*
*& Form TOGGLE_CHAR  (FINAL)
*&---------------------------------------------------------------------*
FORM toggle_char.

  " Flip characteristic display state
  IF gv_show_char = gc_true.
    gv_show_char = gc_false.
  ELSE.
    gv_show_char = gc_true.
  ENDIF.

  " Always rebuild from clean base
  CLEAR gt_display.

  PERFORM build_display.
  PERFORM set_column_visibility_by_state.
  PERFORM set_title_from_state.
  PERFORM set_pfstatus_from_state.

  IF lo_alv IS BOUND.
    lo_alv->refresh( ).
  ENDIF.

ENDFORM.





*&---------------------------------------------------------------------*
*& Form TOGGLE_LTXT  (FINAL)
*&---------------------------------------------------------------------*
FORM toggle_ltxt.

  " Flip long text display state
  IF gv_show_ltxt = gc_true.
    gv_show_ltxt = gc_false.
  ELSE.
    gv_show_ltxt = gc_true.
  ENDIF.

  " Rebuild from clean state
  CLEAR gt_display.

  PERFORM build_display.
  PERFORM set_column_visibility_by_state.
  PERFORM set_title_from_state.
  PERFORM set_pfstatus_from_state.

  IF lo_alv IS BOUND.
    lo_alv->refresh( ).
  ENDIF.

ENDFORM.