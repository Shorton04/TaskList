*---------------------------------------------------------------------*
*  FORM set_column_visibility_by_state - FINAL (COMPATIBLE VERSION)
*---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  DATA lo_cols TYPE REF TO cl_salv_columns_table.
  DATA lo_col  TYPE REF TO cl_salv_column_table.
  DATA lv_ci   TYPE char05.
  DATA lv_idx  TYPE i.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  lo_cols = lo_alv->get_columns( ).

  "--------------------------------------------
  " Helper macros (no string templates)
  "--------------------------------------------
  DEFINE hide_col.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_visible( abap_false ).
        lo_col->set_technical( abap_true ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE show_col.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_visible( abap_true ).
        lo_col->set_technical( abap_false ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE seq.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_sequence( &2 ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.


  "--------------------------------------------
  " 1. HIDE ALL UNWANTED / TECH FIELDS
  "--------------------------------------------

  hide_col 'STAT_H'.
  hide_col 'STATUS'.
  hide_col 'STATS'.

  hide_col 'ROW_KIND'.
  hide_col 'DATUV'.
  hide_col 'VALID_TO'.
  hide_col 'DATUV_O'.
  hide_col 'VALID_TO_O'.
  hide_col 'GUELTIGAB'.
  hide_col 'VALID_TO_C'.
  hide_col 'LOEKZ_H'.
  hide_col 'LOEKZ_O'.
  hide_col 'LOEKZ_C'.

  "Hide CI1â€“CI28 (no string template!)
  DO 28 TIMES.
    lv_idx = sy-index.
    CONCATENATE 'CI' lv_idx INTO lv_ci.
    hide_col lv_ci.
  ENDDO.

  "HEADER FIELDS
  hide_col 'PLNTY'.
  hide_col 'KTEXT'.
  hide_col 'TPLNR'.
  hide_col 'EQUNR'.
  hide_col 'VERWE'.
  hide_col 'VAGRP'.
  hide_col 'ANLZU_H'.
  hide_col 'STRAT'.
  hide_col 'ISTRU_H'.
  hide_col 'ADPSP'.
  hide_col 'SLWBEZ'.
  hide_col 'ANDAT'.
  hide_col 'ANNAM'.
  hide_col 'AEDAT'.
  hide_col 'AENAM'.

  "OPERATION FIELDS
  hide_col 'PLNKN'.
  hide_col 'ZAEHL'.
  hide_col 'STEUS'.
  hide_col 'WERKS_O'.
  hide_col 'KTSCH'.
  hide_col 'ARBEH'.
  hide_col 'DAUNO'.
  hide_col 'DAUNE'.
  hide_col 'KALID'.
  hide_col 'EXECUTION_STAGE'.
  hide_col 'ANLZU_O'.
  hide_col 'ISTRU_O'.
  hide_col 'LARNT'.
  hide_col 'EBELN'.
  hide_col 'EBELP'.
  hide_col 'LIFNR'.
  hide_col 'PREIS'.
  hide_col 'WAERS'.
  hide_col 'SAKTO'.
  hide_col 'EKORG'.
  hide_col 'EKGRP'.
  hide_col 'TXTSP_OP'.

  "CHARACTERISTIC FIELDS
  hide_col 'VERWMERKM'.
  hide_col 'LTEXTKZ'.
  hide_col 'TOLERANZUN'.
  hide_col 'TOLERANZOB'.
  hide_col 'PRUEFEINH'.
  hide_col 'STICHPRVER'.
  hide_col 'KATALGART1'.
  hide_col 'AUSWMENGE1'.
  hide_col 'STEUERKZ'.


  "--------------------------------------------
  " 2. SHOW ONLY FDS-APPROVED FIELDS
  "--------------------------------------------
  show_col 'PLNNR'.
  show_col 'PLNAL'.
  show_col 'WERKS'.
  show_col 'VORNR'.
  show_col 'ARBPL_O'.
  show_col 'ARBEI'.
  show_col 'KURZT_CHAR'.
  show_col 'PMETHODE'.
  show_col 'MERKNR'.
  show_col 'TDFORMAT'.
  show_col 'OP_LTXT'.
  show_col 'CHAR_LTXT'.


  "--------------------------------------------
  " 3. COLUMN ORDER (using SET_SEQUENCE)
  "--------------------------------------------

  IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.

    "Mode 1: Hide characteristics + show long text
    seq 'PLNNR'      1.
    seq 'PLNAL'      2.
    seq 'WERKS'      3.
    seq 'VORNR'      4.
    seq 'TDFORMAT'   5.
    seq 'OP_LTXT'    6.
    seq 'ARBPL_O'    7.
    seq 'ARBEI'      8.
    seq 'KURZT_CHAR' 9.
    seq 'PMETHODE'  10.
    seq 'MERKNR'    11.
    seq 'CHAR_LTXT' 12.

  ELSEIF gv_show_char = abap_true AND gv_show_ltxt = abap_true.

    "Mode 2: Show characteristics + show long text
    seq 'PLNNR'      1.
    seq 'PLNAL'      2.
    seq 'WERKS'      3.
    seq 'VORNR'      4.
    seq 'ARBPL_O'    5.
    seq 'ARBEI'      6.
    seq 'KURZT_CHAR' 7.
    seq 'PMETHODE'   8.
    seq 'MERKNR'     9.
    seq 'TDFORMAT'  10.
    seq 'OP_LTXT'   11.
    seq 'CHAR_LTXT' 12.

  ENDIF.

ENDFORM.