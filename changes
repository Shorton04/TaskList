*&---------------------------------------------------------------------*
*& Form CLEANUP_DUPLICATES
*&  - Remove duplicate header rows when Long Text is active
*&---------------------------------------------------------------------*
FORM cleanup_duplicates.

  FIELD-SYMBOLS: <ls_disp> TYPE ty_task_disp.

  DATA: lt_op    TYPE STANDARD TABLE OF ty_task_disp,
        lt_char  TYPE STANDARD TABLE OF ty_task_disp,
        lt_ltxt  TYPE STANDARD TABLE OF ty_task_disp.

  " Only needed when Long Text is shown
  IF gv_show_ltxt = gc_false.
    RETURN.
  ENDIF.

  " Split GT_DISPLAY into O / C / L buckets
  LOOP AT gt_display ASSIGNING <ls_disp>.
    CASE <ls_disp>-row_kind.
      WHEN 'O'.
        APPEND <ls_disp> TO lt_op.
      WHEN 'C'.
        APPEND <ls_disp> TO lt_char.
      WHEN 'L'.
        APPEND <ls_disp> TO lt_ltxt.
      WHEN OTHERS.
        " Treat any unknown kind like a header row
        APPEND <ls_disp> TO lt_op.
    ENDCASE.
  ENDLOOP.

  CLEAR gt_display.

  "-----------------------------------------------------------*
  " Case C: Hide Char / Show LT
  "   → one operation row per op + all LT rows
  "-----------------------------------------------------------*
  IF gv_show_char = gc_false.

    SORT lt_op BY plnty plnnr plnal vornr.
    DELETE ADJACENT DUPLICATES FROM lt_op
      COMPARING plnty plnnr plnal vornr.

    APPEND LINES OF lt_op   TO gt_display.
    APPEND LINES OF lt_ltxt TO gt_display.

  "-----------------------------------------------------------*
  " Case D: Show Char / Show LT
  "   → one char row per characteristic + all LT rows
  "-----------------------------------------------------------*
  ELSE.

    SORT lt_char BY plnty plnnr plnal vornr merknr.
    DELETE ADJACENT DUPLICATES FROM lt_char
      COMPARING plnty plnnr plnal vornr merknr.

    APPEND LINES OF lt_char TO gt_display.
    APPEND LINES OF lt_ltxt TO gt_display.

  ENDIF.

ENDFORM.