*&---------------------------------------------------------------------*
*& Form BUILD_DISPLAY
*&---------------------------------------------------------------------*
FORM build_display.

  DATA: lv_last_plnty TYPE plko-plnty,
        lv_last_plnnr TYPE plko-plnnr,
        lv_last_plnal TYPE plko-plnal,
        lv_last_vornr TYPE plpo-vornr.

  CLEAR gt_display.
  CLEAR gs_display.

  CLEAR: lv_last_plnty,
         lv_last_plnnr,
         lv_last_plnal,
         lv_last_vornr.

  " Make sure we loop in a stable key order
  SORT gt_base BY plnty plnnr plnal vornr merknr.

  LOOP AT gt_base INTO gs_base.

    "-----------------------------------------------------------*
    " 1) Operation row – only when operation key changes
    "-----------------------------------------------------------*
    IF     gs_base-plnty <> lv_last_plnty
       OR  gs_base-plnnr <> lv_last_plnnr
       OR  gs_base-plnal <> lv_last_plnal
       OR  gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.              " Operation row

      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      " Operation long text only when:
      "   - Long Text = ON
      "   - Show Characteristics = OFF (level = Operations per FDS)
      IF gv_show_ltxt = gc_true
         AND gv_show_char <> gc_true.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

      " Remember last operation key
      lv_last_plnty = gs_base-plnty.
      lv_last_plnnr = gs_base-plnnr.
      lv_last_plnal = gs_base-plnal.
      lv_last_vornr = gs_base-vornr.

    ENDIF.

    "-----------------------------------------------------------*
    " 2) Characteristic row + char long text (under operation)
    "-----------------------------------------------------------*
    IF gv_show_char = gc_true
       AND gs_base-merknr IS NOT INITIAL.

      " Characteristic “header” row
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      " Characteristic long text only when:
      "   - Show Characteristics = ON
      "   - Long Text = ON (level = Characteristics per FDS)
      IF gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

  PERFORM adjust_display_fields_by_state.

ENDFORM.






*&---------------------------------------------------------------------*
*& Form ADJUST_DISPLAY_FIELDS_BY_STATE
*&---------------------------------------------------------------------*
FORM adjust_display_fields_by_state.

  FIELD-SYMBOLS: <ls_disp> TYPE ty_task_disp.

  LOOP AT gt_display ASSIGNING <ls_disp>.

    "-------------------------------------------------------------*
    " CASE A:
    "   Show Char = No
    "   Show Long Text = No
    "   → Operation rows only
    "   → FK / long texts hidden separately in SET_COLUMN_VIS...
    "   → Insp# + Description blank on op rows, Method shown
    "-------------------------------------------------------------*
    IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

      IF <ls_disp>-row_kind = 'O'.
        CLEAR: <ls_disp>-merknr,      " Insp#
               <ls_disp>-kurzt_char.  " Description
        " PMETHODE remains filled (PM1 etc.), per FDS
      ENDIF.

    "-------------------------------------------------------------*
    " CASE B:
    "   Show Char = Yes
    "   Show Long Text = No
    "   → Operation rows + characteristic rows
    "   → No long-text rows
    "   → All characteristic fields (MERKNR, DESC, METHOD) shown
    "-------------------------------------------------------------*
    ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
      "No data changes; just keep what BUILD_DISPLAY created

    "-------------------------------------------------------------*
    " CASE C:
    "   Show Char = No
    "   Show Long Text = Yes
    "   → Operation rows + operation long-text rows
    "   → FK + OP_LTXT visible, CHAR_LTXT hidden
    "   → Insp#, Description, Method must be blank
    "-------------------------------------------------------------*
    ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

      IF     <ls_disp>-row_kind = 'O'
         OR  <ls_disp>-row_kind = 'L'. "op long-text rows

        CLEAR: <ls_disp>-merknr,      " Insp#
               <ls_disp>-kurzt_char,  " Description
               <ls_disp>-pmethode.    " Inspection Method
      ENDIF.

    "-------------------------------------------------------------*
    " CASE D:
    "   Show Char = Yes
    "   Show Long Text = Yes
    "   → Operation rows + characteristic rows + char long-text rows
    "   → FK + CHAR_LTXT visible, OP_LTXT hidden
    "   → All Insp fields kept
    "-------------------------------------------------------------*
    ELSE.
      " No data-level changes

    ENDIF.

  ENDLOOP.

ENDFORM.





*&---------------------------------------------------------------------*
*& Form DISPLAY_ALV
*&---------------------------------------------------------------------*
FORM display_alv.

  DATA: lx_salv_ex  TYPE REF TO cx_root,
        lx_salv_msg TYPE REF TO cx_salv_msg.

  IF gt_display IS INITIAL.
    MESSAGE s398(00) WITH 'No data to display'.
    RETURN.
  ENDIF.

  TRY.

      " Create SALV only once
      IF lo_alv IS INITIAL.

        cl_salv_table=>factory(
          IMPORTING
            r_salv_table = lo_alv
          CHANGING
            t_table      = gt_display ).

        " Columns handling
        lo_columns = lo_alv->get_columns( ).
        lo_columns->set_optimize( abap_true ).

        "-----------------------------------------------------------*
        " Hide columns that are NOT in the FDS visible list
        "-----------------------------------------------------------*

        " Technical
        PERFORM hide_column USING 'ROW_KIND'.

        " Header to hide
        PERFORM hide_column USING 'PLNTY'.
        PERFORM hide_column USING 'DATUV'.
        PERFORM hide_column USING 'KTEXT'.
        PERFORM hide_column USING 'TPLNR'.
        PERFORM hide_column USING 'EQUNR'.
        PERFORM hide_column USING 'VERWE'.
        PERFORM hide_column USING 'VAGRP'.
        PERFORM hide_column USING 'STAT_H'.
        PERFORM hide_column USING 'ANLZU_H'.
        PERFORM hide_column USING 'STRAT'.
        PERFORM hide_column USING 'ISTRU_H'.
        PERFORM hide_column USING 'ADPSP'.
        PERFORM hide_column USING 'SLWBEZ'.
        PERFORM hide_column USING 'LOEKZ_H'.
        PERFORM hide_column USING 'ANDAT'.
        PERFORM hide_column USING 'ANNAM'.
        PERFORM hide_column USING 'AEDAT'.
        PERFORM hide_column USING 'AENAM'.

        " Operation to hide (keep VORNR, ARBPL_O, ARBEI)
        PERFORM hide_column USING 'LTXA1'.
        PERFORM hide_column USING 'STEUS'.
        PERFORM hide_column USING 'WERKS_O'.
        PERFORM hide_column USING 'KTSCH'.
        PERFORM hide_column USING 'ARBEH'.
        PERFORM hide_column USING 'DAUNO'.
        PERFORM hide_column USING 'DAUNE'.
        PERFORM hide_column USING 'KALID'.
        PERFORM hide_column USING 'EXECUTION_STAGE'.
        PERFORM hide_column USING 'ANLZU_O'.
        PERFORM hide_column USING 'ISTRU_O'.
        PERFORM hide_column USING 'LARNT'.
        PERFORM hide_column USING 'EBELN'.
        PERFORM hide_column USING 'EBELP'.
        PERFORM hide_column USING 'LIFNR'.
        PERFORM hide_column USING 'PREIS'.
        PERFORM hide_column USING 'WAERS'.
        PERFORM hide_column USING 'SAKTO'.
        PERFORM hide_column USING 'EKORG'.
        PERFORM hide_column USING 'EKGRP'.
        PERFORM hide_column USING 'TXTSP_OP'.
        PERFORM hide_column USING 'LOEKZ_O'.

        " Characteristic to hide (keep MERKNR, KURZT_CHAR, PMETHODE)
        PERFORM hide_column USING 'VERWMERKM'.
        PERFORM hide_column USING 'LTEXTKZ'.
        PERFORM hide_column USING 'TOLERANZUN'.
        PERFORM hide_column USING 'TOLERANZOB'.
        PERFORM hide_column USING 'PRUEFEINH'.
        PERFORM hide_column USING 'STICHPRVER'.
        PERFORM hide_column USING 'KATALGART1'.
        PERFORM hide_column USING 'AUSWMENGE1'.
        PERFORM hide_column USING 'STEUERKZ'.
        PERFORM hide_column USING 'LOEKZ_C'.

        " CI flags – all hidden
        PERFORM hide_column USING 'CI_QUANT'.
        PERFORM hide_column USING 'CI_MEAS_REQUIRED'.
        PERFORM hide_column USING 'CI_ATTR_REF'.
        PERFORM hide_column USING 'CI_ULIM_IND'.
        PERFORM hide_column USING 'CI_LLIM_IND'.
        PERFORM hide_column USING 'CI_CHK_TGT'.
        PERFORM hide_column USING 'CI_SCOPE'.
        PERFORM hide_column USING 'CI_SINGLE_RES'.
        PERFORM hide_column USING 'CI_SAMP_REQ'.
        PERFORM hide_column USING 'CI_RECORDING'.
        PERFORM hide_column USING 'CI_DOC_REQ'.
        PERFORM hide_column USING 'CI_CATEGORY'.

        "-----------------------------------------------------------*
        " FDS column order
        "-----------------------------------------------------------*
        PERFORM set_position USING 'PLNNR'      1.   "Group
        PERFORM set_position USING 'PLNAL'      2.   "Counter
        PERFORM set_position USING 'WERKS'      3.   "Plant
        PERFORM set_position USING 'VORNR'      4.   "Operation
        PERFORM set_position USING 'TDFORMAT'   5.   "FK
        PERFORM set_position USING 'OP_LTXT'    6.   "Op Long Text
        PERFORM set_position USING 'ARBPL_O'    7.   "WC
        PERFORM set_position USING 'ARBEI'      8.   "Work
        PERFORM set_position USING 'MERKNR'     9.   "Insp#
        PERFORM set_position USING 'KURZT_CHAR'10.   "Description
        PERFORM set_position USING 'PMETHODE'  11.   "Insp. Method
        PERFORM set_position USING 'CHAR_LTXT' 12.   "Char Long Text

        "-----------------------------------------------------------*
        " Column texts – FDS-friendly captions
        "-----------------------------------------------------------*
        TRY.
            lo_column ?= lo_columns->get_column( 'PLNNR' ).
            lo_column->set_short_text(  |Grp| ).
            lo_column->set_medium_text( |Group| ).
            lo_column->set_long_text(   |Group| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'PLNAL' ).
            lo_column->set_short_text(  |Cntr| ).
            lo_column->set_medium_text( |Counter| ).
            lo_column->set_long_text(   |Counter| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'WERKS' ).
            lo_column->set_short_text(  |Plant| ).
            lo_column->set_medium_text( |Plant| ).
            lo_column->set_long_text(   |Plant| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'VORNR' ).
            lo_column->set_short_text(  |Op.| ).
            lo_column->set_medium_text( |Operation| ).
            lo_column->set_long_text(   |Operation| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'TDFORMAT' ).
            lo_column->set_short_text(  |FK| ).
            lo_column->set_medium_text( |Frmt Key| ).
            lo_column->set_long_text(   |Format Key| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'OP_LTXT' ).
            lo_column->set_short_text(  |Op Long Text| ).
            lo_column->set_medium_text( |Operation Long Text| ).
            lo_column->set_long_text(   |Operation Long Text| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'ARBPL_O' ).
            lo_column->set_short_text(  |WC| ).
            lo_column->set_medium_text( |Work Center| ).
            lo_column->set_long_text(   |Work Center| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'ARBEI' ).
            lo_column->set_short_text(  |Work| ).
            lo_column->set_medium_text( |Work| ).
            lo_column->set_long_text(   |Work| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        " *** NEW: proper Inspection Number captions ***
        TRY.
            lo_column ?= lo_columns->get_column( 'MERKNR' ).
            lo_column->set_short_text(  |Insp#| ).
            lo_column->set_medium_text( |Inspection No.| ).
            lo_column->set_long_text(   |Inspection Number| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'KURZT_CHAR' ).
            lo_column->set_short_text(  |Descrip| ).
            lo_column->set_medium_text( |Insp. Description| ).
            lo_column->set_long_text(   |Inspection Description| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'PMETHODE' ).
            lo_column->set_short_text(  |Insp Meth| ).
            lo_column->set_medium_text( |Inspection Method| ).
            lo_column->set_long_text(   |Inspection Method| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        TRY.
            lo_column ?= lo_columns->get_column( 'CHAR_LTXT' ).
            lo_column->set_short_text(  |Char Long Text| ).
            lo_column->set_medium_text( |Characteristic Long Text| ).
            lo_column->set_long_text(   |Characteristic Long Text| ).
          CATCH cx_salv_not_found.
        ENDTRY.

        " Display settings
        lo_disp = lo_alv->get_display_settings( ).
        lo_disp->set_striped_pattern( abap_true ).
        lo_disp->set_list_header( 'Valid Task Lists' ).

        " Layout
        lo_layout = lo_alv->get_layout( ).
        ls_layout_key-report = sy-repid.
        lo_layout->set_key( ls_layout_key ).
        lo_layout->set_default( abap_true ).

        " Functions
        lo_funcs = lo_alv->get_functions( ).
        lo_funcs->set_all( abap_true ).

        " Events
        lo_events = lo_alv->get_event( ).
        SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.

      ELSE.
        " ALV already exists – just refresh data
        lo_alv->refresh( ).
      ENDIF.

      PERFORM set_column_visibility_by_state.
      PERFORM set_pfstatus_from_state.
      lo_alv->display( ).

    CATCH cx_salv_msg INTO lx_salv_msg.
      MESSAGE lx_salv_msg->get_text( ) TYPE 'E'.
    CATCH cx_root INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.
  ENDTRY.

ENDFORM.






*&---------------------------------------------------------------------*
*& Form SET_COLUMN_VISIBILITY_BY_STATE
*&---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  " Start from all three visible
  PERFORM set_column_technical USING 'TDFORMAT'  abap_false.
  PERFORM set_column_technical USING 'OP_LTXT'   abap_false.
  PERFORM set_column_technical USING 'CHAR_LTXT' abap_false.

  "-----------------------------------------------------------*
  " CASE A: Show Char = No, Show LT = No
  "   → No FK, no long texts
  "-----------------------------------------------------------*
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

    PERFORM set_column_technical USING 'TDFORMAT'  abap_true.
    PERFORM set_column_technical USING 'OP_LTXT'   abap_true.
    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  "-----------------------------------------------------------*
  " CASE B: Show Char = Yes, Show LT = No
  "   → Operation + Char rows, no long texts
  "   → FK/OP_LTXT/CHAR_LTXT all hidden
  "-----------------------------------------------------------*
  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.

    PERFORM set_column_technical USING 'TDFORMAT'  abap_true.
    PERFORM set_column_technical USING 'OP_LTXT'   abap_true.
    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  "-----------------------------------------------------------*
  " CASE C: Show Char = No, Show LT = Yes
  "   → Operation + Op long text
  "   → FK + OP_LTXT visible, CHAR_LTXT hidden
  "-----------------------------------------------------------*
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  "-----------------------------------------------------------*
  " CASE D: Show Char = Yes, Show LT = Yes
  "   → Operation + Char rows + Char long text
  "   → FK + CHAR_LTXT visible, OP_LTXT hidden
  "-----------------------------------------------------------*
  ELSE.

    PERFORM set_column_technical USING 'OP_LTXT'   abap_true.

  ENDIF.

ENDFORM.