*---------------------------------------------------------------------*
* Adjust GT_DISPLAY fields depending on Show Char / Show Long Text
*  FDS rules:
*  - Char = No, Ltxt = No:
*        FK/long-text columns are hidden (via SALV)
*        Insp# and Description empty on operation rows
*  - Char = No, Ltxt = Yes:
*        FK + Op Long Text shown
*        Char Long Text hidden (via SALV)
*        Insp#, Description and Insp.Method empty on all rows
*  - Char = Yes, Ltxt = No:
*        Only characteristics (no long text) → keep values as built
*  - Char = Yes, Ltxt = Yes:
*        FK + Char Long Text shown, Op Long Text hidden (via SALV)
*---------------------------------------------------------------------*
FORM adjust_display_fields_by_state.

  FIELD-SYMBOLS: <ls_disp> TYPE ty_task_disp.

  LOOP AT gt_display ASSIGNING <ls_disp>.

    "-------------------------------------------------------------*
    " 1) Show Char = No, Show Long Text = No
    "    → Operations only, Insp# + Description blank on op rows
    "-------------------------------------------------------------*
    IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

      IF <ls_disp>-row_kind = 'O'.
        " Insp# + Description cleared, Method kept (per FDS)
        CLEAR: <ls_disp>-merknr,
               <ls_disp>-kurzt_char.
      ENDIF.

    "-------------------------------------------------------------*
    " 2) Show Char = No, Show Long Text = Yes
    "    → Operation rows + OP long texts, but
    "      Insp#, Description, Method must all be blank
    "-------------------------------------------------------------*
    ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

      IF <ls_disp>-row_kind = 'O'
      OR <ls_disp>-row_kind = 'L'.   "op long-text rows
        CLEAR: <ls_disp>-merknr,
               <ls_disp>-kurzt_char,
               <ls_disp>-pmethode.
      ENDIF.

    "-------------------------------------------------------------*
    " 3) Show Char = Yes, Show Long Text = No
    "    → Operation + characteristic rows, no long text
    "       (keep current values)
    "-------------------------------------------------------------*
    ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
      " No changes on data level

    "-------------------------------------------------------------*
    " 4) Show Char = Yes, Show Long Text = Yes
    "    → Operation + char rows + char long text
    "       (keep current values)
    "-------------------------------------------------------------*
    ELSE.
      " No changes

    ENDIF.

  ENDLOOP.

ENDFORM.





*---------------------------------------------------------------------*
* Helper: set column technical flag (visible / hidden)
*---------------------------------------------------------------------*
FORM set_column_technical USING pv_col  TYPE lvc_fname
                                pv_tech TYPE abap_bool.

  DATA: lo_col TYPE REF TO cl_salv_column_table.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  " Ensure we have the latest columns handle
  lo_columns = lo_alv->get_columns( ).

  TRY.
      lo_col ?= lo_columns->get_column( pv_col ).
      lo_col->set_technical( pv_tech ).
    CATCH cx_salv_not_found.
      " Ignore if column not in structure
  ENDTRY.

ENDFORM.






*---------------------------------------------------------------------*
* Column visibility per FDS
*
*  A) Char = No, Ltxt = No
*       → hide FK, Op Long Text, Char Long Text
*
*  B) Char = Yes, Ltxt = No
*       → hide FK, Op Long Text, Char Long Text
*
*  C) Char = No, Ltxt = Yes
*       → show FK + Op Long Text, hide Char Long Text
*
*  D) Char = Yes, Ltxt = Yes
*       → show FK + Char Long Text, hide Op Long Text
*---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  " Start from all three visible
  PERFORM set_column_technical USING 'TDFORMAT' abap_false.
  PERFORM set_column_technical USING 'OP_LTXT'  abap_false.
  PERFORM set_column_technical USING 'CHAR_LTXT' abap_false.

  " Now apply the 4 combinations
  IF gv_show_char = gc_false AND gv_show_ltxt = gc_false.

    " A) No char, no long text
    PERFORM set_column_technical USING 'TDFORMAT' abap_true.
    PERFORM set_column_technical USING 'OP_LTXT'  abap_true.
    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.

    " B) Char only, no long text
    PERFORM set_column_technical USING 'TDFORMAT' abap_true.
    PERFORM set_column_technical USING 'OP_LTXT'  abap_true.
    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.

    " C) Op long text only
    "    → FK + OP_LTXT visible, CHAR_LTXT hidden
    PERFORM set_column_technical USING 'CHAR_LTXT' abap_true.

  ELSE.

    " D) Char + char long text
    "    → FK + CHAR_LTXT visible, OP_LTXT hidden
    PERFORM set_column_technical USING 'OP_LTXT' abap_true.

  ENDIF.

ENDFORM.