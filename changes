FORM get_data.

  DATA: lv_keydat TYPE plko-datuv,
        lv_tolun  TYPE plmk-toleranzun,
        lv_tolob  TYPE plmk-toleranzob.

  CLEAR gt_base.
  CLEAR gs_base.

  lv_keydat = so_keydt-low.

  " Convert tolerance CHAR16 â†’ FLTP
  CLEAR lv_tolun.
  CLEAR lv_tolob.
  IF so_tolun IS NOT INITIAL.
    lv_tolun = so_tolun.
  ENDIF.
  IF so_tolob IS NOT INITIAL.
    lv_tolob = so_tolob.
  ENDIF.

  "===================================================================*
  "* FDS JOIN WITH ALL FIELDS REQUIRED IN TY_TASK_BASE
  "===================================================================*
  SELECT
    "================ HEADER (PLKO) ==================================
    plko~plnty
    plko~plnnr
    plko~plnal
    plko~datuv
    plko~valid_to           AS valid_to
    plko~werks
    plko~ktext
    plko~verwe
    plko~vagrp
    plko~statu              AS stat_h
    plko~anlzu              AS anlzu_h
    plko~strat
    plko~istru              AS istru_h
    plko~adpsp
    plko~slwbez
    plko~loekz              AS loekz_h
    plko~andat
    plko~annam
    plko~aedat
    plko~aenam

    "================ FLOC / EQUIP (TAPL/EAPL) =======================
    tapl~tplnr
    eapl~equnr

    "================ OPERATION (PLPO) ===============================
    plpo~plnkn
    plpo~zaehl
    plpo~datuv              AS datuv_o
    plpo~valid_to           AS valid_to_o
    plpo~vornr
    plpo~ltxa1
    plpo~steus
    crhd~arbpl              AS arbpl_o
    crhd~werks              AS werks_o
    plpo~ktsch
    plpo~arbei
    plpo~arbeh
    plpo~dauno
    plpo~daune
    plpo~kalid
    plpo~execution_stage
    plpo~anlzu              AS anlzu_o
    plpo~istru              AS istru_o
    plpo~larnt
    plpo~ebeln
    plpo~ebelp
    plpo~lifnr
    plpo~preis
    plpo~waers
    plpo~sakto
    plpo~ekorg
    plpo~ekgrp
    plpo~txtsp              AS txtsp_op
    plpo~loekz              AS loekz_o

    "================ CHARACTERISTIC (PLMK) ==========================
    plmk~merknr
    plmk~verwmerkm
    plmk~kurztext           AS kurzt_char
    plmk~ltextkz
    plmk~toleranzun
    plmk~toleranzob
    plmk~pruefeinh
    plmk~stichprver
    plmk~pmethode
    plmk~katalgart1
    plmk~auswmenge1
    plmk~steuerkz
    plmk~loekz              AS loekz_c
    plmk~gueltigab          AS gueltigab
    plmk~valid_to_on_db     AS valid_to_c

    INTO CORRESPONDING FIELDS OF TABLE gt_base

    FROM  plko
      INNER JOIN plas
        ON plas~plnty = plko~plnty
       AND plas~plnnr = plko~plnnr
       AND plas~plnal = plko~plnal
       AND plas~loekz = ' '

      INNER JOIN plpo
        ON plpo~plnty = plas~plnty
       AND plpo~plnnr = plas~plnnr
       AND plpo~plnkn = plas~plnkn
       AND plpo~zaehl = plas~zaehl
       AND plpo~loekz = ' '

      LEFT JOIN plmk
        ON plmk~plnty = plpo~plnty
       AND plmk~plnnr = plpo~plnnr
       AND plmk~plnkn = plpo~plnkn
       AND plmk~zaehl = plpo~zaehl
       AND plmk~loekz = ' '

      LEFT JOIN tapl
        ON tapl~plnty = plko~plnty
       AND tapl~plnnr = plko~plnnr
       AND tapl~plnal = plko~plnal
       AND tapl~loekz = ' '

      LEFT JOIN eapl
        ON eapl~plnty = plko~plnty
       AND eapl~plnnr = plko~plnnr
       AND eapl~plnal = plko~plnal
       AND eapl~loekz = ' '

      LEFT JOIN crhd
        ON crhd~objid = plpo~arbid

    WHERE plko~loekz = ' '
      AND plko~datuv <= lv_keydat
      AND plko~valid_to >= lv_keydat
      AND plpo~datuv <= lv_keydat
      AND plpo~valid_to >= lv_keydat
      AND ( plmk~gueltigab IS INITIAL OR plmk~gueltigab <= lv_keydat )
      AND ( plmk~valid_to_on_db IS INITIAL OR plmk~valid_to_on_db >= lv_keydat ).

  SORT gt_base BY plnty plnnr plnal vornr merknr.
  DELETE ADJACENT DUPLICATES FROM gt_base COMPARING plnty plnnr plnal vornr merknr.

  "===================================================================*
  "* ABAP-LEVEL FILTERING BASED ON SELECTION-SCREEN
  "===================================================================*
  DATA lt_filtered TYPE STANDARD TABLE OF ty_task_base.

  CLEAR lt_filtered.

  LOOP AT gt_base INTO gs_base.

    "--- Task List Type (FTL/ETL/GTL) --------------------------------
    IF gs_base-plnty = 'A' AND p_ftl IS INITIAL.
      CONTINUE.
    ENDIF.
    IF gs_base-plnty = 'B' AND p_etl IS INITIAL.
      CONTINUE.
    ENDIF.
    IF gs_base-plnty = 'E' AND p_gtl IS INITIAL.
      CONTINUE.
    ENDIF.

    "--- Header Filters ----------------------------------------------
    IF so_plnnr[] IS NOT INITIAL AND gs_base-plnnr NOT IN so_plnnr.
      CONTINUE.
    ENDIF.

    IF so_plnal[] IS NOT INITIAL AND gs_base-plnal NOT IN so_plnal.
      CONTINUE.
    ENDIF.

    IF so_werks[] IS NOT INITIAL AND gs_base-werks NOT IN so_werks.
      CONTINUE.
    ENDIF.

    "--- Operation Filters -------------------------------------------
    IF so_vornr[] IS NOT INITIAL AND gs_base-vornr NOT IN so_vornr.
      CONTINUE.
    ENDIF.

    IF so_otext[] IS NOT INITIAL AND gs_base-ltxa1 NOT IN so_otext.
      CONTINUE.
    ENDIF.

    IF p_oltin = 'X' AND gs_base-txtsp_op IS INITIAL.
      CONTINUE.
    ENDIF.

    "--- Characteristic Filters --------------------------------------
    IF so_merkn[] IS NOT INITIAL AND gs_base-merknr NOT IN so_merkn.
      CONTINUE.
    ENDIF.

    IF so_mic[] IS NOT INITIAL AND gs_base-verwmerkm NOT IN so_mic.
      CONTINUE.
    ENDIF.

    IF so_cktxt[] IS NOT INITIAL AND gs_base-kurzt_char NOT IN so_cktxt.
      CONTINUE.
    ENDIF.

    IF so_ltxtk[] IS NOT INITIAL AND gs_base-ltextkz NOT IN so_ltxtk.
      CONTINUE.
    ENDIF.

    IF so_meth[] IS NOT INITIAL AND gs_base-pmethode NOT IN so_meth.
      CONTINUE.
    ENDIF.

    "--- Tolerance ----------------------------------------------------
    IF so_tolun IS NOT INITIAL AND gs_base-toleranzun <> lv_tolun.
      CONTINUE.
    ENDIF.

    IF so_tolob IS NOT INITIAL AND gs_base-toleranzob <> lv_tolob.
      CONTINUE.
    ENDIF.

    "--- If passed all filters ---------------------------------------
    APPEND gs_base TO lt_filtered.

  ENDLOOP.

  gt_base = lt_filtered.

ENDFORM.