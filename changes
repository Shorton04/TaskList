FORM adjust_display_fields_by_state.

  FIELD-SYMBOLS: <ls_disp> TYPE ty_task_disp.

  LOOP AT gt_display ASSIGNING <ls_disp>.

    CASE gv_show_char && gv_show_ltxt.

      WHEN gc_false && gc_false.
        "Show Char = No, Show LT = No
        "Keep only header/operation fields
        CLEAR: <ls_disp>-tdformat,
               <ls_disp>-op_ltxt,
               <ls_disp>-merk_nr,
               <ls_disp>-kurzt_char,
               <ls_disp>-pmethode,
               <ls_disp>-char_ltxt.

      WHEN gc_true && gc_false.
        "Show Char = Yes, Show LT = No
        "Keep only characteristic fields, no long text at all
        CLEAR: <ls_disp>-tdformat,
               <ls_disp>-op_ltxt,
               <ls_disp>-char_ltxt.

      WHEN gc_false && gc_true.
        "Show Char = No, Show LT = Yes
        "We want ONLY operation long text:
        "FK + OP_LTXT visible, NO characteristic info
        CLEAR: <ls_disp>-merk_nr,
               <ls_disp>-kurzt_char,
               <ls_disp>-pmethode,
               <ls_disp>-char_ltxt.

      WHEN gc_true && gc_true.
        "Show Char = Yes, Show LT = Yes
        "Characteristics + their long text.
        "Operation-long-text rows should *not* show
        "characteristic info
        IF <ls_disp>-row_kind = gc_row_op_longtxt.
          CLEAR: <ls_disp>-merk_nr,
                 <ls_disp>-kurzt_char,
                 <ls_disp>-pmethode,
                 <ls_disp>-char_ltxt.
        ENDIF.

    ENDCASE.

  ENDLOOP.

ENDFORM.







FORM set_column_visibility_by_state
  USING io_columns TYPE REF TO cl_salv_columns_table.

  DATA lo_col TYPE REF TO cl_salv_column.

  "Helper macro
  DEFINE set_visible.
    TRY.
        lo_col ?= io_columns->get_column( &1 ).
        lo_col->set_technical( &2 ).
        lo_col->set_visible( abap_true ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  CASE gv_show_char && gv_show_ltxt.

    WHEN gc_false && gc_false.
      "No Char, No LT → hide all LT/char columns
      set_visible 'TDFORMAT'  abap_true.
      set_visible 'OP_LTXT'   abap_true.
      set_visible 'CHAR_LTXT' abap_true.

    WHEN gc_true && gc_false.
      "Char only → show inspection#, description, method
      "but NO long text columns
      set_visible 'TDFORMAT'  abap_true.
      set_visible 'OP_LTXT'   abap_true.
      set_visible 'CHAR_LTXT' abap_true.

    WHEN gc_false && gc_true.
      "Long text only → show FK + Op.LTXT,
      "hide Char long text
      set_visible 'TDFORMAT'  abap_false.
      set_visible 'OP_LTXT'   abap_false.
      set_visible 'CHAR_LTXT' abap_true.

    WHEN gc_true && gc_true.
      "Char + Long text → show FK + Char long text
      "Op long text is not needed per FDS
      set_visible 'TDFORMAT'  abap_false.
      set_visible 'OP_LTXT'   abap_true.
      set_visible 'CHAR_LTXT' abap_false.

  ENDCASE.

ENDFORM.




