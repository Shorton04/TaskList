*&---------------------------------------------------------------------*
*& Module STATUS_0100 OUTPUT
*&---------------------------------------------------------------------*
MODULE status_0100 OUTPUT.

  PERFORM set_pfstatus_from_state.
  PERFORM set_title_from_state.

  "Create container + SALV only once
  IF go_container IS INITIAL.

    CREATE OBJECT go_container
      EXPORTING
        container_name = 'CC_ALV'.   "Custom Control name on Screen 0100

    "Initial build of display table
    PERFORM build_display.

    "Create SALV inside container
    cl_salv_table=>factory(
      EXPORTING
        r_container  = go_container
      IMPORTING
        r_salv_table = lo_alv
      CHANGING
        t_table      = gt_display ).

    "Configure and display ALV in container
    PERFORM display_alv.

  ELSE.
    "Dataset might have changed between calls
    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.
  ENDIF.

ENDMODULE.

*&---------------------------------------------------------------------*
*& Module USER_COMMAND_0100 INPUT
*&---------------------------------------------------------------------*
MODULE user_command_0100 INPUT.

  CASE sy-ucomm.

    WHEN gc_button_char OR gc_button_charh.
      PERFORM toggle_char.

    WHEN gc_button_ltxt OR gc_button_ltxth.
      PERFORM toggle_ltxt.

    WHEN 'REFRESH'.
      PERFORM build_display.
      IF lo_alv IS BOUND.
        lo_alv->refresh( ).
      ENDIF.

    WHEN gc_button_back OR gc_button_exit OR gc_button_cancel.
      CLEAR: gv_show_char, gv_show_ltxt.
      LEAVE TO SCREEN 0.

  ENDCASE.

ENDMODULE.

*======================================================================*
*   Helper Forms – PF-STATUS / Title
*======================================================================*

*&---------------------------------------------------------------------*
*& Form set_pfstatus_from_state
*&---------------------------------------------------------------------*
FORM set_pfstatus_from_state.

  DATA lv_pfstatus TYPE sypfkey.

  IF gv_show_char = gc_true AND gv_show_ltxt = gc_true.
    lv_pfstatus = 'ZSALV_TL_BOTH'.
  ELSEIF gv_show_char = gc_true AND gv_show_ltxt = gc_false.
    lv_pfstatus = 'ZSALV_TL_CHAR'.
  ELSEIF gv_show_char = gc_false AND gv_show_ltxt = gc_true.
    lv_pfstatus = 'ZSALV_TL_LTXT'.
  ELSE.
    lv_pfstatus = 'ZSALV_TL_NONE'.
  ENDIF.

  SET PF-STATUS lv_pfstatus.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form set_title_from_state
*&---------------------------------------------------------------------*
FORM set_title_from_state.

  DATA lv_title TYPE string.

  lv_title = 'Maintenance Task List Report'.

  IF gv_show_char = gc_true.
    lv_title = lv_title && ' - Characteristics Active'.
  ENDIF.
  IF gv_show_ltxt = gc_true.
    lv_title = lv_title && ' - Long Text Active'.
  ENDIF.

  SET TITLEBAR 'TITLE_100' WITH lv_title.

ENDFORM.

*======================================================================*
*   Core logic – Build display & Long text helpers
*======================================================================*

*&---------------------------------------------------------------------*
*& Form build_display
*&---------------------------------------------------------------------*
FORM build_display.

  DATA: lv_last_plnty TYPE plko-plnty,
        lv_last_plnnr TYPE plko-plnnr,
        lv_last_plnal TYPE plko-plnal,
        lv_last_vornr TYPE plpo-vornr.

  CLEAR gt_display.
  CLEAR gs_display.

  CLEAR: lv_last_plnty, lv_last_plnnr, lv_last_plnal, lv_last_vornr.

  LOOP AT gt_base INTO gs_base.

    " 1) Operation row – only when operation key changes
    IF gs_base-plnty <> lv_last_plnty OR
       gs_base-plnnr <> lv_last_plnnr OR
       gs_base-plnal <> lv_last_plnal OR
       gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'O'.

      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      "Remember last operation key
      lv_last_plnty = gs_base-plnty.
      lv_last_plnnr = gs_base-plnnr.
      lv_last_plnal = gs_base-plnal.
      lv_last_vornr = gs_base-vornr.

      "Operation long text lines (if Show Long Text is active)
      IF gv_show_ltxt = gc_true
         AND gs_base-txtsp_op IS NOT INITIAL.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

    ENDIF.

    " 2) Characteristic row + long text (if Show Characteristics)
    IF gv_show_char = gc_true
       AND gs_base-merknr IS NOT INITIAL.

      "Characteristic row
      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.
      gs_display-row_kind = 'C'.

      PERFORM derive_ci_fields
        USING    gs_base-steuerkz
        CHANGING gs_display.

      APPEND gs_display TO gt_display.

      "Characteristic long text (if indicator + Show Long Text)
      IF gs_base-ltextkz IS NOT INITIAL
         AND gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.

*---------------------------------------------------------------------*
* Configure + display ALV in container (no custom SALV buttons)
*---------------------------------------------------------------------*
FORM display_alv.

  DATA: lx_salv_msg TYPE REF TO cx_salv_msg,
        lx_salv_ex  TYPE REF TO cx_root,
        lv_title    TYPE lvc_title.

  IF lo_alv IS NOT BOUND.
    RETURN.
  ENDIF.

  TRY.

      " Columns
      lo_columns = lo_alv->get_columns( ).
      lo_columns->set_optimize( abap_true ).

      "Hide technical columns
      TRY.
          lo_column ?= lo_columns->get_column( 'ROW_KIND' ).
          lo_column->set_technical( abap_true ).
        CATCH cx_salv_not_found.
      ENDTRY.

      TRY.
          lo_column ?= lo_columns->get_column( 'TDFORMAT' ).
          lo_column->set_technical( abap_true ).
        CATCH cx_salv_not_found.
      ENDTRY.

      " Display settings
      lo_disp = lo_alv->get_display_settings( ).
      lo_disp->set_striped_pattern( abap_true ).

      lv_title = 'Valid Task Lists'.
      lo_disp->set_list_header( lv_title ).

      " Layout
      lo_layout = lo_alv->get_layout( ).
      ls_layout_key-report = sy-repid.
      lo_layout->set_key( ls_layout_key ).
      lo_layout->set_save_restriction( if_salv_c_layout=>restrict_none ).
      lo_layout->set_default( abap_true ).

      " Standard functions
      lo_funcs = lo_alv->get_functions( ).
      lo_funcs->set_all( abap_true ).

      " Selections
      lo_sel = lo_alv->get_selections( ).
      lo_sel->set_selection_mode( if_salv_c_selection_mode=>row_column ).

      "Display ALV in container
      lo_alv->display( ).

    CATCH cx_salv_existing INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.
    CATCH cx_salv_wrong_call INTO lx_salv_ex.
      MESSAGE lx_salv_ex->get_text( ) TYPE 'E'.
    CATCH cx_salv_msg INTO lx_salv_msg.
      MESSAGE lx_salv_msg->get_text( ) TYPE 'E'.
  ENDTRY.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form append_op_longtext
*&---------------------------------------------------------------------*
FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA: ls_thead TYPE thead,
        lv_name  TYPE thead-tdname.

  CLEAR gt_tline.

  "Example: PLNTY + PLNNR (ALPHA) + PLNAL + VORNR
  lv_name = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-vornr }|.

  CLEAR ls_thead.
  ls_thead-tdid     = 'PLPO'.
  ls_thead-tdspras  = sy-langu.
  ls_thead-tdname   = lv_name.
  ls_thead-tdobject = 'PLPO'.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = ls_thead-tdid
      language = ls_thead-tdspras
      name     = ls_thead-tdname
      object   = ls_thead-tdobject
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR gt_tline IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind = 'L'.
    gs_display-op_ltxt  = gs_tline-tdline.
    gs_display-tdformat = gs_tline-tdformat.

    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form append_char_longtext
*&---------------------------------------------------------------------*
FORM append_char_longtext USING is_base TYPE ty_task_base.

  DATA: ls_thead TYPE thead,
        lv_name  TYPE thead-tdname.

  CLEAR gt_tline.

  "Example: PLNTY + PLNNR (ALPHA) + PLNAL + MERKNR (ALPHA)
  lv_name = |{ is_base-plnty }{ is_base-plnnr ALPHA = OUT }{ is_base-plnal }{ is_base-merknr ALPHA = OUT }|.

  CLEAR ls_thead.
  ls_thead-tdid     = 'PLMK'.
  ls_thead-tdspras  = sy-langu.
  ls_thead-tdname   = lv_name.
  ls_thead-tdobject = 'PLMK'.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = ls_thead-tdid
      language = ls_thead-tdspras
      name     = ls_thead-tdname
      object   = ls_thead-tdobject
    TABLES
      lines    = gt_tline
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR gt_tline IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT gt_tline INTO gs_tline.
    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind  = 'L'.
    gs_display-char_ltxt = gs_tline-tdline.
    gs_display-tdformat  = gs_tline-tdformat.

    APPEND gs_display TO gt_display.
  ENDLOOP.

ENDFORM.

*======================================================================*
*   Toggle helpers for PF-STATUS buttons
*======================================================================*

*&---------------------------------------------------------------------*
*& Form toggle_char
*&---------------------------------------------------------------------*
FORM toggle_char.

  IF gv_show_char = gc_true.
    gv_show_char = gc_false.
  ELSE.
    gv_show_char = gc_true.
  ENDIF.

  PERFORM build_display.
  PERFORM set_pfstatus_from_state.
  PERFORM set_title_from_state.

  IF lo_alv IS BOUND.
    lo_alv->refresh( ).
  ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*& Form toggle_ltxt
*&---------------------------------------------------------------------*
FORM toggle_ltxt.

  IF gv_show_ltxt = gc_true.
    gv_show_ltxt = gc_false.
  ELSE.
    gv_show_ltxt = gc_true.
  ENDIF.

  PERFORM build_display.
  PERFORM set_pfstatus_from_state.
  PERFORM set_title_from_state.

  IF lo_alv IS BOUND.
    lo_alv->refresh( ).
  ENDIF.

ENDFORM.