*---------------------------------------------------------------------*
*  Include ZRE_A2R_VALID_TASKLIST_TOP
*---------------------------------------------------------------------*

TABLES: plko, plpo, plmk, tapl, eapl, crhd.

TYPE-POOLS: slis abap.

"--------------------------------------------------------------
" Base structure â€“ unchanged
"--------------------------------------------------------------
TYPES: BEGIN OF ty_task_base,
         plnty           TYPE plko-plnty,
         plnnr           TYPE plko-plnnr,
         plnal           TYPE plko-plnal,
         datuv           TYPE plko-datuv,
         valid_to        TYPE plko-valid_to,
         werks           TYPE plko-werks,
         ktext           TYPE plko-ktext,
         verwe           TYPE plko-verwe,
         vagrp           TYPE plko-vagrp,
         statu_h         TYPE plko-statu,
         anlzu_h         TYPE plko-anlzu,
         strat           TYPE plko-strat,
         istru_h         TYPE plko-istru,
         adpsp           TYPE plko-adpsp,
         slwbez          TYPE plko-slwbez,
         arbid_h         TYPE plko-arbid,
         loekz_h         TYPE plko-loekz,
         andat           TYPE plko-andat,
         annam           TYPE plko-annam,
         aedat           TYPE plko-aedat,
         aenam           TYPE plko-aenam,

         tplnr           TYPE tapl-tplnr,
         equnr           TYPE eapl-equnr,

         plnkn           TYPE plpo-plnkn,
         zaehl           TYPE plpo-zaehl,
         datuv_o         TYPE plpo-datuv,
         valid_to_o      TYPE plpo-valid_to,
         vornr           TYPE plpo-vornr,
         ltxa1           TYPE plpo-ltxa1,
         steus           TYPE plpo-steus,
         arbpl_o         TYPE crhd-arbpl,
         werks_o         TYPE crhd-werks,
         ktsch           TYPE plpo-ktsch,
         arbei           TYPE plpo-arbei,
         arbeh           TYPE plpo-arbeh,
         dauno           TYPE plpo-dauno,
         daune           TYPE plpo-daune,
         kalid           TYPE plpo-kalid,
         execution_stage TYPE plpo-execution_stage,
         anlzu_o         TYPE plpo-anlzu,
         istru_o         TYPE plpo-istru,
         larnt           TYPE plpo-larnt,
         ebeln           TYPE plpo-ebeln,
         ebelp           TYPE plpo-ebelp,
         lifnr           TYPE plpo-lifnr,
         preis           TYPE plpo-preis,
         waers           TYPE plpo-waers,
         sakto           TYPE plpo-sakto,
         ekorg           TYPE plpo-ekorg,
         ekgrp           TYPE plpo-ekgrp,
         txtsp_op        TYPE plpo-txtsp,
         loekz_o         TYPE plpo-loekz,

         merknr          TYPE plmk-merknr,
         verwmerkm       TYPE plmk-verwmerkm,
         kurzt_char      TYPE plmk-kurztext,
         ltextkz         TYPE plmk-ltextkz,
         toleranzun      TYPE plmk-toleranzun,
         toleranzob      TYPE plmk-toleranzob,
         pruefeinh       TYPE plmk-pruefeinh,
         stichprver      TYPE plmk-stichprver,
         pmethode        TYPE plmk-pmethode,
         katalgart1      TYPE plmk-katalgart1,
         auswmenge1      TYPE plmk-auswmenge1,
         steuerkz        TYPE plmk-steuerkz,
         loekz_c         TYPE plmk-loekz,
         gueltigab       TYPE plmk-gueltigab,
         valid_to_c      TYPE plmk-valid_to_on_db,
       END OF ty_task_base.

"--------------------------------------------------------------
" Display structure (multi-row: O, C, L)
"--------------------------------------------------------------
TYPES: BEGIN OF ty_task_disp,
         plnnr      TYPE plko-plnnr,
         plnal      TYPE plko-plnal,
         werks      TYPE plko-werks,
         vornr      TYPE plpo-vornr,
         arbpl_o    TYPE crhd-arbpl,
         arbei      TYPE plpo-arbei,
         ltxa1      TYPE plpo-ltxa1,
         pmethode   TYPE plmk-pmethode,
         merknr     TYPE plmk-merknr,
         tplnr      TYPE tapl-tplnr,

         op_ltxt    TYPE tline-tdline,
         char_ltxt  TYPE tline-tdline,

         row_kind   TYPE c LENGTH 1,
         line_color TYPE char4,
         row_id     TYPE i,
       END OF ty_task_disp.

"--------------------------------------------------------------
" Internal tables
"--------------------------------------------------------------
DATA: gt_base    TYPE STANDARD TABLE OF ty_task_base,
      gs_base    TYPE ty_task_base,
      gt_display TYPE STANDARD TABLE OF ty_task_disp,
      gs_display TYPE ty_task_disp.

"--------------------------------------------------------------
" SALV Objects
"--------------------------------------------------------------
DATA: go_salv       TYPE REF TO cl_salv_table,
      go_columns    TYPE REF TO cl_salv_columns_table,
      go_column     TYPE REF TO cl_salv_column_table,
      go_functions  TYPE REF TO cl_salv_functions_list,
      go_layout     TYPE REF TO cl_salv_layout,
      go_events     TYPE REF TO cl_salv_events_table.

"--------------------------------------------------------------
" Toggles
"--------------------------------------------------------------
DATA: gv_show_char TYPE abap_bool VALUE abap_true,
      gv_show_ltxt TYPE abap_bool VALUE abap_true,
      gv_row_id    TYPE i.

"--------------------------------------------------------------
" Function codes
"--------------------------------------------------------------
CONSTANTS:
  gc_show_char TYPE syucomm VALUE 'CLISTS',
  gc_hide_char TYPE syucomm VALUE 'CLISTH',
  gc_show_ltxt TYPE syucomm VALUE 'LTXTS',
  gc_hide_ltxt TYPE syucomm VALUE 'LTXTH'.





CLASS lcl_salv_handler DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS on_user_command
      FOR EVENT added_function OF cl_salv_events_table
      IMPORTING e_salv_function.
ENDCLASS.

CLASS lcl_salv_handler IMPLEMENTATION.

  METHOD on_user_command.

    CASE e_salv_function.

      WHEN gc_show_char.
        gv_show_char = abap_true.
        PERFORM display_alv.

      WHEN gc_hide_char.
        gv_show_char = abap_false.
        PERFORM display_alv.

      WHEN gc_show_ltxt.
        gv_show_ltxt = abap_true.
        PERFORM display_alv.

      WHEN gc_hide_ltxt.
        gv_show_ltxt = abap_false.
        PERFORM display_alv.

    ENDCASE.

  ENDMETHOD.

ENDCLASS.






FORM build_display.

  DATA lv_last_vornr TYPE vornr.

  gv_row_id = 0.
  CLEAR gt_display.

  SORT gt_base BY plnnr plnal vornr merknr.

  LOOP AT gt_base INTO gs_base.

    "----------------------------------------------------------
    " OPERATION ROW
    "----------------------------------------------------------
    IF gs_base-vornr <> lv_last_vornr.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.

      gs_display-row_kind = 'O'.
      gs_display-line_color = '0000'.   " no color

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.

      APPEND gs_display TO gt_display.

      IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.
        PERFORM append_op_longtext USING gs_base.
      ENDIF.

      lv_last_vornr = gs_base-vornr.
    ENDIF.


    "----------------------------------------------------------
    " CHARACTERISTIC ROW
    "----------------------------------------------------------
    IF gv_show_char = abap_true AND gs_base-merknr IS NOT INITIAL.

      CLEAR gs_display.
      MOVE-CORRESPONDING gs_base TO gs_display.

      gs_display-row_kind = 'C'.
      gs_display-line_color = '6100'.   " green

      ADD 1 TO gv_row_id.
      gs_display-row_id = gv_row_id.

      APPEND gs_display TO gt_display.

      IF gv_show_ltxt = abap_true.
        PERFORM append_char_longtext USING gs_base.
      ENDIF.

    ENDIF.

  ENDLOOP.

ENDFORM.




FORM append_op_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines TYPE STANDARD TABLE OF tline,
        ls_line  TYPE tline,
        lv_name  TYPE thead-tdname.

  CONCATENATE sy-mandt
              is_base-plnty
              is_base-plnnr
              is_base-plnkn
              is_base-zaehl
         INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'PLPO'
      language = sy-langu
      name     = lv_name
      object   = 'ROUTING'
    TABLES
      lines    = lt_lines.

  IF lt_lines IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT lt_lines INTO ls_line.

    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind  = 'L'.
    gs_display-op_ltxt   = ls_line-tdline.
    gs_display-line_color = '5100'.  " yellow

    ADD 1 TO gv_row_id.
    gs_display-row_id = gv_row_id.

    APPEND gs_display TO gt_display.

  ENDLOOP.

ENDFORM.





FORM append_char_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines TYPE STANDARD TABLE OF tline,
        ls_line  TYPE tline,
        lv_tmp   TYPE thead-tdname,
        lv_name  TYPE thead-tdname.

  IF is_base-ltextkz IS INITIAL.
    RETURN.
  ENDIF.

  CONCATENATE sy-mandt
              is_base-plnty
              is_base-plnnr
              is_base-plnkn
         INTO lv_tmp.

  CONCATENATE lv_tmp is_base-merknr INTO lv_tmp SEPARATED BY space.
  CONCATENATE lv_tmp is_base-zaehl INTO lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QM'
      language = sy-langu
      name     = lv_name
      object   = 'QSS'
    TABLES
      lines    = lt_lines.

  IF lt_lines IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT lt_lines INTO ls_line.

    CLEAR gs_display.
    MOVE-CORRESPONDING is_base TO gs_display.

    gs_display-row_kind  = 'L'.
    gs_display-char_ltxt = ls_line-tdline.
    gs_display-line_color = '3100'.  " blue

    ADD 1 TO gv_row_id.
    gs_display-row_id = gv_row_id.

    APPEND gs_display TO gt_display.

  ENDLOOP.

ENDFORM.




FORM display_alv.

  PERFORM build_display.

  IF gt_display IS INITIAL.
    MESSAGE 'No data found' TYPE 'I'.
    RETURN.
  ENDIF.

  cl_salv_table=>factory(
    IMPORTING r_salv_table = go_salv
    CHANGING  t_table      = gt_display ).

  " Columns
  go_columns = go_salv->get_columns( ).
  go_columns->set_optimize( abap_true ).

  LOOP AT go_columns->get( ) INTO DATA(ls_col).

    go_column = go_columns->get_column( ls_col-columnname ).

    CASE ls_col-columnname.

      WHEN 'PLNNR'.    go_column->set_visible( abap_true ).
      WHEN 'PLNAL'.    go_column->set_visible( abap_true ).
      WHEN 'WERKS'.    go_column->set_visible( abap_true ).
      WHEN 'VORNR'.    go_column->set_visible( abap_true ).
      WHEN 'ARBPL_O'.  go_column->set_visible( abap_true ).
      WHEN 'ARBEI'.    go_column->set_visible( abap_true ).
      WHEN 'LTXA1'.    go_column->set_visible( abap_true ).
      WHEN 'PMETHODE'. go_column->set_visible( abap_true ).
      WHEN 'MERKNR'.   go_column->set_visible( abap_true ).
      WHEN 'TPLNR'.    go_column->set_visible( abap_true ).
      WHEN 'OP_LTXT'.  go_column->set_visible( gv_show_ltxt ).
      WHEN 'CHAR_LTXT'.go_column->set_visible( gv_show_ltxt ).

      WHEN OTHERS.     go_column->set_visible( abap_false ).

    ENDCASE.

  ENDLOOP.

  " Layout save
  go_layout = go_salv->get_layout( ).
  go_layout->set_key( VALUE salv_s_layout_key( report = sy-repid handle = 'TASKLISTLAY' ) ).
  go_layout->set_save_restriction( if_salv_c_layout=>restrict_none ).

  " Functions
  go_functions = go_salv->get_functions( ).
  go_functions->set_all( abap_true ).

  go_functions->add_function( name = gc_show_char text = 'Show Char.' ).
  go_functions->add_function( name = gc_hide_char text = 'Hide Char.' ).
  go_functions->add_function( name = gc_show_ltxt text = 'Show Long Txt' ).
  go_functions->add_function( name = gc_hide_ltxt text = 'Hide Long Txt' ).


  " Events
  go_events = go_salv->get_event( ).
  SET HANDLER lcl_salv_handler=>on_user_command FOR go_events.

  " Display
  go_salv->display( ).

ENDFORM.


