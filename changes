*---------------------------------------------------------------------*
*  FORM set_column_visibility_by_state - FINAL (VISIBILITY + ORDER)
*---------------------------------------------------------------------*
FORM set_column_visibility_by_state.

  DATA lo_cols TYPE REF TO cl_salv_columns_table.
  DATA lo_col  TYPE REF TO cl_salv_column_table.
  DATA lv_idx  TYPE i.

  IF lo_alv IS INITIAL.
    RETURN.
  ENDIF.

  lo_cols = lo_alv->get_columns( ).

  "--------------------------------------------------------------*
  " Helper macros
  "--------------------------------------------------------------*
  DEFINE hide_col.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_visible( abap_false ).
        lo_col->set_technical( abap_true ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE show_col.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_visible( abap_true ).
        lo_col->set_technical( abap_false ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.

  DEFINE pos.
    TRY.
        lo_col ?= lo_cols->get_column( &1 ).
        lo_col->set_position( &2 ).
      CATCH cx_salv_not_found.
    ENDTRY.
  END-OF-DEFINITION.


  "--------------------------------------------------------------*
  " 1. HIDE ALL INTERNAL / GHOST / UNUSED FIELDS
  "--------------------------------------------------------------*

  " Hide STATUS completely (FDS says do NOT show)
  hide_col 'STAT_H'.
  hide_col 'STATUS'.
  hide_col 'STATS'.

  " Technical / internal
  hide_col 'ROW_KIND'.
  hide_col 'TDFORMAT'.   "will be shown by mode later
  hide_col 'DATUV'.
  hide_col 'VALID_TO'.
  hide_col 'DATUV_O'.
  hide_col 'VALID_TO_O'.
  hide_col 'GUELTIGAB'.
  hide_col 'VALID_TO_C'.

  " Hide ALL CI fields (CI1â€“CI28)
  DO 28 TIMES.
    hide_col |CI{ sy-index }|.
  ENDDO.

  " HEADER fields not in FDS
  hide_col 'PLNTY'.
  hide_col 'KTEXT'.
  hide_col 'TPLNR'.
  hide_col 'EQUNR'.
  hide_col 'VERWE'.
  hide_col 'VAGRP'.
  hide_col 'ANLZU_H'.
  hide_col 'STRAT'.
  hide_col 'ISTRU_H'.
  hide_col 'ADPSP'.
  hide_col 'SLWBEZ'.
  hide_col 'ANDAT'.
  hide_col 'ANNAM'.
  hide_col 'AEDAT'.
  hide_col 'AENAM'.

  " OPERATION fields not in FDS
  hide_col 'PLNKN'.
  hide_col 'ZAEHL'.
  hide_col 'STEUS'.
  hide_col 'WERKS_O'.
  hide_col 'KTSCH'.
  hide_col 'ARBEH'.
  hide_col 'DAUNO'.
  hide_col 'DAUNE'.
  hide_col 'KALID'.
  hide_col 'EXECUTION_STAGE'.
  hide_col 'ANLZU_O'.
  hide_col 'ISTRU_O'.
  hide_col 'LARNT'.
  hide_col 'EBELN'.
  hide_col 'EBELP'.
  hide_col 'LIFNR'.
  hide_col 'PREIS'.
  hide_col 'WAERS'.
  hide_col 'SAKTO'.
  hide_col 'EKORG'.
  hide_col 'EKGRP'.
  hide_col 'TXTSP_OP'.
  hide_col 'LOEKZ_O'.

  " CHARACTERISTIC FIELDS not in FDS
  hide_col 'VERWMERKM'.
  hide_col 'LTEXTKZ'.
  hide_col 'TOLERANZUN'.
  hide_col 'TOLERANZOB'.
  hide_col 'PRUEFEINH'.
  hide_col 'STICHPRVER'.
  hide_col 'KATALGART1'.
  hide_col 'AUSWMENGE1'.
  hide_col 'STEUERKZ'.
  hide_col 'LOEKZ_C'.

  "--------------------------------------------------------------*
  " 2. SHOW ONLY FDS-APPROVED FIELDS
  "--------------------------------------------------------------*

  show_col 'PLNNR'.         "Group
  show_col 'PLNAL'.         "Counter
  show_col 'WERKS'.         "Plant
  show_col 'VORNR'.         "Operation
  show_col 'ARBPL_O'.       "Work Center
  show_col 'ARBEI'.         "Work
  show_col 'KURZT_CHAR'.    "Description
  show_col 'PMETHODE'.      "Inspection Method
  show_col 'MERKNR'.        "Inspection Number
  show_col 'TDFORMAT'.      "FK
  show_col 'OP_LTXT'.       "Operation LT
  show_col 'CHAR_LTXT'.     "Characteristic LT


  "--------------------------------------------------------------*
  " 3. APPLY MODE-BASED HIDE/SHOW LOGIC
  "--------------------------------------------------------------*

  "* MODE 1: Hide Characteristics + Show Long Text
  IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.

    hide_col 'KURZT_CHAR'.
    hide_col 'PMETHODE'.
    hide_col 'MERKNR'.

    show_col 'OP_LTXT'.
    show_col 'CHAR_LTXT'.

    "COLUMN ORDER
    pos 'PLNNR'        1.
    pos 'PLNAL'        2.
    pos 'WERKS'        3.
    pos 'VORNR'        4.
    pos 'TDFORMAT'     5.   "FK
    pos 'OP_LTXT'      6.   "Op LT
    pos 'ARBPL_O'      7.   "WC
    pos 'ARBEI'        8.   "Work
    pos 'KURZT_CHAR'   9.   "Description
    pos 'PMETHODE'    10.   "Insp Method
    pos 'MERKNR'      11.   "Insp#
    pos 'CHAR_LTXT'   12.   "Char LT

    RETURN.
  ENDIF.


  "* MODE 2: Show Characteristics + Show Long Text
  IF gv_show_char = abap_true AND gv_show_ltxt = abap_true.

    show_col 'KURZT_CHAR'.
    show_col 'PMETHODE'.
    show_col 'MERKNR'.
    show_col 'TDFORMAT'.
    show_col 'OP_LTXT'.
    show_col 'CHAR_LTXT'.

    "COLUMN ORDER
    pos 'PLNNR'        1.
    pos 'PLNAL'        2.
    pos 'WERKS'        3.
    pos 'VORNR'        4.
    pos 'ARBPL_O'      5.   "WC
    pos 'ARBEI'        6.   "Work
    pos 'KURZT_CHAR'   7.   "Description
    pos 'PMETHODE'     8.   "Insp Method
    pos 'MERKNR'       9.   "Insp#
    pos 'TDFORMAT'    10.   "FK
    pos 'OP_LTXT'     11.   "Op LT
    pos 'CHAR_LTXT'   12.   "Char LT

    RETURN.
  ENDIF.

ENDFORM.