FORM build_char_textname USING is_base TYPE ty_task_base
                         CHANGING ev_tdname TYPE thead-tdname.

  DATA: lv_plnnr  TYPE c LENGTH 8,
        lv_plnkn  TYPE c LENGTH 8,
        lv_merknr TYPE c LENGTH 8,
        lv_zaehl  TYPE c LENGTH 8.

  "Convert numbers to SAP internal CHAR format (ALPHA IN)
  lv_plnnr  = |{ is_base-plnnr  ALPHA = IN }|.
  lv_plnkn  = |{ is_base-plnkn  ALPHA = IN }|.
  lv_merknr = |{ is_base-merknr ALPHA = IN }|.
  lv_zaehl  = |{ is_base-zaehl  ALPHA = IN }|.

  "Final SAP TDNAME for QSS long text
  CONCATENATE
     sy-mandt
     is_base-plnty
     lv_plnnr
     lv_plnkn
     lv_merknr
     lv_zaehl
  INTO ev_tdname.

ENDFORM.




FORM append_char_longtext USING is_base TYPE ty_task_base.

  DATA: lt_lines TYPE STANDARD TABLE OF tline,
        ls_line  TYPE tline,
        lv_name  TYPE thead-tdname,
        ls_disp  TYPE ty_task_disp,
        ls_color TYPE lvc_s_scol.

  "Characteristic must have long-text indicator
  IF is_base-ltextkz IS INITIAL.
    RETURN.
  ENDIF.

  "Build correct SAP text name
  PERFORM build_char_textname USING is_base CHANGING lv_name.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QM'
      object   = 'QSS'
      name     = lv_name
      language = sy-langu
    TABLES
      lines    = lt_lines
    EXCEPTIONS
      OTHERS   = 1.

  IF lt_lines IS INITIAL.
    RETURN.
  ENDIF.

  LOOP AT lt_lines INTO ls_line.

    CLEAR ls_disp.
    MOVE-CORRESPONDING is_base TO ls_disp.

    ls_disp-row_kind  = 'L'.  " ← VERY IMPORTANT (after MOVE-CORRESPONDING)
    ls_disp-char_ltxt = ls_line-tdline.
    ls_disp-tdformat  = ls_line-tdformat.

    "Clear characteristic data fields (MUST BE DONE)
    CLEAR:
      ls_disp-merknr,
      ls_disp-kurzt_char,
      ls_disp-pmethode,
      ls_disp-stichprver,
      ls_disp-verwmerkm,
      ls_disp-toleranzun,
      ls_disp-toleranzob,
      ls_disp-pruefeinh,
      ls_disp-katalgart1,
      ls_disp-auswmenge1,
      ls_disp-steuerkz,
      ls_disp-ltextkz.

    "Clear CI01–CI28 & CIXX_TXT fields
    DO 28 TIMES.
      ASSIGN COMPONENT |CI{ sy-index WIDTH = 2 PAD = '0' }|     OF STRUCTURE ls_disp TO FIELD-SYMBOL(<c1>).
      ASSIGN COMPONENT |CI{ sy-index WIDTH = 2 PAD = '0' }_TXT| OF STRUCTURE ls_disp TO FIELD-SYMBOL(<c2>).
      IF <c1> IS ASSIGNED. CLEAR <c1>. ENDIF.
      IF <c2> IS ASSIGNED. CLEAR <c2>. ENDIF.
    ENDDO.

    CLEAR ls_disp-op_ltxt.

    "Color row
    CLEAR ls_color.
    ls_color-color-col = 4.
    APPEND ls_color TO ls_disp-line_color.

    APPEND ls_disp TO gt_display.

  ENDLOOP.

ENDFORM.