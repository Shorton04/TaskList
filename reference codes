CLASS lcl_event_handler DEFINITION.
  PUBLIC SECTION.
    CLASS-METHODS on_user_command
      FOR EVENT added_function OF cl_salv_events_table
      IMPORTING e_salv_function.

    CLASS-METHODS on_link_click
      FOR EVENT link_click OF cl_salv_events_table
      IMPORTING row column.
ENDCLASS.


CLASS lcl_event_handler IMPLEMENTATION.
  METHOD on_user_command.

    CASE e_salv_function.

      WHEN gc_func_clist_s.     " &CLISTS
        gv_show_char = gc_true.
        gv_show_ltxt = gc_false.

      WHEN gc_func_clist_h.     " &CLISTH
        gv_show_char = gc_false.
        gv_show_ltxt = gc_false.

      WHEN gc_func_ltxt_s.      " &LTXTS
        gv_show_ltxt = gc_true.

      WHEN gc_func_ltxt_h.      " &LTXTH
        gv_show_ltxt = gc_false.

      WHEN OTHERS.
        RETURN.

    ENDCASE.

    " Rebuild data and refresh ALV / PF-STATUS / title
    PERFORM build_display.
    PERFORM set_pfstatus_from_state.
    PERFORM set_title_from_state.
    PERFORM set_column_visibility_by_state.

    IF lo_alv IS BOUND.
      lo_alv->refresh( ).
    ENDIF.

  ENDMETHOD.

  METHOD on_link_click.

    READ TABLE gt_display ASSIGNING FIELD-SYMBOL(<ls_disp>) INDEX row.
    IF sy-subrc = 0.

      lo_alv->refresh( ).

    ENDIF.

  ENDMETHOD.
ENDCLASS.


FORM display_alv.

  IF gt_display IS INITIAL.
    MESSAGE s398(00) WITH 'No data to display'.
    RETURN.
  ENDIF.

  IF lo_alv IS INITIAL.

    TRY.
        cl_salv_table=>factory(
          IMPORTING r_salv_table = lo_alv
          CHANGING  t_table      = gt_display ).

        lo_columns = lo_alv->get_columns( ).
        lo_columns->set_optimize( abap_true ).

        "Enable row color
        lo_columns->set_color_column( 'LINE_COLOR' ).

      CATCH cx_salv_not_found cx_salv_data_error cx_salv_msg.
        RETURN.
    ENDTRY.

    "=== Layout ===
    lo_layout = lo_alv->get_layout( ).
    DATA(ls_key) = VALUE salv_s_layout_key( report = sy-repid ).
    lo_layout->set_key( ls_key ).
    lo_layout->set_default( abap_true ).
    lo_layout->set_save_restriction( if_salv_c_layout=>restrict_none ).

    "=== Toolbar Functions ===
    lo_funcs = lo_alv->get_functions( ).
    lo_funcs->set_all( abap_true ).

    "=== Standard SALV Row Selector ===
    DATA(lo_sel) = lo_alv->get_selections( ).
    lo_sel->set_selection_mode( if_salv_c_selection_mode=>row_column ).
    " ^^^ THIS SHOWS THE STANDARD SALV LEFT SELECT COLUMN

    "=== Register Events ===
    lo_events = lo_alv->get_event( ).
    SET HANDLER lcl_event_handler=>on_user_command FOR lo_events.
    SET HANDLER lcl_event_handler=>on_link_click   FOR lo_events.

  ELSE.
    lo_alv->refresh( ).
  ENDIF.

  PERFORM set_column_visibility_by_state.
  PERFORM set_pfstatus_from_state.
  PERFORM set_ci_headers.
  PERFORM apply_column_order.

  lo_alv->display( ).

ENDFORM.
