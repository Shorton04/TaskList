FORM build_display.

  DATA: ls_base        TYPE ty_task_base,
        ls_disp        TYPE ty_task_disp,
        lv_last_plnty  TYPE plnty,
        lv_last_plnnr  TYPE plnnr,
        lv_last_plnal  TYPE plnal,
        lv_last_vornr  TYPE plnkn,
        lv_last_merknr TYPE merknr,
        ls_color       TYPE lvc_s_scol.

  CLEAR: gt_display,
         lv_last_plnty,
         lv_last_plnnr,
         lv_last_plnal,
         lv_last_vornr,
         lv_last_merknr.

  SORT gt_base BY plnty plnnr plnal vornr merknr.

  LOOP AT gt_base INTO ls_base.

    " NEW OPERATION GROUP
    IF ls_base-vornr <> lv_last_vornr
    OR ls_base-plnnr <> lv_last_plnnr
    OR ls_base-plnal <> lv_last_plnal
    OR ls_base-plnty <> lv_last_plnty.

      CLEAR ls_disp.
      MOVE-CORRESPONDING ls_base TO ls_disp.
      ls_disp-row_kind = 'O'.

      " Fill CI fields here
      PERFORM fill_ci_fields USING ls_base-steuerkz CHANGING ls_disp.

      APPEND ls_disp TO gt_display.

      lv_last_plnty = ls_base-plnty.
      lv_last_plnnr = ls_base-plnnr.
      lv_last_plnal = ls_base-plnal.
      lv_last_vornr = ls_base-vornr.

      CLEAR lv_last_merknr.
      "Operation long text (if char OFF and longtext ON)
      IF gv_show_char = abap_false AND gv_show_ltxt = abap_true.
        PERFORM append_op_longtext USING ls_base.
      ENDIF.


    ENDIF.

    " CHARACTERISTIC ROW
    IF gv_show_char = abap_true
    AND ls_base-merknr IS NOT INITIAL.

      IF ls_base-merknr <> lv_last_merknr.

        CLEAR ls_disp.
        MOVE-CORRESPONDING ls_base TO ls_disp.
        ls_disp-row_kind = 'C'.

        " fill CI
        PERFORM fill_ci_fields USING ls_base-steuerkz CHANGING ls_disp.

        ls_color-color-col = 6.
        ls_color-color-int = 1.
        APPEND ls_color TO ls_disp-line_color.

        APPEND ls_disp TO gt_display.

        lv_last_merknr = ls_base-merknr.

      ENDIF.
      IF gv_show_ltxt = gc_true.
        PERFORM append_char_longtext USING ls_base.
      ENDIF.

    ENDIF.


  ENDLOOP.

ENDFORM.



FORM get_data.

  DATA: lv_keydat TYPE plko-datuv,
        lv_tolun  TYPE plmk-toleranzun,
        lv_tolob  TYPE plmk-toleranzob.

  CLEAR gt_base.
  CLEAR gs_base.

  lv_keydat = so_keydt.

  " Convert tolerance CHAR16 â†’ FLTP
  CLEAR lv_tolun.
  CLEAR lv_tolob.
  IF so_tolun IS NOT INITIAL.
    lv_tolun = so_tolun.
  ENDIF.
  IF so_tolob IS NOT INITIAL.
    lv_tolob = so_tolob.
  ENDIF.

  "===================================================================*
  "* FDS JOIN WITH ALL FIELDS REQUIRED IN TY_TASK_BASE
  "===================================================================*
  SELECT
    "================ HEADER (PLKO) ==================================
    plko~plnty,
    plko~plnnr,
    plko~plnal,
    plko~datuv,
    plko~valid_to           AS valid_to,
    plko~werks,
    plko~ktext,
    plko~verwe,
    plko~vagrp,
    plko~statu              AS statu_h,
    plko~anlzu              AS anlzu_h,
    plko~strat,
    plko~istru              AS istru_h,
    plko~adpsp,
    plko~slwbez,
    plko~loekz              AS loekz_h,
    plko~andat,
    plko~annam,
    plko~aedat,
    plko~aenam,

    "================ FLOC / EQUIP (TAPL/EAPL) =======================
    tapl~tplnr,
    eapl~equnr,

    crhd_h~arbpl AS arbpl_h,

    "================ OPERATION (PLPO) ===============================
    plpo~plnkn,
    plpo~zaehl,
    plpo~datuv              AS datuv_o,
    plpo~valid_to           AS valid_to_o,
    plpo~vornr,
    plpo~ltxa1,
    plpo~steus,
    crhd~arbpl              AS arbpl_o,
    crhd~werks              AS werks_o,
    plpo~ktsch,
    plpo~arbei,
    plpo~arbeh,
    plpo~dauno,
    plpo~daune,
    plpo~kalid,
    plpo~execution_stage,
    plpo~anlzu              AS anlzu_o,
    plpo~istru              AS istru_o,
    plpo~larnt,
    plpo~ebeln,
    plpo~ebelp,
    plpo~lifnr,
    plpo~preis,
    plpo~waers,
    plpo~sakto,
    plpo~ekorg,
    plpo~ekgrp,
    plpo~txtsp              AS txtsp_op,
    plpo~loekz              AS loekz_o,

    "================ CHARACTERISTIC (PLMK) ==========================
    plmk~merknr,
    plmk~verwmerkm,
    plmk~kurztext           AS kurzt_char,
    plmk~ltextkz,
    plmk~toleranzun,
    plmk~toleranzob,
    plmk~pruefeinh,
    plmk~stichprver,
    plmk~pmethode,
    plmk~katalgart1,
    plmk~auswmenge1,
    plmk~steuerkz,
    plmk~loekz              AS loekz_c,
    plmk~gueltigab          AS gueltigab,
    plmk~valid_to_on_db     AS valid_to_c

    FROM  plko
      INNER JOIN plas
        ON plas~plnty = plko~plnty
       AND plas~plnnr = plko~plnnr
       AND plas~plnal = plko~plnal
       AND plas~loekz = ' '
       AND plas~datuv <= @lv_keydat
       AND plas~valid_to >= @lv_keydat

      INNER JOIN plpo
        ON plpo~plnty = plas~plnty
       AND plpo~plnnr = plas~plnnr
       AND plpo~plnkn = plas~plnkn
       AND plpo~zaehl = plas~zaehl
       AND plpo~loekz = ' '

      LEFT JOIN plmk
        ON plmk~plnty = plpo~plnty
       AND plmk~plnnr = plpo~plnnr
       AND plmk~plnkn = plpo~plnkn
       "AND plmk~zaehl = plpo~zaehl
       AND plmk~loekz = ' '

      LEFT JOIN tapl
        ON tapl~plnty = plko~plnty
       AND tapl~plnnr = plko~plnnr
       AND tapl~plnal = plko~plnal
       AND tapl~loekz = ' '

      LEFT JOIN eapl
        ON eapl~plnty = plko~plnty
       AND eapl~plnnr = plko~plnnr
       AND eapl~plnal = plko~plnal
       AND eapl~loekz = ' '

      LEFT JOIN crhd
        ON crhd~objid = plpo~arbid

      LEFT JOIN crhd AS crhd_h
      ON crhd_h~objid = plko~arbid
      AND crhd_h~objty = plko~arbty

    WHERE plko~loekz = ' '
      AND plko~datuv <= @lv_keydat
      AND plko~valid_to >= @lv_keydat
      AND plpo~datuv <= @lv_keydat
      AND plpo~valid_to >= @lv_keydat
      AND ( plmk~gueltigab IS INITIAL OR plmk~gueltigab <= @lv_keydat )
      AND ( plmk~valid_to_on_db IS INITIAL OR plmk~valid_to_on_db >= @lv_keydat )
          INTO CORRESPONDING FIELDS OF TABLE @gt_base.


  SORT gt_base BY plnty plnnr plnal vornr merknr.
  DELETE ADJACENT DUPLICATES FROM gt_base COMPARING plnty plnnr plnal vornr merknr.
