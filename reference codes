REPORT ztest_vt.

PARAMETERS: p_plnty TYPE plnty,
            p_plnnr TYPE plnnr.

DATA: lt_plmk  TYPE TABLE OF plmk,
      ls_plmk  TYPE plmk,
      lt_text  TYPE STANDARD TABLE OF tline,
      ls_line  TYPE tline,
      lv_tdname TYPE thead-tdname.

"--- SELECT CHARACTERISTICS FOR THIS TASK LIST -----------------------
SELECT *
  FROM plmk
  INTO TABLE @lt_plmk
 WHERE plnty = @p_plnty
   AND plnnr = @p_plnnr
   AND loekz = ''.

IF lt_plmk IS INITIAL.
  WRITE: / '❌ No PLMK entries found for this task list.'.
  RETURN.
ENDIF.

"--- LOOP THROUGH EACH CHAR AND TRY TO READ LONG TEXT ----------------
LOOP AT lt_plmk INTO ls_plmk.

  WRITE: / '============================================'.
  WRITE: / 'MERKNR: ', ls_plmk-merknr,
          '  ZAEHL: ', ls_plmk-zaehl,
          '  PLNKN: ', ls_plmk-plnkn.

  "Build TDNAME: MANDT + PLNTY + PLNNR + PLNKN + MERKNR + ZAEHL
  CONCATENATE ls_plmk-mandt
              ls_plmk-plnty
              ls_plmk-plnnr
              ls_plmk-plnkn
              ls_plmk-merknr
              ls_plmk-zaehl
         INTO lv_tdname.
  CONDENSE lv_tdname NO-GAPS.

  WRITE: / 'TDNAME = ', lv_tdname.

  CLEAR lt_text.

  CALL FUNCTION 'READ_TEXT'
    EXPORTING
      id       = 'QM'
      name     = lv_tdname
      language = 'E'
      object   = 'QSS'
    TABLES
      lines    = lt_text
    EXCEPTIONS
      OTHERS   = 4.

  IF sy-subrc <> 0 OR lt_text IS INITIAL.
    WRITE: / '⚠ No long text found for this characteristic.'.
  ELSE.
    WRITE: / '✔ Long text found:'.
    LOOP AT lt_text INTO ls_line.
      WRITE: / ls_line-tdline.
    ENDLOOP.
  ENDIF.

ENDLOOP.